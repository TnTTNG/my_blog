{"meta":{"version":1,"warehouse":"5.0.1"},"models":{"Asset":[{"_id":"themes/butterfly/source/css/index.styl","path":"css/index.styl","modified":0,"renderable":1},{"_id":"themes/butterfly/source/css/var.styl","path":"css/var.styl","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/404.jpg","path":"img/404.jpg","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/brain.jpg","path":"img/brain.jpg","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/butterfly-icon.png","path":"img/butterfly-icon.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/error-page.png","path":"img/error-page.png","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/favicon.ico","path":"img/favicon.ico","modified":0,"renderable":1},{"_id":"themes/butterfly/source/img/friend_404.gif","path":"img/friend_404.gif","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/main.js","path":"js/main.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/tw_cn.js","path":"js/tw_cn.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/search/algolia.js","path":"js/search/algolia.js","modified":0,"renderable":1},{"_id":"themes/butterfly/source/js/search/local-search.js","path":"js/search/local-search.js","modified":0,"renderable":1}],"Cache":[{"_id":"source/_posts/Nginx","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1770217240392},{"_id":"source/_posts/Nginx 快速入门.md","hash":"3bd6e37a9e3c54a83c1c1c302ff9ec68ba8cf08a","modified":1770218635704},{"_id":"source/_posts/hello-world.md","hash":"7d98d6592de80fdcd2949bd7401cec12afd98cdf","modified":1769712904096},{"_id":"source/_posts/基于 Docker + Prometheus + Grafana 的全栈监控平台.md","hash":"0f3e1f90184431840c501adf705bf61237d1bd66","modified":1769862773162},{"_id":"source/_posts/我的第一篇博客.md","hash":"d2a091571cbad15fdbbe949747ba520c59faa120","modified":1769861707692},{"_id":"themes/butterfly/.gitignore","hash":"a1373164627c9a3e36c8eec1ad71b4b269800682","modified":1769714087021},{"_id":"themes/butterfly/README_CN.md","hash":"5595df16d0b28133a232cb5f45bbcf60798073e9","modified":1769714087022},{"_id":"themes/butterfly/LICENSE","hash":"c8bc7df08db9dd3b39c2c2259a163a36cf2f6808","modified":1769714087021},{"_id":"themes/butterfly/README.md","hash":"d67b31fceac787d415a441f7eafc1832e8be7869","modified":1769714087022},{"_id":"themes/butterfly/package.json","hash":"c3b121a6403087e30b6ed530aa6abb6cd1465315","modified":1769714087028},{"_id":"themes/butterfly/plugins.yml","hash":"9827d948ad26bc13a90862c18090ed2d20761d5a","modified":1769714087028},{"_id":"themes/butterfly/.github/FUNDING.yml","hash":"bcc350ceddc464e64439af66d99a1c3bc7676130","modified":1769714087021},{"_id":"themes/butterfly/languages/default.yml","hash":"97e89708bea9740e7e156b53304d7f4697f6332d","modified":1769714087022},{"_id":"themes/butterfly/languages/en.yml","hash":"6d2a5795862abc121a164e8519e7587bb57af7c7","modified":1769714087022},{"_id":"themes/butterfly/languages/ja.yml","hash":"d97b97ebb8a1c8754373b450d4e81341b5dcd208","modified":1769714087022},{"_id":"themes/butterfly/languages/ko.yml","hash":"4a959730509b211484b20d9fcabc80a9c7e8cc1f","modified":1769714087022},{"_id":"themes/butterfly/_config.yml","hash":"03337c7bddc3f86b65dc96f93ee63546c9b4834d","modified":1769727552524},{"_id":"themes/butterfly/languages/zh-CN.yml","hash":"25e717994a3eab37ccb9cf3ae5fec5647b525ced","modified":1769714087022},{"_id":"themes/butterfly/languages/zh-HK.yml","hash":"e2958e5b72fd2cb33b6706bc1588de6b8d9dde8f","modified":1769714087022},{"_id":"themes/butterfly/languages/zh-TW.yml","hash":"af38319aa58cab193f90ef8caecdb9a26cdd165a","modified":1769714087022},{"_id":"themes/butterfly/layout/archive.pug","hash":"bc77220dfc269b8faad0930e1a4142ebf68165e5","modified":1769714087022},{"_id":"themes/butterfly/layout/index.pug","hash":"a93004cc8ec8050df603d32a6e6e02cd96fd9875","modified":1769714087028},{"_id":"themes/butterfly/layout/category.pug","hash":"a7e9805a781e34e38d27462e6ce2a5821c34bb9f","modified":1769714087022},{"_id":"themes/butterfly/layout/page.pug","hash":"7ce2a49c6c41847de4ccea377ade116339984434","modified":1769714087028},{"_id":"themes/butterfly/layout/post.pug","hash":"65c4a49c65c3fc4d9dc88b9791a75710c698c3a1","modified":1769714087028},{"_id":"themes/butterfly/layout/tag.pug","hash":"ca5333bd262cb58c195c844b593a0eed0c721766","modified":1769714087028},{"_id":"themes/butterfly/.github/ISSUE_TEMPLATE/config.yml","hash":"63ad2249ad09fb3fe21bd5ff9adefb304a7ab24a","modified":1769714087021},{"_id":"themes/butterfly/.github/ISSUE_TEMPLATE/bug_report.yml","hash":"10ce05c8dbde09f53bdabe40b5388de9ccc71a31","modified":1769714087021},{"_id":"themes/butterfly/.github/ISSUE_TEMPLATE/feature_request.yml","hash":"6e0f9470b18bd37d4891282ac73d61676b040e8c","modified":1769714087021},{"_id":"themes/butterfly/.github/workflows/publish.yml","hash":"e320b40c051bae1549156cd5ea4a51383cf78598","modified":1769714087021},{"_id":"themes/butterfly/.github/workflows/stale.yml","hash":"4040c76547e270aaf184e9b219a44ca41bbb1b9f","modified":1769714087021},{"_id":"themes/butterfly/layout/includes/additional-js.pug","hash":"874bd7496c606edcdc8a6150baff00299dfb9139","modified":1769714087022},{"_id":"themes/butterfly/layout/includes/head.pug","hash":"1d11e334b22dbbedcb0f751f9ee9789d4416605e","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/footer.pug","hash":"da95d64f44e1e6b516d1f96f57b4b0a537c29c19","modified":1769714087022},{"_id":"themes/butterfly/layout/includes/layout.pug","hash":"b04541e080f4485c94cad8ff477a0b140b02ddb9","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/pagination.pug","hash":"908163a8a5e6d0d9e175a2feeecda7bde58ef05a","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/rightside.pug","hash":"3617840416f26078117f760579fb544dce07e1bc","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/sidebar.pug","hash":"3e65b7bf6bccccbba7e15349f0a44f15c64c5b5e","modified":1769714087024},{"_id":"themes/butterfly/scripts/common/postDesc.js","hash":"ba98361b9d469076bfb045e5ff42eaf764a38fb1","modified":1769714087028},{"_id":"themes/butterfly/scripts/events/404.js","hash":"039fc75f363d79669b0b2177d929cdff6f2ef7a4","modified":1769714087028},{"_id":"themes/butterfly/scripts/common/default_config.js","hash":"c8fa9f1a23cc404d102870e4885d9d4ba6621f59","modified":1769714087028},{"_id":"themes/butterfly/scripts/events/cdn.js","hash":"9fbab1a8c8709fc8d330bae9ba4b17a5ca5d783a","modified":1769714087028},{"_id":"themes/butterfly/scripts/events/init.js","hash":"e9eb5075c558862c4f8fbf25e2fd4ca31175fe8c","modified":1769714087028},{"_id":"themes/butterfly/scripts/events/stylus.js","hash":"bac639c404588ea62e601ef0bcd368c3bd0119af","modified":1769714087028},{"_id":"themes/butterfly/scripts/events/welcome.js","hash":"f59e10305fef59ea3e62a7395106c0927582879d","modified":1769714087029},{"_id":"themes/butterfly/scripts/filters/post_lazyload.js","hash":"f96ccb349501dd2a268f1b64861600e3dc15e4e8","modified":1769714087029},{"_id":"themes/butterfly/scripts/filters/random_cover.js","hash":"e3280c8f8ba5a8ce2235b78c7f70dbf3bc622979","modified":1769714087029},{"_id":"themes/butterfly/scripts/helpers/aside_archives.js","hash":"37b5c46198a2d8fbc60af857a7aa6f0929529922","modified":1769714087029},{"_id":"themes/butterfly/scripts/helpers/getArchiveLength.js","hash":"263b008efe595d841cbf488f6d59f509b7042e30","modified":1769714087029},{"_id":"themes/butterfly/scripts/helpers/series.js","hash":"45367c4ce827329867dbcc750ec125da9ccb2cfd","modified":1769714087029},{"_id":"themes/butterfly/scripts/helpers/aside_categories.js","hash":"a7e3776b7177c168fa5880397e9611fd3d23a995","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/button.js","hash":"2f44e1b3ccd170b256eae178299d6fa933a8d490","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/chartjs.js","hash":"195ba802d7e8406c155124a9c939a2318f82938b","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/flink.js","hash":"25eefe10189caf3910a0e5d5b2f2043ae9255531","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/inlineImg.js","hash":"89c6c78d2db43b190055d5690741a79bab4f3e7e","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/label.js","hash":"cf0bc17d0180231167cc6aa8a00fc64f198cb9f9","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/gallery.js","hash":"fa3d0a64f7fce4aff7928d4ddd95548978ba001c","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/hide.js","hash":"1ebe936e202c1baee8f6b7862a431e43db807229","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/mermaid.js","hash":"795b83d4664101a762222c80f01def86331b102e","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/note.js","hash":"e68d8d21f3a86e3646907a3685550ee20e8d4a9f","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/score.js","hash":"f2f8a789967cda9559778b1936233dfb46a1f3a3","modified":1769714087029},{"_id":"themes/butterfly/scripts/tag/timeline.js","hash":"176804f07567aa80f1ed95897a968a996b155dec","modified":1769714087030},{"_id":"themes/butterfly/scripts/tag/tabs.js","hash":"3c486b149e28edd1a06843f05a5c355000991b82","modified":1769714087030},{"_id":"themes/butterfly/scripts/tag/series.js","hash":"40bc9a065e3a1423e0e66f4911e00713ca9f5e9e","modified":1769714087030},{"_id":"themes/butterfly/source/css/index.styl","hash":"b13d96924a5534bff91d75566b196ac87b4fac22","modified":1769714087032},{"_id":"themes/butterfly/source/css/var.styl","hash":"41e5eb8c62fdf6ba12c98d026d6f26f08a4380e2","modified":1769714087032},{"_id":"themes/butterfly/scripts/helpers/page.js","hash":"6955e2a64cfa6315f68165b3fb3e8a5aa44ab057","modified":1769714087029},{"_id":"themes/butterfly/source/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1769714087032},{"_id":"themes/butterfly/source/img/brain.jpg","hash":"d8b968853d67ca7bd82b8326a1025e294e7feafe","modified":1769726035726},{"_id":"themes/butterfly/source/img/favicon.ico","hash":"455ac256580bf31a45813dbbdb87219bfc8bfb04","modified":1769714087034},{"_id":"themes/butterfly/source/img/error-page.png","hash":"d2519710498a871ca3e913c57e2ba20a805b6430","modified":1769714087034},{"_id":"themes/butterfly/source/js/main.js","hash":"4fb88103d8d76e53033d2fac13ea49549699f669","modified":1769714087035},{"_id":"themes/butterfly/source/js/tw_cn.js","hash":"0561cc5c3d252d9b9b0d04a553028e9450965b6b","modified":1769714087035},{"_id":"themes/butterfly/layout/includes/head/Open_Graph.pug","hash":"e93a36d3c29b5a02c7f26a23f96e1f84b063cbe8","modified":1769714087023},{"_id":"themes/butterfly/source/js/utils.js","hash":"257260811cda85073bb5fd9f9ab25d29be9e4aff","modified":1769714087035},{"_id":"themes/butterfly/source/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1769714087035},{"_id":"themes/butterfly/layout/includes/head/analytics.pug","hash":"c2156c77a011b20fafd34f03ca073397c21b099f","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/head/config_site.pug","hash":"56a3c32de1a15627ff38c67f1131cdd6ec5ac924","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/head/config.pug","hash":"e20c41be7bdc07fdaef7952a2eb953eebd006ceb","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/head/site_verification.pug","hash":"5168caadc4cf541f5d6676a9c5e8ae47a948f9ad","modified":1769714087023},{"_id":"themes/butterfly/scripts/helpers/inject_head_js.js","hash":"f94370706fe2c8b0597a81afe2f3e9c29e919d83","modified":1769714087029},{"_id":"themes/butterfly/layout/includes/head/google_adsense.pug","hash":"f29123e603cbbcc6ce277d4e8f600ba67498077c","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/head/pwa.pug","hash":"83ed05ef1e39f2ee70c3fba2cf96e488d8ffec66","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/head/preconnect.pug","hash":"1e1a69aa2cbda2e621c741b3802093244b3cc04e","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/head/structured_data.pug","hash":"49db40e9d3edcf6323e6fe7c074ab09e41453c82","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/header/menu_item.pug","hash":"733184f88e3a586a5fcc9d193ad500556b6c8eed","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/header/nav.pug","hash":"f478a82ba4c15d4f6a5db38eca5c61f7054fa71d","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/header/index.pug","hash":"44331c9db74b281b5c5c41439d3407a9076df1a1","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/header/social.pug","hash":"e2d31e0f450ad42c47f7ee96375799342bf2f19b","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/loading/fullpage-loading.pug","hash":"d4d266eced4b9167bed86bcc5addc327f78cbdcc","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/loading/pace.pug","hash":"9d2d539555bab495959b9df734ed5c43a9f9e5a9","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/loading/index.pug","hash":"d76ce71ba106e350670c021a3dcae57547d01830","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/mixins/article-sort.pug","hash":"ef7afe0df7a3746744ac8185da7163b7406120ca","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/header/post-info.pug","hash":"7d799c4694adb6e265e3f4b975d7f7f6a7021a17","modified":1769714087023},{"_id":"themes/butterfly/layout/includes/page/404.pug","hash":"15d32c511e4875066fcbe9cb84c3ada07b5a7c41","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/page/categories.pug","hash":"5276a8d2835e05bd535fedc9f593a0ce8c3e8437","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/mixins/indexPostUI.pug","hash":"abc76a3a57ec063cb0ef3330452b76c2fbb59de3","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/page/default-page.pug","hash":"efb40388e37cca0b5e7c3c66e811a42f8d32c910","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/page/tags.pug","hash":"af99f4f29bbccfa9d640766b6eb9ecf776374097","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/page/flink.pug","hash":"6b0fa5f048aca8e9cbe56978301af918cf7ac34a","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/post/outdate-notice.pug","hash":"b7ce9484bc5c97ea6154f0b78fb9b8951fafedbd","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/post/post-copyright.pug","hash":"b96c232e5178d927987791d9ae386dd83679535a","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/page/shuoshuo.pug","hash":"2cc8f09b56ade6c581398d977fe38c1ecd9ed024","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/third-party/aplayer.pug","hash":"ed79fef5b5025415ea12eaed970f3fe7f6ef9596","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/post/reward.pug","hash":"db92f25ff3fd061882f81bf74ca560ff66983a0c","modified":1769714087024},{"_id":"themes/butterfly/layout/includes/third-party/pjax.pug","hash":"7cf5ea1dc9a7ebbd945ab6d16e829be345a1392b","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/effect.pug","hash":"43014bfc63583d3ee8808d526dd165848c0ed52f","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/prismjs.pug","hash":"e5eed62d90a4bc075d0b88bc756d20d5ff41f54f","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/widget/card_ad.pug","hash":"a8312b527493dabbadbb1280760168d3bc909a3b","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/widget/card_announcement.pug","hash":"21e019bdc3b1e796bb00976bb29af2d51f873624","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/subtitle.pug","hash":"236c3ce26dd76e80b04d457789475c42da5ac0c8","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/umami_analytics.pug","hash":"c6b9c2d04ae2d87a985cd1f9c1164749a543b714","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/widget/card_archives.pug","hash":"73d33b6930e7944187a4b3403daf25d27077a2dd","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_author.pug","hash":"1aba8aa7cd767dc96879d13a13b4c8ceb9023233","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_bottom_self.pug","hash":"1dba77d250eeebfb6e293d504352c7e9ea31980b","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_categories.pug","hash":"66e383b4ef374951eb87dd1bf4cdb7a667193fb5","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_newest_comment.pug","hash":"d8753772889b5d0f4d15639ed6af5e91e53b1d03","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_post_toc.pug","hash":"1dd19a564320d248dbcee7f118a5b96c6466da65","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_recent_post.pug","hash":"bb842d2aa6469d65bf06af1372f0a19a9e4ef44c","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_post_series.pug","hash":"e0bb72fa0ce15964b11b8fe421cae3432394e35f","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_top_self.pug","hash":"7b5ae404a1205546b7de4be42291315cf918f2b3","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_tags.pug","hash":"5e9466ad66fc96959c3de75d97ee92134aab5945","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/card_webinfo.pug","hash":"fcddd80cdeb6aa81f342cd9f0102302f6ba087a8","modified":1769714087028},{"_id":"themes/butterfly/layout/includes/widget/index.pug","hash":"45f620cd87b9ef2aa9d1e024e697ed6b4eecff34","modified":1769714087028},{"_id":"themes/butterfly/source/css/_global/function.styl","hash":"3aaee8878917abb3f438605ee74e2338216e8f88","modified":1769714087030},{"_id":"themes/butterfly/source/css/_highlight/theme.styl","hash":"a51edfd3e499e7d38c32241c40e8e4d371efca73","modified":1769714087030},{"_id":"themes/butterfly/source/css/_highlight/highlight.styl","hash":"54ef7d3927f96e2b5922d92e98f86e27562d0b63","modified":1769714087030},{"_id":"themes/butterfly/source/css/_layout/chat.styl","hash":"4cc02bcbaa4a1933a82a9ea57a603fe2d059fc77","modified":1769714087030},{"_id":"themes/butterfly/source/css/_layout/aside.styl","hash":"1cb1c5fcdefc55aab674d7d84d057151f8f76577","modified":1769714087030},{"_id":"themes/butterfly/source/css/_layout/comments.styl","hash":"fbfce4d67cacd1df22fb73d89d008693f59d9d91","modified":1769714087030},{"_id":"themes/butterfly/source/css/_global/index.styl","hash":"9426ab6c6fe84a76582dcb4e7762385c7c0a47f4","modified":1769714087030},{"_id":"themes/butterfly/source/css/_layout/footer.styl","hash":"5692bcf8929f7ef12b10d860da6cb90ca55752c0","modified":1769714087030},{"_id":"themes/butterfly/source/css/_layout/head.styl","hash":"f30720e897322ce818f3def0a3f91eef23478923","modified":1769714087031},{"_id":"themes/butterfly/source/css/_layout/loading.styl","hash":"f0b01bbf321c2c24fdccaee367dd9fd448031a72","modified":1769714087031},{"_id":"themes/butterfly/source/css/_layout/post.styl","hash":"543eaf9c7df7e0db841e5946ee5f9082c3c46290","modified":1769714087031},{"_id":"themes/butterfly/source/css/_layout/pagination.styl","hash":"7d7554573c005399bc8c2264a85896d2d51be1e1","modified":1769714087031},{"_id":"themes/butterfly/source/css/_layout/relatedposts.styl","hash":"ef8e8549fe7ad4b99793844a93b4a89f77f417d5","modified":1769714087031},{"_id":"themes/butterfly/source/css/_layout/reward.styl","hash":"37944e0c390cd6f63055fdeeb68f337514d87349","modified":1769714087031},{"_id":"themes/butterfly/source/css/_layout/rightside.styl","hash":"d4e8a938ef2a1f4bf895d187e4fa529c7476e238","modified":1769714087031},{"_id":"themes/butterfly/source/css/_layout/sidebar.styl","hash":"e22bc88ab369c362905b29514d585b1d6bbfc5f3","modified":1769714087031},{"_id":"themes/butterfly/source/css/_layout/third-party.styl","hash":"d148c8c9d9b2e4897cbb74338a1068cdb1c1b64b","modified":1769714087031},{"_id":"themes/butterfly/source/css/_page/404.styl","hash":"205ccc7d0ec6ce1193b46bc0c9ce0385594581fb","modified":1769714087031},{"_id":"themes/butterfly/source/css/_page/archives.styl","hash":"5abe5480d83ff8b452a780a484d50a44091475bf","modified":1769714087031},{"_id":"themes/butterfly/source/css/_page/categories.styl","hash":"c4cda7b0c99015df29ce00fdfddd2f7679653754","modified":1769714087031},{"_id":"themes/butterfly/source/css/_page/common.styl","hash":"1a1766f8ea6a6576ec6129887e55221f540b9358","modified":1769714087031},{"_id":"themes/butterfly/source/css/_page/flink.styl","hash":"1f8d715faf3b91b53426e38195c0920afb3bfa1c","modified":1769714087031},{"_id":"themes/butterfly/source/css/_page/homepage.styl","hash":"fc26e980fedde31644ebf878967f66ef9ba32be2","modified":1769714087031},{"_id":"themes/butterfly/source/css/_page/shuoshuo.styl","hash":"a764c44ce1f17f966b2f439762f038570af00b1b","modified":1769714087031},{"_id":"themes/butterfly/source/css/_page/tags.styl","hash":"4681a9d93a20b8de9f58cdbc794702f76f35192b","modified":1769714087031},{"_id":"themes/butterfly/source/css/_search/algolia.styl","hash":"f6d0cfb510a0e351ec20b043d3d3784d0f6c96a4","modified":1769714087031},{"_id":"themes/butterfly/source/css/_search/local-search.styl","hash":"d33d4af89231f4b0f1300bf2e9725344b4fab969","modified":1769714087031},{"_id":"themes/butterfly/source/css/_search/index.styl","hash":"5a8a181324a2f6b7d8240ea871971444403fa554","modified":1769714087031},{"_id":"themes/butterfly/source/css/_tags/button.styl","hash":"f3fd3c43f16606a7b956fcb94b0d975b2d705fff","modified":1769714087032},{"_id":"themes/butterfly/source/css/_tags/gallery.styl","hash":"30d1f809efd252ed0233d96d4374efd2b01d2292","modified":1769714087032},{"_id":"themes/butterfly/source/css/_tags/hexo.styl","hash":"985b183db7b7bfd8f9bdb60494549fb7f850348b","modified":1769714087032},{"_id":"themes/butterfly/source/css/_tags/hide.styl","hash":"fe348f881d7f8b6022015e25fa0050bd6613c779","modified":1769714087032},{"_id":"themes/butterfly/source/css/_tags/inlineImg.styl","hash":"3be8d0a75e7cc96548667cae0cb6a474279bd0b5","modified":1769714087032},{"_id":"themes/butterfly/source/css/_tags/label.styl","hash":"e84f1de06b818557cc4c45f9958121952ae268b8","modified":1769714087032},{"_id":"themes/butterfly/source/css/_tags/note.styl","hash":"db2e94a2dd24a2777c9a74b35f98c11d71488003","modified":1769714087032},{"_id":"themes/butterfly/source/css/_tags/series.styl","hash":"0657169849bc4bf4d93b5492ade040c8f58c1901","modified":1769714087032},{"_id":"themes/butterfly/source/css/_tags/timeline.styl","hash":"e846ddaef494d46cdfa2379deacfe74fa1cc5264","modified":1769714087032},{"_id":"themes/butterfly/source/css/_tags/tabs.styl","hash":"3a88eedcb694da79e92581ce50cb1a430b1fb615","modified":1769714087032},{"_id":"themes/butterfly/source/css/_mode/darkmode.styl","hash":"3f96290299c33e7b60c01b2c8b2a5a92be83e12b","modified":1769714087031},{"_id":"themes/butterfly/source/css/_mode/readmode.styl","hash":"0039d67b27ee98a3340e44539e89dee9e231062e","modified":1769714087031},{"_id":"themes/butterfly/source/css/_third-party/normalize.min.css","hash":"8549829fb7d3c21cd9e119884962e8c463a4a267","modified":1769714087032},{"_id":"themes/butterfly/source/js/search/algolia.js","hash":"13f37791badfb942f639cc25092ee32d43de31bf","modified":1769714087035},{"_id":"themes/butterfly/source/js/search/local-search.js","hash":"4adfe4087d8350a1188135a32a3bf76c6b305787","modified":1769714087035},{"_id":"themes/butterfly/layout/includes/third-party/abcjs/abcjs.pug","hash":"c4113038f4d084c7a0ed6d76e7257af717dea605","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/abcjs/index.pug","hash":"f0a90d8e39915a74b16ef22e851f179415cd7eaa","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/card-post-count/artalk.pug","hash":"b03ee8625149191f9d5d057bbc9824b68d8dd0c4","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/card-post-count/disqus.pug","hash":"d6fff5a7f84c8b09f282f9ddc0020a68a8aac9ea","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/card-post-count/fb.pug","hash":"cbfbcf34a24d21ba2b21cf9eedb76f4c3c563c5a","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/card-post-count/index.pug","hash":"846cabae287ae31b3bbfac3da022475713dd5ecc","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/card-post-count/remark42.pug","hash":"716dc463fe4ef5112e7018ed60804125fdfa5cad","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/card-post-count/twikoo.pug","hash":"be45b522286bbc64724341f23a5056ad24d3f796","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/card-post-count/valine.pug","hash":"7884883ec15792f7e54daacb3c62b851dde2b66a","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/chat/chatra.pug","hash":"5b29badecbbe828112c001156023fc0566045cf6","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/card-post-count/waline.pug","hash":"fd2320ee25507bb8ef49f932c2d170586b44ea4d","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/chat/crisp.pug","hash":"24d094fd917947c0ca7492fa094328b1a183b873","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/chat/index.pug","hash":"e8438941085def0591a72fc9b0d705dbf107f54f","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/chat/tidio.pug","hash":"62466b251052cae609b6369d4cb4b6a85320757d","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/comments/artalk.pug","hash":"9801f581cd1d2aaa3eed8739487b9b3ec395c354","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/comments/disqus.pug","hash":"f2ea5249b3e6670f6c8c77868f4f42c502e43830","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/comments/disqusjs.pug","hash":"c81fa7d8a5cb96d1ae07bfa8c46b84a58161add1","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/comments/facebook_comments.pug","hash":"8af585e6d6f73ee57114eefad574dc6e8ea9f570","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/comments/giscus.pug","hash":"592b2251db6c1abeb8b0eebe3b2e6d9aa0dec445","modified":1769714087025},{"_id":"themes/butterfly/layout/includes/third-party/comments/gitalk.pug","hash":"58914c58a190e3bc0aa37cb581e77e442b563501","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/comments/index.pug","hash":"332b532bafbaf369fde840883b77e5a23d050a39","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/comments/js.pug","hash":"3abbaaa4ea575c45b3cebffd40bad1acc6ffce84","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/comments/livere.pug","hash":"9d84a681289175dec75a85f301d2fc9ce1b2bb7a","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/comments/remark42.pug","hash":"ea9766439b6b1936306916a8b08d2681afbc8ea9","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/comments/twikoo.pug","hash":"53d99831f29aeb2e336ed1407d79590041f77002","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/comments/utterances.pug","hash":"30a7d157890de69deab28baa47fb7bb28b040efd","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/comments/valine.pug","hash":"24f18b0c67803210d53abbf9c1d454c000b06eee","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/comments/waline.pug","hash":"e2bf15357485cd502414b3b20f5b1f762a2fd014","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/math/chartjs.pug","hash":"732eb1118ea1a73aa5c164d639097c614f8e9953","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/math/index.pug","hash":"af66d13204030d47537b9e31a6173e63589ce7ff","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/math/katex.pug","hash":"b83db9fa64d42a0bfd97efb660e09be3f166a144","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/math/mathjax.pug","hash":"cb5c8b0f2ac19a732ab78e26020dd5c8c70c0642","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/math/mermaid.pug","hash":"4859cfb07d3402d40d3597d324de6cf85613bca7","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/artalk.pug","hash":"187302dbc916852ff2fdf47061e272c061611dda","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/common.pug","hash":"27fa75affebc6e84a487c62bceff783bde595256","modified":1769714087026},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/disqus-comment.pug","hash":"fa4b4194749d05f7249f365f2b89c0281057ce54","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/github-issues.pug","hash":"72e2970b23570e308f8af5d8ba8e5e3321d01bbf","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/index.pug","hash":"a7c07dbc1e970a5b247091458e1ee9b144a3366d","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/remark42.pug","hash":"34edfebf0cace0852806be774910ccb0e0914650","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/twikoo-comment.pug","hash":"d2e12a9fc302a4efe52c90d44896fbd73e193a1f","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/valine.pug","hash":"d376ec17fb19fcdcf0d2ad71330190146d3af879","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/newest-comments/waline.pug","hash":"ec6c685080634ac46ffbea1b8f10313388888f43","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/search/algolia.pug","hash":"c34c1b19b3cfe24ca11c5edfb34613507a9a00c7","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/search/docsearch.pug","hash":"013756ff3363344987cc00fc9bd833baf193c341","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/search/index.pug","hash":"f8557548d2ad8dd149c562193991c6c6cda02415","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/search/local-search.pug","hash":"70364f4a9d9f13d713533a0fe0a9798707f1c1b3","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/share/addtoany.pug","hash":"f5ee1c9c8ffa4bca972d30f4de69268b8d47f052","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/share/index.pug","hash":"e51e896ccb13900de38dc81cf44dc789e2418a12","modified":1769714087027},{"_id":"themes/butterfly/layout/includes/third-party/share/share-js.pug","hash":"efef352c1d122409575386bf3894dce8e87032e2","modified":1769714087027},{"_id":"themes/butterfly/source/css/_highlight/highlight/diff.styl","hash":"a91dc5ddbf7b453daef7144bdbf89e6039234077","modified":1769714087030},{"_id":"themes/butterfly/source/css/_highlight/highlight/index.styl","hash":"ef52ebf1e8e751a412f9456fdaeee7d88afd9a72","modified":1769714087030},{"_id":"themes/butterfly/source/css/_highlight/prismjs/diff.styl","hash":"077ec530831be1d80e93da380406b9f5abd0918a","modified":1769714087030},{"_id":"themes/butterfly/source/css/_highlight/prismjs/line-number.styl","hash":"de4bb5fc2dfca368b35e4c1109c92f7abc9e2245","modified":1769714087030},{"_id":"themes/butterfly/source/css/_highlight/prismjs/index.styl","hash":"3676e5c2519cffcaf93a12ffef4c4878ffbc39d4","modified":1769714087030},{"_id":"themes/butterfly/scripts/helpers/related_post.js","hash":"44ee8bc90a2e961837d4fcf280366910e88d8c52","modified":1769714087029},{"_id":"themes/butterfly/source/img/butterfly-icon.png","hash":"f5dd732fed5c3bcd4aa76bac3441bac8485fb432","modified":1769714087034},{"_id":"public/2026/01/29/hello-world/index.html","hash":"429521df628c8b763ec303a1edf00c63b630c6a7","modified":1770217795309},{"_id":"public/2026/01/31/我的第一篇博客/index.html","hash":"9c59bc8b9daddee6738823a104893b593a4aa6fb","modified":1770217795309},{"_id":"public/2026/01/31/基于 Docker + Prometheus + Grafana 的全栈监控平台/index.html","hash":"435144858090bb91dbb3e5b8e1a9278259ebe052","modified":1770217795309},{"_id":"public/2026/02/04/Nginx 快速入门/index.html","hash":"9659d9ac7dfe3223edaa9570ba8515d9bd1171ab","modified":1770218639680},{"_id":"public/archives/index.html","hash":"b20c186722f87df3241514e69133e06297b83446","modified":1770218639680},{"_id":"public/archives/2026/index.html","hash":"6d715f73ce02cfc4ac8772892f87e61dcdf92b94","modified":1770218639680},{"_id":"public/archives/2026/01/index.html","hash":"8102ba1c0a624dde9dc9936ae815b7d519857a56","modified":1770218639680},{"_id":"public/archives/2026/02/index.html","hash":"6fcec209f25f7df78d6e292e5d51965e4d81ff3b","modified":1770218639680},{"_id":"public/categories/系统搭建/index.html","hash":"3f0a2124c27e39c6ac349bd973058a6063dc6f15","modified":1770218639680},{"_id":"public/index.html","hash":"590e0ae909b11c674ea87c325157ecd0494f5de8","modified":1770218639680},{"_id":"public/tags/Nginx/index.html","hash":"43bb4785655146da4d72efea2125bff5582737a1","modified":1770218639680},{"_id":"public/tags/Web服务器/index.html","hash":"a24b65dbf207e63ee19f3e4131ef0f36c2975180","modified":1770218639680},{"_id":"public/tags/教程/index.html","hash":"eb83085a52674350bf475d118c8e4671e2c8dbca","modified":1770218639680},{"_id":"public/tags/Docker/index.html","hash":"71e24db39e1a5e26aced8c245dc4181fa3266e28","modified":1770218639680},{"_id":"public/img/brain.jpg","hash":"d8b968853d67ca7bd82b8326a1025e294e7feafe","modified":1770217795309},{"_id":"public/img/404.jpg","hash":"fb4489bc1d30c93d28f7332158c1c6c1416148de","modified":1770217795309},{"_id":"public/img/error-page.png","hash":"d2519710498a871ca3e913c57e2ba20a805b6430","modified":1770217795309},{"_id":"public/img/favicon.ico","hash":"455ac256580bf31a45813dbbdb87219bfc8bfb04","modified":1770217795309},{"_id":"public/img/friend_404.gif","hash":"8d2d0ebef70a8eb07329f57e645889b0e420fa48","modified":1770217795309},{"_id":"public/css/index.css","hash":"62ffab94eaf31c729ba5cf72599715afd9a35483","modified":1770217795309},{"_id":"public/css/var.css","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1770217795309},{"_id":"public/js/tw_cn.js","hash":"337c417a6e37dfabc920463fa13f65cc3d02f164","modified":1770217795309},{"_id":"public/js/main.js","hash":"68186d3d5933da41b7177645687237b35d6154a8","modified":1770217795309},{"_id":"public/js/utils.js","hash":"5e47bf8c7ae0b659d6697c464772f311c01b4633","modified":1770217795309},{"_id":"public/js/search/algolia.js","hash":"02491d2798f07f820962cafaceb07a2f8c97bc41","modified":1770217795309},{"_id":"public/js/search/local-search.js","hash":"50ab53c2b11c7c4cc1d9240b749af124ad38bfdc","modified":1770217795309},{"_id":"public/img/butterfly-icon.png","hash":"f5dd732fed5c3bcd4aa76bac3441bac8485fb432","modified":1770217795309}],"Category":[{"name":"系统搭建","_id":"cml85ywzh00059znxeka562g2"}],"Data":[],"Page":[],"Post":[{"title":"Nginx 快速入门","date":"2026-02-04T15:01:00.000Z","_content":"\n> Nginx 是一个高性能的 Web 服务器，主要负责处理客户端（浏览器）和后端服务器（应用）之间的通信。  \n>\n\n# 用途\n> nginx 最核心的三大用途\n>\n> + 反向代理\n> + 负载均衡\n> + 静态资源服务\n>\n\n## 反向代理\n+ **原理**：用户访问网站时，其实是连接到 Nginx，由 Nginx 帮忙去后端获取数据再返回给用户。 \n+ **价值**：\n    - **安全**：隐藏了后端服务器的真实 IP，保护核心数据。  \n    - **统一**：所有请求由 Nginx 统一接管，便于管理。  \n\n## 负载均衡\n+ **原理：**当访问量巨大时，Nginx 会按照规则（如轮询、权重）将请求平均分配给多台后端服务器。  \n+ **价值：**\n    - **稳定： **防止某一台服务器因流量过大而累死（宕机）**。  **\n    - **高可用：** 如果一台坏了，Nginx 自动把请求转给其他正常的服务器。  \n\n## 动静分离\n+ **原理：**将图片、CSS、JS、HTML 等不需要计算的静态文件，直接由 Nginx 快速返回，不经过后端应用服务器。 ** **\n+ **价值**：\n    - **提速：**Nginx 处理静态文件的速度远超 Tomcat/Python 等应用服务器。\n    - **减负：**让昂贵的后端算力专心处理复杂的业务逻辑。\n\n## 总结\n 如果把一个 Web 系统比作一家**火爆的餐厅**，Nginx 扮演了以下角色：  \n\n| **<font style=\"color:rgb(31, 31, 31);\">功能</font>** | **<font style=\"color:rgb(31, 31, 31);\">类比角色</font>** | **<font style=\"color:rgb(31, 31, 31);\">解释</font>** |\n| --- | --- | --- |\n| **<font style=\"color:rgb(31, 31, 31);\">反向代理</font>** | **<font style=\"color:rgb(31, 31, 31);\">服务员</font>** | <font style=\"color:rgb(31, 31, 31);\">顾客不需要进后厨找厨师，找服务员（Nginx）点菜即可。</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">负载均衡</font>** | **<font style=\"color:rgb(31, 31, 31);\">领班</font>** | <font style=\"color:rgb(31, 31, 31);\">看到 1 号桌满了，领班（Nginx）带顾客去 2 号空桌，保证不拥堵。</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">静态服务</font>** | **<font style=\"color:rgb(31, 31, 31);\">自助水吧</font>** | <font style=\"color:rgb(31, 31, 31);\">倒水这种简单事（静态资源），直接在水吧拿最快，不用麻烦大厨。</font> |\n\n\n# 正向代理和反向代理\n> 这里需要区分一下正向代理和反向代理的区别\n>\n\n⚔️ 正向代理 vs 反向代理\n\n1. **正向代理 (Forward Proxy)**  \n一句话概括：它是“客户端”的代理人。\n+ **也就是谁在用它？** 用户（Client）主动使用的。\n+ **谁被隐藏了？** **用户（Client）**。服务器只知道代理来访问了，不知道背后真正的用户是谁。\n+ 生活通俗类比： 海外代购。\n    - 你想买某品牌的限量包（目标服务器），但你去不了那个国家。\n    - 你找了一个代购（正向代理）。\n    - 代购去店里买了包发给你。\n    - **结果：** 品牌店只知道是“代购”买了包，完全不知道其实是你买的。\n+ **典型用途：**\n    - **科学上网 (VPN)：**访问原本无法访问的网站。\n    - **公司内网监控：**公司通过代理服务器上网，只允许员工访问特定网站。\n2. **反向代理 (Reverse Proxy)**  \n一句话概括：它是“服务端”的代言人。\n+ **也就是谁在用它？** 网站管理员（Server）部署的。\n+ **谁被隐藏了？** **服务器（Server）**。用户只知道访问了代理的地址，不知道背后具体是哪台机器在处理。\n+ 生活通俗类比： 打客服电话。\n    - 你有问题要咨询移动/联通（客户端请求）。\n    - 你拨打 10086（反向代理）。\n    - 10086 系统会自动把你转接到具体的“工号 8823”客服人员（后端服务器）。\n    - **结果：** 你只知道你打给了 10086，根本不知道（也不需要知道）是哪位具体的客服在服务你。\n+ **典型用途：**\n    - **Nginx 负载均衡：**把流量分发给不同的服务器。\n    - **安全防护：**作为防火墙，挡在核心数据库前面。\n\n| **<font style=\"color:rgb(31, 31, 31);\">特性</font>** | **<font style=\"color:rgb(31, 31, 31);\">正向代理 (Forward Proxy)</font>** | **<font style=\"color:rgb(31, 31, 31);\">反向代理 (Reverse Proxy)</font>** |\n| --- | --- | --- |\n| **<font style=\"color:rgb(31, 31, 31);\">代理对象</font>** | **<font style=\"color:rgb(31, 31, 31);\">客户端</font>**<font style=\"color:rgb(31, 31, 31);\"> (Client)</font> | **<font style=\"color:rgb(31, 31, 31);\">服务端</font>**<font style=\"color:rgb(31, 31, 31);\"> (Server)</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">架设方</font>** | <font style=\"color:rgb(31, 31, 31);\">用户自己（或公司IT）设置</font> | <font style=\"color:rgb(31, 31, 31);\">网站管理员设置</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">谁被隐藏</font>** | **<font style=\"color:rgb(31, 31, 31);\">用户 IP</font>**<font style=\"color:rgb(31, 31, 31);\"> 被隐藏</font> | **<font style=\"color:rgb(31, 31, 31);\">真实服务器 IP</font>**<font style=\"color:rgb(31, 31, 31);\"> 被隐藏</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">感知度</font>** | <font style=\"color:rgb(31, 31, 31);\">用户</font>**<font style=\"color:rgb(31, 31, 31);\">知道</font>**<font style=\"color:rgb(31, 31, 31);\">自己在用代理</font> | <font style=\"color:rgb(31, 31, 31);\">用户</font>**<font style=\"color:rgb(31, 31, 31);\">不知道</font>**<font style=\"color:rgb(31, 31, 31);\">自己在用代理</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">典型代表</font>** | <font style=\"color:rgb(31, 31, 31);\">VPN、梯子</font> | <font style=\"color:rgb(31, 31, 31);\">Nginx、HAProxy</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">方向</font>** | <font style=\"color:rgb(31, 31, 31);\">出口 (Outbound)</font> | <font style=\"color:rgb(31, 31, 31);\">入口 (Inbound)</font> |\n\n\n# 负载均衡\n> nginx 的负载均衡策略有两种\n>\n> + 内置策略\n> + 扩展策略\n>\n\n## 1. 什么是负载均衡？(The Concept)\n**一句话**：把所有的脏活累活（流量），平均分给那个“干活天团”（后端服务器集群），不让任何一个人累死。\n\n+ **核心目的**：提升网站的吞吐量，增加稳定性（一台挂了还有别的）。\n+ **Nginx 的角色**：它是那个**分发任务的组长**。\n\n---\n\n## 2. 核心组件：Upstream (服务器池)\n在 Nginx 里，你不能直接把任务指派给某一台机器，你得先定义一个“组”。这个组在配置文件里叫 `upstream`。\n\n+ **概念**：把一堆服务器打包成一个“资源池”。\n+ **通俗理解**：这是你的**“后台工作小组”**名单。\n\n---\n\n## 3. 分配策略 (调度算法)\nNginx 这个“组长”怎么决定把下一个任务派给谁？它有几套不同的逻辑：\n\n### A. 轮询 (Round Robin)\n> **默认策略**\n>\n\n+ **逻辑**：排排坐，吃果果。第一个请求给 A，第二个给 B，第三个给 C，第四个又给 A……\n+ **场景**：后端服务器配置都差不多，大家众生平等。\n\n### B. 权重 (Weight)\n> **能力越大，责任越大**\n>\n\n+ **逻辑**：给服务器打分。配置高的机器（比如 8核 CPU），权重设高点；配置低的，权重设低点。\n+ **场景**：新旧服务器混用，新机器更能打，就多干点活。\n    - _例子：Server A (权重3), Server B (权重1) -> 4个请求里，A 处理 3 个，B 处理 1 个。_\n\n### C. IP Hash (IP哈希)\n>  **专人专送**\n>\n\n+ **逻辑**：记仇（记人）。根据访客的 IP 地址计算。只要是你（同一个 IP）来的请求，永远固定发给同一台服务器。\n+ **场景**：**为了保持登录状态**（Session）。\n    - _如果不用于此：_ 你的请求一会儿飘到 A 服务器（有你的登录信息），一会儿飘到 B 服务器（没你的信息），你就会莫名其妙被踢下线。\n\n### D. 最少连接 (Least Conn) \n> **谁闲给谁**\n>\n\n+ **逻辑**：Nginx 会看哪台服务器当前正在处理的连接数最少，就把新任务给它。\n+ **场景**：有的请求处理很快，有的很慢。这个策略能保证不会有人在“摸鱼”，也不会有人被“累死”。\n\n---\n\n## 4. 容灾与状态 (Status & Failover)\n除了分发，Nginx 还能管理组员的状态。\n\n### A. Down (下线)\n+ **含义**：告诉 Nginx 这台机器“请假了”。\n+ **作用**：维护升级时，手动把它标记为 down，Nginx 就暂时不给它派活了。\n\n### B. Backup (备胎)\n+ **含义**：这台机器平时不干活，在旁边歇着。\n+ **触发条件**：只有当**所有**正常工作的机器都挂了（忙不过来了），这个“备胎”才会紧急启动接客。\n\n### C. 自动剔除 (Health Check)\n+ **逻辑**：如果你派给 Server A 的活它没接（超时或报错），Nginx 会自动把它标记为“不可用”，并在接下来的一段时间内跳过它。\n+ **通俗理解**：发现员工生病了，组长自动准假，让他休息一会儿再来看看好了没。\n\n# 动静分离\n> 为什么要做动静分离\n>\n> + **🚀**** 速度飞快**：Nginx 处理静态文件的能力比 Tomcat/Django 强 10 倍以上，并发能力极强。\n> + **🔋**** 给后端减负**：让昂贵的后端服务器专注于处理复杂的业务逻辑，不再被图片加载这种琐事占用内存和 CPU。\n> + **📂**** 维护方便**：静态文件可以直接由前端工程师更新到 Nginx 目录下，不需要重启后端的应用服务。\n>\n\n## 1. 核心概念：什么是“动”和“静”？\n在网站的世界里，资源分为两类：\n\n+ **🧱**** 静态资源 (Static)**：\n    - **特点**：谁来访问都一样，不需要计算，拿走就能用。\n    - **例子**：图片 (`.jpg`)、样式表 (`.css`)、脚本文件 (`.js`)、普通的 HTML 页面。\n+ **⚙️**** 动态资源 (Dynamic)**：\n    - **特点**：因人而异，需要经过服务器计算、查数据库才能生成。\n    - **例子**：购物车数据、个人中心、搜索结果、API 接口。\n\n## 2. 什么是“动静分离”？\n**一句话解释**：把“搬运死文件”的粗活交给 **Nginx**，把“计算逻辑”的细活交给 **后端应用服务器**（如 Tomcat、Go、Python）。\n\n+ **不分离的情况（大锅饭）**： 所有的请求（无论是看一张图，还是查账单）都丢给后端的 Tomcat 处理。Tomcat 既要算账又要搬图，累得半死，效率极低。\n+ **分离的情况（各司其职）**：\n    - **Nginx**：站在最前面。如果是图片/CSS，自己直接从硬盘读取返回（速度极快）。\n    - **后端**：如果是复杂的业务逻辑，Nginx 再转发给 Tomcat/Java 处理。\n\n# 从三个角度感受 Nginx\n##  拯救混乱\n**没有 Nginx 的世界**\n\n> 所有用户直接拥挤到一台应用服务器上，服务器既要拿图片，又要算数据，还要抗并发，最终不堪重负。  \n>\n![](https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/1.svg)\n\n **有了 Nginx 的世界**\n\n> Nginx 挡在最前面抗住压力，后端服务器只需专心干好自己的活，整个系统轻松扩容。  \n>\n![](https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/2.svg)\n\n##  极速分流\n> Nginx **动静分离**的魅力：它能瞬间识别请求类型，让简单的请求走“高速公路”，复杂的请求走“普通车道”。  \n>\n![](https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/3.svg)\n##  安全护盾  \n> Nginx **反向代理**的魅力：它隐藏了后端服务器的真实身份，把危险挡在门外。外界只知道 Nginx 的存在，不知道核心数据到底在哪。  \n>\n![](https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/4.svg)\n# 查看 nginx 进程\n`ps -ef | grep nginx`\n\n```shell\nroot@1769126960986:~# ps -ef | grep nginx\nroot     1335626 1335605  0 Feb01 ?        00:00:00 nginx: master process nginx -g daemon off;\nmessage+ 1341281 1335626  0 Feb01 ?        00:00:00 nginx: worker process\nmessage+ 1341282 1335626  0 Feb01 ?        00:00:00 nginx: worker process\nmessage+ 1341283 1335626  0 Feb01 ?        00:00:00 nginx: worker process\nmessage+ 1341284 1335626  0 Feb01 ?        00:00:00 nginx: worker process\nroot     1538084 1536452  0 00:01 pts/1    00:00:00 grep --color=auto nginx\n```\n\n# nginx 进程模型\n**master**：nginx 的主进程，负责读取和验证配置文件，管理 worker 进程\n\n**worker**：nginx 的工作进程，负责处理实际的请求\n\n`master`只有一个，`worker`可以有很多个，他们之间的关系就像老板和员工\n\n`worker`进程的数量可以通过配置文件来调整\n\n# nginx 启停\n`nginx -s signal`\n\n```shell\nnginx -s signal\nquit:\t优雅停止\nstop:\t立即停止\nreload: 重载配置文件\nreopen: 重新打开日志文件\n```\n\n# nginx 快速部署静态文件\n通过`nginx -V` 和 `nginx -t`来查看 nginx 配置文件路径\n\n```shell\n1.nginx -V\n--http-client-body-temp-path=/var/lib/nginx/body \n--http-fastcgi-temp-path=/var/lib/nginx/fastcgi \n--http-proxy-temp-path=/var/lib/nginx/proxy \n--http-scgi-temp-path=/var/lib/nginx/scgi \n--http-uwsgi-temp-path=/var/lib/nginx/uwsgi \n--with-compat --with-debug --with-pcre-jit --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_v2_module --with-http_dav_module --with-http_slice_module --with-threads --with-http_addition_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_secure_link_module --with-http_sub_module --with-mail_ssl_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-stream_realip_module --with-http_geoip_module=dynamic --with-http_image_filter_module=dynamic --with-http_perl_module=dynamic --with-http_xslt_module=dynamic --with-mail=dynamic --with-stream=dynamic --with-stream_geoip_module=dynamic=\n\n2.nginx -t\nroot@1769126960986:~# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n\n```\n\n","source":"_posts/Nginx 快速入门.md","raw":"---\ntitle: Nginx 快速入门\ndate: 2026-02-04 23:01:00\ntags: [Nginx, Web服务器]\n---\n\n> Nginx 是一个高性能的 Web 服务器，主要负责处理客户端（浏览器）和后端服务器（应用）之间的通信。  \n>\n\n# 用途\n> nginx 最核心的三大用途\n>\n> + 反向代理\n> + 负载均衡\n> + 静态资源服务\n>\n\n## 反向代理\n+ **原理**：用户访问网站时，其实是连接到 Nginx，由 Nginx 帮忙去后端获取数据再返回给用户。 \n+ **价值**：\n    - **安全**：隐藏了后端服务器的真实 IP，保护核心数据。  \n    - **统一**：所有请求由 Nginx 统一接管，便于管理。  \n\n## 负载均衡\n+ **原理：**当访问量巨大时，Nginx 会按照规则（如轮询、权重）将请求平均分配给多台后端服务器。  \n+ **价值：**\n    - **稳定： **防止某一台服务器因流量过大而累死（宕机）**。  **\n    - **高可用：** 如果一台坏了，Nginx 自动把请求转给其他正常的服务器。  \n\n## 动静分离\n+ **原理：**将图片、CSS、JS、HTML 等不需要计算的静态文件，直接由 Nginx 快速返回，不经过后端应用服务器。 ** **\n+ **价值**：\n    - **提速：**Nginx 处理静态文件的速度远超 Tomcat/Python 等应用服务器。\n    - **减负：**让昂贵的后端算力专心处理复杂的业务逻辑。\n\n## 总结\n 如果把一个 Web 系统比作一家**火爆的餐厅**，Nginx 扮演了以下角色：  \n\n| **<font style=\"color:rgb(31, 31, 31);\">功能</font>** | **<font style=\"color:rgb(31, 31, 31);\">类比角色</font>** | **<font style=\"color:rgb(31, 31, 31);\">解释</font>** |\n| --- | --- | --- |\n| **<font style=\"color:rgb(31, 31, 31);\">反向代理</font>** | **<font style=\"color:rgb(31, 31, 31);\">服务员</font>** | <font style=\"color:rgb(31, 31, 31);\">顾客不需要进后厨找厨师，找服务员（Nginx）点菜即可。</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">负载均衡</font>** | **<font style=\"color:rgb(31, 31, 31);\">领班</font>** | <font style=\"color:rgb(31, 31, 31);\">看到 1 号桌满了，领班（Nginx）带顾客去 2 号空桌，保证不拥堵。</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">静态服务</font>** | **<font style=\"color:rgb(31, 31, 31);\">自助水吧</font>** | <font style=\"color:rgb(31, 31, 31);\">倒水这种简单事（静态资源），直接在水吧拿最快，不用麻烦大厨。</font> |\n\n\n# 正向代理和反向代理\n> 这里需要区分一下正向代理和反向代理的区别\n>\n\n⚔️ 正向代理 vs 反向代理\n\n1. **正向代理 (Forward Proxy)**  \n一句话概括：它是“客户端”的代理人。\n+ **也就是谁在用它？** 用户（Client）主动使用的。\n+ **谁被隐藏了？** **用户（Client）**。服务器只知道代理来访问了，不知道背后真正的用户是谁。\n+ 生活通俗类比： 海外代购。\n    - 你想买某品牌的限量包（目标服务器），但你去不了那个国家。\n    - 你找了一个代购（正向代理）。\n    - 代购去店里买了包发给你。\n    - **结果：** 品牌店只知道是“代购”买了包，完全不知道其实是你买的。\n+ **典型用途：**\n    - **科学上网 (VPN)：**访问原本无法访问的网站。\n    - **公司内网监控：**公司通过代理服务器上网，只允许员工访问特定网站。\n2. **反向代理 (Reverse Proxy)**  \n一句话概括：它是“服务端”的代言人。\n+ **也就是谁在用它？** 网站管理员（Server）部署的。\n+ **谁被隐藏了？** **服务器（Server）**。用户只知道访问了代理的地址，不知道背后具体是哪台机器在处理。\n+ 生活通俗类比： 打客服电话。\n    - 你有问题要咨询移动/联通（客户端请求）。\n    - 你拨打 10086（反向代理）。\n    - 10086 系统会自动把你转接到具体的“工号 8823”客服人员（后端服务器）。\n    - **结果：** 你只知道你打给了 10086，根本不知道（也不需要知道）是哪位具体的客服在服务你。\n+ **典型用途：**\n    - **Nginx 负载均衡：**把流量分发给不同的服务器。\n    - **安全防护：**作为防火墙，挡在核心数据库前面。\n\n| **<font style=\"color:rgb(31, 31, 31);\">特性</font>** | **<font style=\"color:rgb(31, 31, 31);\">正向代理 (Forward Proxy)</font>** | **<font style=\"color:rgb(31, 31, 31);\">反向代理 (Reverse Proxy)</font>** |\n| --- | --- | --- |\n| **<font style=\"color:rgb(31, 31, 31);\">代理对象</font>** | **<font style=\"color:rgb(31, 31, 31);\">客户端</font>**<font style=\"color:rgb(31, 31, 31);\"> (Client)</font> | **<font style=\"color:rgb(31, 31, 31);\">服务端</font>**<font style=\"color:rgb(31, 31, 31);\"> (Server)</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">架设方</font>** | <font style=\"color:rgb(31, 31, 31);\">用户自己（或公司IT）设置</font> | <font style=\"color:rgb(31, 31, 31);\">网站管理员设置</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">谁被隐藏</font>** | **<font style=\"color:rgb(31, 31, 31);\">用户 IP</font>**<font style=\"color:rgb(31, 31, 31);\"> 被隐藏</font> | **<font style=\"color:rgb(31, 31, 31);\">真实服务器 IP</font>**<font style=\"color:rgb(31, 31, 31);\"> 被隐藏</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">感知度</font>** | <font style=\"color:rgb(31, 31, 31);\">用户</font>**<font style=\"color:rgb(31, 31, 31);\">知道</font>**<font style=\"color:rgb(31, 31, 31);\">自己在用代理</font> | <font style=\"color:rgb(31, 31, 31);\">用户</font>**<font style=\"color:rgb(31, 31, 31);\">不知道</font>**<font style=\"color:rgb(31, 31, 31);\">自己在用代理</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">典型代表</font>** | <font style=\"color:rgb(31, 31, 31);\">VPN、梯子</font> | <font style=\"color:rgb(31, 31, 31);\">Nginx、HAProxy</font> |\n| **<font style=\"color:rgb(31, 31, 31);\">方向</font>** | <font style=\"color:rgb(31, 31, 31);\">出口 (Outbound)</font> | <font style=\"color:rgb(31, 31, 31);\">入口 (Inbound)</font> |\n\n\n# 负载均衡\n> nginx 的负载均衡策略有两种\n>\n> + 内置策略\n> + 扩展策略\n>\n\n## 1. 什么是负载均衡？(The Concept)\n**一句话**：把所有的脏活累活（流量），平均分给那个“干活天团”（后端服务器集群），不让任何一个人累死。\n\n+ **核心目的**：提升网站的吞吐量，增加稳定性（一台挂了还有别的）。\n+ **Nginx 的角色**：它是那个**分发任务的组长**。\n\n---\n\n## 2. 核心组件：Upstream (服务器池)\n在 Nginx 里，你不能直接把任务指派给某一台机器，你得先定义一个“组”。这个组在配置文件里叫 `upstream`。\n\n+ **概念**：把一堆服务器打包成一个“资源池”。\n+ **通俗理解**：这是你的**“后台工作小组”**名单。\n\n---\n\n## 3. 分配策略 (调度算法)\nNginx 这个“组长”怎么决定把下一个任务派给谁？它有几套不同的逻辑：\n\n### A. 轮询 (Round Robin)\n> **默认策略**\n>\n\n+ **逻辑**：排排坐，吃果果。第一个请求给 A，第二个给 B，第三个给 C，第四个又给 A……\n+ **场景**：后端服务器配置都差不多，大家众生平等。\n\n### B. 权重 (Weight)\n> **能力越大，责任越大**\n>\n\n+ **逻辑**：给服务器打分。配置高的机器（比如 8核 CPU），权重设高点；配置低的，权重设低点。\n+ **场景**：新旧服务器混用，新机器更能打，就多干点活。\n    - _例子：Server A (权重3), Server B (权重1) -> 4个请求里，A 处理 3 个，B 处理 1 个。_\n\n### C. IP Hash (IP哈希)\n>  **专人专送**\n>\n\n+ **逻辑**：记仇（记人）。根据访客的 IP 地址计算。只要是你（同一个 IP）来的请求，永远固定发给同一台服务器。\n+ **场景**：**为了保持登录状态**（Session）。\n    - _如果不用于此：_ 你的请求一会儿飘到 A 服务器（有你的登录信息），一会儿飘到 B 服务器（没你的信息），你就会莫名其妙被踢下线。\n\n### D. 最少连接 (Least Conn) \n> **谁闲给谁**\n>\n\n+ **逻辑**：Nginx 会看哪台服务器当前正在处理的连接数最少，就把新任务给它。\n+ **场景**：有的请求处理很快，有的很慢。这个策略能保证不会有人在“摸鱼”，也不会有人被“累死”。\n\n---\n\n## 4. 容灾与状态 (Status & Failover)\n除了分发，Nginx 还能管理组员的状态。\n\n### A. Down (下线)\n+ **含义**：告诉 Nginx 这台机器“请假了”。\n+ **作用**：维护升级时，手动把它标记为 down，Nginx 就暂时不给它派活了。\n\n### B. Backup (备胎)\n+ **含义**：这台机器平时不干活，在旁边歇着。\n+ **触发条件**：只有当**所有**正常工作的机器都挂了（忙不过来了），这个“备胎”才会紧急启动接客。\n\n### C. 自动剔除 (Health Check)\n+ **逻辑**：如果你派给 Server A 的活它没接（超时或报错），Nginx 会自动把它标记为“不可用”，并在接下来的一段时间内跳过它。\n+ **通俗理解**：发现员工生病了，组长自动准假，让他休息一会儿再来看看好了没。\n\n# 动静分离\n> 为什么要做动静分离\n>\n> + **🚀**** 速度飞快**：Nginx 处理静态文件的能力比 Tomcat/Django 强 10 倍以上，并发能力极强。\n> + **🔋**** 给后端减负**：让昂贵的后端服务器专注于处理复杂的业务逻辑，不再被图片加载这种琐事占用内存和 CPU。\n> + **📂**** 维护方便**：静态文件可以直接由前端工程师更新到 Nginx 目录下，不需要重启后端的应用服务。\n>\n\n## 1. 核心概念：什么是“动”和“静”？\n在网站的世界里，资源分为两类：\n\n+ **🧱**** 静态资源 (Static)**：\n    - **特点**：谁来访问都一样，不需要计算，拿走就能用。\n    - **例子**：图片 (`.jpg`)、样式表 (`.css`)、脚本文件 (`.js`)、普通的 HTML 页面。\n+ **⚙️**** 动态资源 (Dynamic)**：\n    - **特点**：因人而异，需要经过服务器计算、查数据库才能生成。\n    - **例子**：购物车数据、个人中心、搜索结果、API 接口。\n\n## 2. 什么是“动静分离”？\n**一句话解释**：把“搬运死文件”的粗活交给 **Nginx**，把“计算逻辑”的细活交给 **后端应用服务器**（如 Tomcat、Go、Python）。\n\n+ **不分离的情况（大锅饭）**： 所有的请求（无论是看一张图，还是查账单）都丢给后端的 Tomcat 处理。Tomcat 既要算账又要搬图，累得半死，效率极低。\n+ **分离的情况（各司其职）**：\n    - **Nginx**：站在最前面。如果是图片/CSS，自己直接从硬盘读取返回（速度极快）。\n    - **后端**：如果是复杂的业务逻辑，Nginx 再转发给 Tomcat/Java 处理。\n\n# 从三个角度感受 Nginx\n##  拯救混乱\n**没有 Nginx 的世界**\n\n> 所有用户直接拥挤到一台应用服务器上，服务器既要拿图片，又要算数据，还要抗并发，最终不堪重负。  \n>\n![](https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/1.svg)\n\n **有了 Nginx 的世界**\n\n> Nginx 挡在最前面抗住压力，后端服务器只需专心干好自己的活，整个系统轻松扩容。  \n>\n![](https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/2.svg)\n\n##  极速分流\n> Nginx **动静分离**的魅力：它能瞬间识别请求类型，让简单的请求走“高速公路”，复杂的请求走“普通车道”。  \n>\n![](https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/3.svg)\n##  安全护盾  \n> Nginx **反向代理**的魅力：它隐藏了后端服务器的真实身份，把危险挡在门外。外界只知道 Nginx 的存在，不知道核心数据到底在哪。  \n>\n![](https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/4.svg)\n# 查看 nginx 进程\n`ps -ef | grep nginx`\n\n```shell\nroot@1769126960986:~# ps -ef | grep nginx\nroot     1335626 1335605  0 Feb01 ?        00:00:00 nginx: master process nginx -g daemon off;\nmessage+ 1341281 1335626  0 Feb01 ?        00:00:00 nginx: worker process\nmessage+ 1341282 1335626  0 Feb01 ?        00:00:00 nginx: worker process\nmessage+ 1341283 1335626  0 Feb01 ?        00:00:00 nginx: worker process\nmessage+ 1341284 1335626  0 Feb01 ?        00:00:00 nginx: worker process\nroot     1538084 1536452  0 00:01 pts/1    00:00:00 grep --color=auto nginx\n```\n\n# nginx 进程模型\n**master**：nginx 的主进程，负责读取和验证配置文件，管理 worker 进程\n\n**worker**：nginx 的工作进程，负责处理实际的请求\n\n`master`只有一个，`worker`可以有很多个，他们之间的关系就像老板和员工\n\n`worker`进程的数量可以通过配置文件来调整\n\n# nginx 启停\n`nginx -s signal`\n\n```shell\nnginx -s signal\nquit:\t优雅停止\nstop:\t立即停止\nreload: 重载配置文件\nreopen: 重新打开日志文件\n```\n\n# nginx 快速部署静态文件\n通过`nginx -V` 和 `nginx -t`来查看 nginx 配置文件路径\n\n```shell\n1.nginx -V\n--http-client-body-temp-path=/var/lib/nginx/body \n--http-fastcgi-temp-path=/var/lib/nginx/fastcgi \n--http-proxy-temp-path=/var/lib/nginx/proxy \n--http-scgi-temp-path=/var/lib/nginx/scgi \n--http-uwsgi-temp-path=/var/lib/nginx/uwsgi \n--with-compat --with-debug --with-pcre-jit --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_v2_module --with-http_dav_module --with-http_slice_module --with-threads --with-http_addition_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_secure_link_module --with-http_sub_module --with-mail_ssl_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-stream_realip_module --with-http_geoip_module=dynamic --with-http_image_filter_module=dynamic --with-http_perl_module=dynamic --with-http_xslt_module=dynamic --with-mail=dynamic --with-stream=dynamic --with-stream_geoip_module=dynamic=\n\n2.nginx -t\nroot@1769126960986:~# nginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n\n```\n\n","slug":"Nginx 快速入门","published":1,"updated":"2026-02-04T15:23:55.704Z","_id":"cml85ywz400009znx5zvh3tit","comments":1,"layout":"post","photos":[],"content":"<blockquote>\n<p>Nginx 是一个高性能的 Web 服务器，主要负责处理客户端（浏览器）和后端服务器（应用）之间的通信。  </p>\n</blockquote>\n<h1 id=\"用途\"><a href=\"#用途\" class=\"headerlink\" title=\"用途\"></a>用途</h1><blockquote>\n<p>nginx 最核心的三大用途</p>\n<ul>\n<li>反向代理</li>\n<li>负载均衡</li>\n<li>静态资源服务</li>\n</ul>\n</blockquote>\n<h2 id=\"反向代理\"><a href=\"#反向代理\" class=\"headerlink\" title=\"反向代理\"></a>反向代理</h2><ul>\n<li><strong>原理</strong>：用户访问网站时，其实是连接到 Nginx，由 Nginx 帮忙去后端获取数据再返回给用户。 </li>\n<li><strong>价值</strong>：<ul>\n<li><strong>安全</strong>：隐藏了后端服务器的真实 IP，保护核心数据。  </li>\n<li><strong>统一</strong>：所有请求由 Nginx 统一接管，便于管理。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h2><ul>\n<li><strong>原理：</strong>当访问量巨大时，Nginx 会按照规则（如轮询、权重）将请求平均分配给多台后端服务器。  </li>\n<li><strong>价值：</strong><ul>\n<li>**稳定： <strong>防止某一台服务器因流量过大而累死（宕机）</strong>。  **</li>\n<li><strong>高可用：</strong> 如果一台坏了，Nginx 自动把请求转给其他正常的服务器。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"动静分离\"><a href=\"#动静分离\" class=\"headerlink\" title=\"动静分离\"></a>动静分离</h2><ul>\n<li><strong>原理：</strong>将图片、CSS、JS、HTML 等不需要计算的静态文件，直接由 Nginx 快速返回，不经过后端应用服务器。 ** **</li>\n<li><strong>价值</strong>：<ul>\n<li><strong>提速：</strong>Nginx 处理静态文件的速度远超 Tomcat&#x2F;Python 等应用服务器。</li>\n<li><strong>减负：</strong>让昂贵的后端算力专心处理复杂的业务逻辑。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p> 如果把一个 Web 系统比作一家<strong>火爆的餐厅</strong>，Nginx 扮演了以下角色：  </p>\n<table>\n<thead>\n<tr>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">功能</font></strong></th>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">类比角色</font></strong></th>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">解释</font></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">反向代理</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">服务员</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">顾客不需要进后厨找厨师，找服务员（Nginx）点菜即可。</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">负载均衡</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">领班</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">看到 1 号桌满了，领班（Nginx）带顾客去 2 号空桌，保证不拥堵。</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">静态服务</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">自助水吧</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">倒水这种简单事（静态资源），直接在水吧拿最快，不用麻烦大厨。</font></td>\n</tr>\n</tbody></table>\n<h1 id=\"正向代理和反向代理\"><a href=\"#正向代理和反向代理\" class=\"headerlink\" title=\"正向代理和反向代理\"></a>正向代理和反向代理</h1><blockquote>\n<p>这里需要区分一下正向代理和反向代理的区别</p>\n</blockquote>\n<p>⚔️ 正向代理 vs 反向代理</p>\n<ol>\n<li><strong>正向代理 (Forward Proxy)</strong><br>一句话概括：它是“客户端”的代理人。</li>\n</ol>\n<ul>\n<li><strong>也就是谁在用它？</strong> 用户（Client）主动使用的。</li>\n<li><strong>谁被隐藏了？</strong> <strong>用户（Client）</strong>。服务器只知道代理来访问了，不知道背后真正的用户是谁。</li>\n<li>生活通俗类比： 海外代购。<ul>\n<li>你想买某品牌的限量包（目标服务器），但你去不了那个国家。</li>\n<li>你找了一个代购（正向代理）。</li>\n<li>代购去店里买了包发给你。</li>\n<li><strong>结果：</strong> 品牌店只知道是“代购”买了包，完全不知道其实是你买的。</li>\n</ul>\n</li>\n<li><strong>典型用途：</strong><ul>\n<li><strong>科学上网 (VPN)：</strong>访问原本无法访问的网站。</li>\n<li><strong>公司内网监控：</strong>公司通过代理服务器上网，只允许员工访问特定网站。</li>\n</ul>\n</li>\n</ul>\n<ol start=\"2\">\n<li><strong>反向代理 (Reverse Proxy)</strong><br>一句话概括：它是“服务端”的代言人。</li>\n</ol>\n<ul>\n<li><strong>也就是谁在用它？</strong> 网站管理员（Server）部署的。</li>\n<li><strong>谁被隐藏了？</strong> <strong>服务器（Server）</strong>。用户只知道访问了代理的地址，不知道背后具体是哪台机器在处理。</li>\n<li>生活通俗类比： 打客服电话。<ul>\n<li>你有问题要咨询移动&#x2F;联通（客户端请求）。</li>\n<li>你拨打 10086（反向代理）。</li>\n<li>10086 系统会自动把你转接到具体的“工号 8823”客服人员（后端服务器）。</li>\n<li><strong>结果：</strong> 你只知道你打给了 10086，根本不知道（也不需要知道）是哪位具体的客服在服务你。</li>\n</ul>\n</li>\n<li><strong>典型用途：</strong><ul>\n<li><strong>Nginx 负载均衡：</strong>把流量分发给不同的服务器。</li>\n<li><strong>安全防护：</strong>作为防火墙，挡在核心数据库前面。</li>\n</ul>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">特性</font></strong></th>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">正向代理 (Forward Proxy)</font></strong></th>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">反向代理 (Reverse Proxy)</font></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">代理对象</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">客户端</font></strong><font style=\"color:rgb(31, 31, 31);\"> (Client)</font></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">服务端</font></strong><font style=\"color:rgb(31, 31, 31);\"> (Server)</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">架设方</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">用户自己（或公司IT）设置</font></td>\n<td><font style=\"color:rgb(31, 31, 31);\">网站管理员设置</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">谁被隐藏</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">用户 IP</font></strong><font style=\"color:rgb(31, 31, 31);\"> 被隐藏</font></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">真实服务器 IP</font></strong><font style=\"color:rgb(31, 31, 31);\"> 被隐藏</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">感知度</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">用户</font><strong><font style=\"color:rgb(31, 31, 31);\">知道</font></strong><font style=\"color:rgb(31, 31, 31);\">自己在用代理</font></td>\n<td><font style=\"color:rgb(31, 31, 31);\">用户</font><strong><font style=\"color:rgb(31, 31, 31);\">不知道</font></strong><font style=\"color:rgb(31, 31, 31);\">自己在用代理</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">典型代表</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">VPN、梯子</font></td>\n<td><font style=\"color:rgb(31, 31, 31);\">Nginx、HAProxy</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">方向</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">出口 (Outbound)</font></td>\n<td><font style=\"color:rgb(31, 31, 31);\">入口 (Inbound)</font></td>\n</tr>\n</tbody></table>\n<h1 id=\"负载均衡-1\"><a href=\"#负载均衡-1\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h1><blockquote>\n<p>nginx 的负载均衡策略有两种</p>\n<ul>\n<li>内置策略</li>\n<li>扩展策略</li>\n</ul>\n</blockquote>\n<h2 id=\"1-什么是负载均衡？-The-Concept\"><a href=\"#1-什么是负载均衡？-The-Concept\" class=\"headerlink\" title=\"1. 什么是负载均衡？(The Concept)\"></a>1. 什么是负载均衡？(The Concept)</h2><p><strong>一句话</strong>：把所有的脏活累活（流量），平均分给那个“干活天团”（后端服务器集群），不让任何一个人累死。</p>\n<ul>\n<li><strong>核心目的</strong>：提升网站的吞吐量，增加稳定性（一台挂了还有别的）。</li>\n<li><strong>Nginx 的角色</strong>：它是那个<strong>分发任务的组长</strong>。</li>\n</ul>\n<hr>\n<h2 id=\"2-核心组件：Upstream-服务器池\"><a href=\"#2-核心组件：Upstream-服务器池\" class=\"headerlink\" title=\"2. 核心组件：Upstream (服务器池)\"></a>2. 核心组件：Upstream (服务器池)</h2><p>在 Nginx 里，你不能直接把任务指派给某一台机器，你得先定义一个“组”。这个组在配置文件里叫 <code>upstream</code>。</p>\n<ul>\n<li><strong>概念</strong>：把一堆服务器打包成一个“资源池”。</li>\n<li><strong>通俗理解</strong>：这是你的<strong>“后台工作小组”</strong>名单。</li>\n</ul>\n<hr>\n<h2 id=\"3-分配策略-调度算法\"><a href=\"#3-分配策略-调度算法\" class=\"headerlink\" title=\"3. 分配策略 (调度算法)\"></a>3. 分配策略 (调度算法)</h2><p>Nginx 这个“组长”怎么决定把下一个任务派给谁？它有几套不同的逻辑：</p>\n<h3 id=\"A-轮询-Round-Robin\"><a href=\"#A-轮询-Round-Robin\" class=\"headerlink\" title=\"A. 轮询 (Round Robin)\"></a>A. 轮询 (Round Robin)</h3><blockquote>\n<p><strong>默认策略</strong></p>\n</blockquote>\n<ul>\n<li><strong>逻辑</strong>：排排坐，吃果果。第一个请求给 A，第二个给 B，第三个给 C，第四个又给 A……</li>\n<li><strong>场景</strong>：后端服务器配置都差不多，大家众生平等。</li>\n</ul>\n<h3 id=\"B-权重-Weight\"><a href=\"#B-权重-Weight\" class=\"headerlink\" title=\"B. 权重 (Weight)\"></a>B. 权重 (Weight)</h3><blockquote>\n<p><strong>能力越大，责任越大</strong></p>\n</blockquote>\n<ul>\n<li><strong>逻辑</strong>：给服务器打分。配置高的机器（比如 8核 CPU），权重设高点；配置低的，权重设低点。</li>\n<li><strong>场景</strong>：新旧服务器混用，新机器更能打，就多干点活。<ul>\n<li><em>例子：Server A (权重3), Server B (权重1) -&gt; 4个请求里，A 处理 3 个，B 处理 1 个。</em></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"C-IP-Hash-IP哈希\"><a href=\"#C-IP-Hash-IP哈希\" class=\"headerlink\" title=\"C. IP Hash (IP哈希)\"></a>C. IP Hash (IP哈希)</h3><blockquote>\n<p> <strong>专人专送</strong></p>\n</blockquote>\n<ul>\n<li><strong>逻辑</strong>：记仇（记人）。根据访客的 IP 地址计算。只要是你（同一个 IP）来的请求，永远固定发给同一台服务器。</li>\n<li><strong>场景</strong>：<strong>为了保持登录状态</strong>（Session）。<ul>\n<li><em>如果不用于此：</em> 你的请求一会儿飘到 A 服务器（有你的登录信息），一会儿飘到 B 服务器（没你的信息），你就会莫名其妙被踢下线。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"D-最少连接-Least-Conn\"><a href=\"#D-最少连接-Least-Conn\" class=\"headerlink\" title=\"D. 最少连接 (Least Conn)\"></a>D. 最少连接 (Least Conn)</h3><blockquote>\n<p><strong>谁闲给谁</strong></p>\n</blockquote>\n<ul>\n<li><strong>逻辑</strong>：Nginx 会看哪台服务器当前正在处理的连接数最少，就把新任务给它。</li>\n<li><strong>场景</strong>：有的请求处理很快，有的很慢。这个策略能保证不会有人在“摸鱼”，也不会有人被“累死”。</li>\n</ul>\n<hr>\n<h2 id=\"4-容灾与状态-Status-Failover\"><a href=\"#4-容灾与状态-Status-Failover\" class=\"headerlink\" title=\"4. 容灾与状态 (Status &amp; Failover)\"></a>4. 容灾与状态 (Status &amp; Failover)</h2><p>除了分发，Nginx 还能管理组员的状态。</p>\n<h3 id=\"A-Down-下线\"><a href=\"#A-Down-下线\" class=\"headerlink\" title=\"A. Down (下线)\"></a>A. Down (下线)</h3><ul>\n<li><strong>含义</strong>：告诉 Nginx 这台机器“请假了”。</li>\n<li><strong>作用</strong>：维护升级时，手动把它标记为 down，Nginx 就暂时不给它派活了。</li>\n</ul>\n<h3 id=\"B-Backup-备胎\"><a href=\"#B-Backup-备胎\" class=\"headerlink\" title=\"B. Backup (备胎)\"></a>B. Backup (备胎)</h3><ul>\n<li><strong>含义</strong>：这台机器平时不干活，在旁边歇着。</li>\n<li><strong>触发条件</strong>：只有当<strong>所有</strong>正常工作的机器都挂了（忙不过来了），这个“备胎”才会紧急启动接客。</li>\n</ul>\n<h3 id=\"C-自动剔除-Health-Check\"><a href=\"#C-自动剔除-Health-Check\" class=\"headerlink\" title=\"C. 自动剔除 (Health Check)\"></a>C. 自动剔除 (Health Check)</h3><ul>\n<li><strong>逻辑</strong>：如果你派给 Server A 的活它没接（超时或报错），Nginx 会自动把它标记为“不可用”，并在接下来的一段时间内跳过它。</li>\n<li><strong>通俗理解</strong>：发现员工生病了，组长自动准假，让他休息一会儿再来看看好了没。</li>\n</ul>\n<h1 id=\"动静分离-1\"><a href=\"#动静分离-1\" class=\"headerlink\" title=\"动静分离\"></a>动静分离</h1><blockquote>\n<p>为什么要做动静分离</p>\n<ul>\n<li><strong>🚀</strong>** 速度飞快**：Nginx 处理静态文件的能力比 Tomcat&#x2F;Django 强 10 倍以上，并发能力极强。</li>\n<li><strong>🔋</strong>** 给后端减负**：让昂贵的后端服务器专注于处理复杂的业务逻辑，不再被图片加载这种琐事占用内存和 CPU。</li>\n<li><strong>📂</strong>** 维护方便**：静态文件可以直接由前端工程师更新到 Nginx 目录下，不需要重启后端的应用服务。</li>\n</ul>\n</blockquote>\n<h2 id=\"1-核心概念：什么是“动”和“静”？\"><a href=\"#1-核心概念：什么是“动”和“静”？\" class=\"headerlink\" title=\"1. 核心概念：什么是“动”和“静”？\"></a>1. 核心概念：什么是“动”和“静”？</h2><p>在网站的世界里，资源分为两类：</p>\n<ul>\n<li><strong>🧱</strong>** 静态资源 (Static)**：<ul>\n<li><strong>特点</strong>：谁来访问都一样，不需要计算，拿走就能用。</li>\n<li><strong>例子</strong>：图片 (<code>.jpg</code>)、样式表 (<code>.css</code>)、脚本文件 (<code>.js</code>)、普通的 HTML 页面。</li>\n</ul>\n</li>\n<li><strong>⚙️</strong>** 动态资源 (Dynamic)**：<ul>\n<li><strong>特点</strong>：因人而异，需要经过服务器计算、查数据库才能生成。</li>\n<li><strong>例子</strong>：购物车数据、个人中心、搜索结果、API 接口。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2-什么是“动静分离”？\"><a href=\"#2-什么是“动静分离”？\" class=\"headerlink\" title=\"2. 什么是“动静分离”？\"></a>2. 什么是“动静分离”？</h2><p><strong>一句话解释</strong>：把“搬运死文件”的粗活交给 <strong>Nginx</strong>，把“计算逻辑”的细活交给 <strong>后端应用服务器</strong>（如 Tomcat、Go、Python）。</p>\n<ul>\n<li><strong>不分离的情况（大锅饭）</strong>： 所有的请求（无论是看一张图，还是查账单）都丢给后端的 Tomcat 处理。Tomcat 既要算账又要搬图，累得半死，效率极低。</li>\n<li><strong>分离的情况（各司其职）</strong>：<ul>\n<li><strong>Nginx</strong>：站在最前面。如果是图片&#x2F;CSS，自己直接从硬盘读取返回（速度极快）。</li>\n<li><strong>后端</strong>：如果是复杂的业务逻辑，Nginx 再转发给 Tomcat&#x2F;Java 处理。</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"从三个角度感受-Nginx\"><a href=\"#从三个角度感受-Nginx\" class=\"headerlink\" title=\"从三个角度感受 Nginx\"></a>从三个角度感受 Nginx</h1><h2 id=\"拯救混乱\"><a href=\"#拯救混乱\" class=\"headerlink\" title=\"拯救混乱\"></a>拯救混乱</h2><p><strong>没有 Nginx 的世界</strong></p>\n<blockquote>\n<p>所有用户直接拥挤到一台应用服务器上，服务器既要拿图片，又要算数据，还要抗并发，最终不堪重负。  </p>\n</blockquote>\n<p><img src=\"https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/1.svg\"></p>\n<p> <strong>有了 Nginx 的世界</strong></p>\n<blockquote>\n<p>Nginx 挡在最前面抗住压力，后端服务器只需专心干好自己的活，整个系统轻松扩容。  </p>\n</blockquote>\n<p><img src=\"https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/2.svg\"></p>\n<h2 id=\"极速分流\"><a href=\"#极速分流\" class=\"headerlink\" title=\"极速分流\"></a>极速分流</h2><blockquote>\n<p>Nginx <strong>动静分离</strong>的魅力：它能瞬间识别请求类型，让简单的请求走“高速公路”，复杂的请求走“普通车道”。  </p>\n</blockquote>\n<p><img src=\"https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/3.svg\"></p>\n<h2 id=\"安全护盾\"><a href=\"#安全护盾\" class=\"headerlink\" title=\"安全护盾\"></a>安全护盾</h2><blockquote>\n<p>Nginx <strong>反向代理</strong>的魅力：它隐藏了后端服务器的真实身份，把危险挡在门外。外界只知道 Nginx 的存在，不知道核心数据到底在哪。  </p>\n</blockquote>\n<p><img src=\"https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/4.svg\"></p>\n<h1 id=\"查看-nginx-进程\"><a href=\"#查看-nginx-进程\" class=\"headerlink\" title=\"查看 nginx 进程\"></a>查看 nginx 进程</h1><p><code>ps -ef | grep nginx</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@1769126960986:~# ps -ef | grep nginx</span><br><span class=\"line\">root     1335626 1335605  0 Feb01 ?        00:00:00 nginx: master process nginx -g daemon off;</span><br><span class=\"line\">message+ 1341281 1335626  0 Feb01 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">message+ 1341282 1335626  0 Feb01 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">message+ 1341283 1335626  0 Feb01 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">message+ 1341284 1335626  0 Feb01 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">root     1538084 1536452  0 00:01 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"nginx-进程模型\"><a href=\"#nginx-进程模型\" class=\"headerlink\" title=\"nginx 进程模型\"></a>nginx 进程模型</h1><p><strong>master</strong>：nginx 的主进程，负责读取和验证配置文件，管理 worker 进程</p>\n<p><strong>worker</strong>：nginx 的工作进程，负责处理实际的请求</p>\n<p><code>master</code>只有一个，<code>worker</code>可以有很多个，他们之间的关系就像老板和员工</p>\n<p><code>worker</code>进程的数量可以通过配置文件来调整</p>\n<h1 id=\"nginx-启停\"><a href=\"#nginx-启停\" class=\"headerlink\" title=\"nginx 启停\"></a>nginx 启停</h1><p><code>nginx -s signal</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -s signal</span><br><span class=\"line\">quit:\t优雅停止</span><br><span class=\"line\">stop:\t立即停止</span><br><span class=\"line\">reload: 重载配置文件</span><br><span class=\"line\">reopen: 重新打开日志文件</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"nginx-快速部署静态文件\"><a href=\"#nginx-快速部署静态文件\" class=\"headerlink\" title=\"nginx 快速部署静态文件\"></a>nginx 快速部署静态文件</h1><p>通过<code>nginx -V</code> 和 <code>nginx -t</code>来查看 nginx 配置文件路径</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.nginx -V</span><br><span class=\"line\">--http-client-body-temp-path=/var/lib/nginx/body </span><br><span class=\"line\">--http-fastcgi-temp-path=/var/lib/nginx/fastcgi </span><br><span class=\"line\">--http-proxy-temp-path=/var/lib/nginx/proxy </span><br><span class=\"line\">--http-scgi-temp-path=/var/lib/nginx/scgi </span><br><span class=\"line\">--http-uwsgi-temp-path=/var/lib/nginx/uwsgi </span><br><span class=\"line\">--with-compat --with-debug --with-pcre-jit --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_v2_module --with-http_dav_module --with-http_slice_module --with-threads --with-http_addition_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_secure_link_module --with-http_sub_module --with-mail_ssl_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-stream_realip_module --with-http_geoip_module=dynamic --with-http_image_filter_module=dynamic --with-http_perl_module=dynamic --with-http_xslt_module=dynamic --with-mail=dynamic --with-stream=dynamic --with-stream_geoip_module=dynamic=</span><br><span class=\"line\"></span><br><span class=\"line\">2.nginx -t</span><br><span class=\"line\">root@1769126960986:~# nginx -t</span><br><span class=\"line\">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class=\"line\">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n","excerpt":"","more":"<blockquote>\n<p>Nginx 是一个高性能的 Web 服务器，主要负责处理客户端（浏览器）和后端服务器（应用）之间的通信。  </p>\n</blockquote>\n<h1 id=\"用途\"><a href=\"#用途\" class=\"headerlink\" title=\"用途\"></a>用途</h1><blockquote>\n<p>nginx 最核心的三大用途</p>\n<ul>\n<li>反向代理</li>\n<li>负载均衡</li>\n<li>静态资源服务</li>\n</ul>\n</blockquote>\n<h2 id=\"反向代理\"><a href=\"#反向代理\" class=\"headerlink\" title=\"反向代理\"></a>反向代理</h2><ul>\n<li><strong>原理</strong>：用户访问网站时，其实是连接到 Nginx，由 Nginx 帮忙去后端获取数据再返回给用户。 </li>\n<li><strong>价值</strong>：<ul>\n<li><strong>安全</strong>：隐藏了后端服务器的真实 IP，保护核心数据。  </li>\n<li><strong>统一</strong>：所有请求由 Nginx 统一接管，便于管理。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"负载均衡\"><a href=\"#负载均衡\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h2><ul>\n<li><strong>原理：</strong>当访问量巨大时，Nginx 会按照规则（如轮询、权重）将请求平均分配给多台后端服务器。  </li>\n<li><strong>价值：</strong><ul>\n<li>**稳定： <strong>防止某一台服务器因流量过大而累死（宕机）</strong>。  **</li>\n<li><strong>高可用：</strong> 如果一台坏了，Nginx 自动把请求转给其他正常的服务器。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"动静分离\"><a href=\"#动静分离\" class=\"headerlink\" title=\"动静分离\"></a>动静分离</h2><ul>\n<li><strong>原理：</strong>将图片、CSS、JS、HTML 等不需要计算的静态文件，直接由 Nginx 快速返回，不经过后端应用服务器。 ** **</li>\n<li><strong>价值</strong>：<ul>\n<li><strong>提速：</strong>Nginx 处理静态文件的速度远超 Tomcat&#x2F;Python 等应用服务器。</li>\n<li><strong>减负：</strong>让昂贵的后端算力专心处理复杂的业务逻辑。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h2><p> 如果把一个 Web 系统比作一家<strong>火爆的餐厅</strong>，Nginx 扮演了以下角色：  </p>\n<table>\n<thead>\n<tr>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">功能</font></strong></th>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">类比角色</font></strong></th>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">解释</font></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">反向代理</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">服务员</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">顾客不需要进后厨找厨师，找服务员（Nginx）点菜即可。</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">负载均衡</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">领班</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">看到 1 号桌满了，领班（Nginx）带顾客去 2 号空桌，保证不拥堵。</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">静态服务</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">自助水吧</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">倒水这种简单事（静态资源），直接在水吧拿最快，不用麻烦大厨。</font></td>\n</tr>\n</tbody></table>\n<h1 id=\"正向代理和反向代理\"><a href=\"#正向代理和反向代理\" class=\"headerlink\" title=\"正向代理和反向代理\"></a>正向代理和反向代理</h1><blockquote>\n<p>这里需要区分一下正向代理和反向代理的区别</p>\n</blockquote>\n<p>⚔️ 正向代理 vs 反向代理</p>\n<ol>\n<li><strong>正向代理 (Forward Proxy)</strong><br>一句话概括：它是“客户端”的代理人。</li>\n</ol>\n<ul>\n<li><strong>也就是谁在用它？</strong> 用户（Client）主动使用的。</li>\n<li><strong>谁被隐藏了？</strong> <strong>用户（Client）</strong>。服务器只知道代理来访问了，不知道背后真正的用户是谁。</li>\n<li>生活通俗类比： 海外代购。<ul>\n<li>你想买某品牌的限量包（目标服务器），但你去不了那个国家。</li>\n<li>你找了一个代购（正向代理）。</li>\n<li>代购去店里买了包发给你。</li>\n<li><strong>结果：</strong> 品牌店只知道是“代购”买了包，完全不知道其实是你买的。</li>\n</ul>\n</li>\n<li><strong>典型用途：</strong><ul>\n<li><strong>科学上网 (VPN)：</strong>访问原本无法访问的网站。</li>\n<li><strong>公司内网监控：</strong>公司通过代理服务器上网，只允许员工访问特定网站。</li>\n</ul>\n</li>\n</ul>\n<ol start=\"2\">\n<li><strong>反向代理 (Reverse Proxy)</strong><br>一句话概括：它是“服务端”的代言人。</li>\n</ol>\n<ul>\n<li><strong>也就是谁在用它？</strong> 网站管理员（Server）部署的。</li>\n<li><strong>谁被隐藏了？</strong> <strong>服务器（Server）</strong>。用户只知道访问了代理的地址，不知道背后具体是哪台机器在处理。</li>\n<li>生活通俗类比： 打客服电话。<ul>\n<li>你有问题要咨询移动&#x2F;联通（客户端请求）。</li>\n<li>你拨打 10086（反向代理）。</li>\n<li>10086 系统会自动把你转接到具体的“工号 8823”客服人员（后端服务器）。</li>\n<li><strong>结果：</strong> 你只知道你打给了 10086，根本不知道（也不需要知道）是哪位具体的客服在服务你。</li>\n</ul>\n</li>\n<li><strong>典型用途：</strong><ul>\n<li><strong>Nginx 负载均衡：</strong>把流量分发给不同的服务器。</li>\n<li><strong>安全防护：</strong>作为防火墙，挡在核心数据库前面。</li>\n</ul>\n</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">特性</font></strong></th>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">正向代理 (Forward Proxy)</font></strong></th>\n<th><strong><font style=\"color:rgb(31, 31, 31);\">反向代理 (Reverse Proxy)</font></strong></th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">代理对象</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">客户端</font></strong><font style=\"color:rgb(31, 31, 31);\"> (Client)</font></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">服务端</font></strong><font style=\"color:rgb(31, 31, 31);\"> (Server)</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">架设方</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">用户自己（或公司IT）设置</font></td>\n<td><font style=\"color:rgb(31, 31, 31);\">网站管理员设置</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">谁被隐藏</font></strong></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">用户 IP</font></strong><font style=\"color:rgb(31, 31, 31);\"> 被隐藏</font></td>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">真实服务器 IP</font></strong><font style=\"color:rgb(31, 31, 31);\"> 被隐藏</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">感知度</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">用户</font><strong><font style=\"color:rgb(31, 31, 31);\">知道</font></strong><font style=\"color:rgb(31, 31, 31);\">自己在用代理</font></td>\n<td><font style=\"color:rgb(31, 31, 31);\">用户</font><strong><font style=\"color:rgb(31, 31, 31);\">不知道</font></strong><font style=\"color:rgb(31, 31, 31);\">自己在用代理</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">典型代表</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">VPN、梯子</font></td>\n<td><font style=\"color:rgb(31, 31, 31);\">Nginx、HAProxy</font></td>\n</tr>\n<tr>\n<td><strong><font style=\"color:rgb(31, 31, 31);\">方向</font></strong></td>\n<td><font style=\"color:rgb(31, 31, 31);\">出口 (Outbound)</font></td>\n<td><font style=\"color:rgb(31, 31, 31);\">入口 (Inbound)</font></td>\n</tr>\n</tbody></table>\n<h1 id=\"负载均衡-1\"><a href=\"#负载均衡-1\" class=\"headerlink\" title=\"负载均衡\"></a>负载均衡</h1><blockquote>\n<p>nginx 的负载均衡策略有两种</p>\n<ul>\n<li>内置策略</li>\n<li>扩展策略</li>\n</ul>\n</blockquote>\n<h2 id=\"1-什么是负载均衡？-The-Concept\"><a href=\"#1-什么是负载均衡？-The-Concept\" class=\"headerlink\" title=\"1. 什么是负载均衡？(The Concept)\"></a>1. 什么是负载均衡？(The Concept)</h2><p><strong>一句话</strong>：把所有的脏活累活（流量），平均分给那个“干活天团”（后端服务器集群），不让任何一个人累死。</p>\n<ul>\n<li><strong>核心目的</strong>：提升网站的吞吐量，增加稳定性（一台挂了还有别的）。</li>\n<li><strong>Nginx 的角色</strong>：它是那个<strong>分发任务的组长</strong>。</li>\n</ul>\n<hr>\n<h2 id=\"2-核心组件：Upstream-服务器池\"><a href=\"#2-核心组件：Upstream-服务器池\" class=\"headerlink\" title=\"2. 核心组件：Upstream (服务器池)\"></a>2. 核心组件：Upstream (服务器池)</h2><p>在 Nginx 里，你不能直接把任务指派给某一台机器，你得先定义一个“组”。这个组在配置文件里叫 <code>upstream</code>。</p>\n<ul>\n<li><strong>概念</strong>：把一堆服务器打包成一个“资源池”。</li>\n<li><strong>通俗理解</strong>：这是你的<strong>“后台工作小组”</strong>名单。</li>\n</ul>\n<hr>\n<h2 id=\"3-分配策略-调度算法\"><a href=\"#3-分配策略-调度算法\" class=\"headerlink\" title=\"3. 分配策略 (调度算法)\"></a>3. 分配策略 (调度算法)</h2><p>Nginx 这个“组长”怎么决定把下一个任务派给谁？它有几套不同的逻辑：</p>\n<h3 id=\"A-轮询-Round-Robin\"><a href=\"#A-轮询-Round-Robin\" class=\"headerlink\" title=\"A. 轮询 (Round Robin)\"></a>A. 轮询 (Round Robin)</h3><blockquote>\n<p><strong>默认策略</strong></p>\n</blockquote>\n<ul>\n<li><strong>逻辑</strong>：排排坐，吃果果。第一个请求给 A，第二个给 B，第三个给 C，第四个又给 A……</li>\n<li><strong>场景</strong>：后端服务器配置都差不多，大家众生平等。</li>\n</ul>\n<h3 id=\"B-权重-Weight\"><a href=\"#B-权重-Weight\" class=\"headerlink\" title=\"B. 权重 (Weight)\"></a>B. 权重 (Weight)</h3><blockquote>\n<p><strong>能力越大，责任越大</strong></p>\n</blockquote>\n<ul>\n<li><strong>逻辑</strong>：给服务器打分。配置高的机器（比如 8核 CPU），权重设高点；配置低的，权重设低点。</li>\n<li><strong>场景</strong>：新旧服务器混用，新机器更能打，就多干点活。<ul>\n<li><em>例子：Server A (权重3), Server B (权重1) -&gt; 4个请求里，A 处理 3 个，B 处理 1 个。</em></li>\n</ul>\n</li>\n</ul>\n<h3 id=\"C-IP-Hash-IP哈希\"><a href=\"#C-IP-Hash-IP哈希\" class=\"headerlink\" title=\"C. IP Hash (IP哈希)\"></a>C. IP Hash (IP哈希)</h3><blockquote>\n<p> <strong>专人专送</strong></p>\n</blockquote>\n<ul>\n<li><strong>逻辑</strong>：记仇（记人）。根据访客的 IP 地址计算。只要是你（同一个 IP）来的请求，永远固定发给同一台服务器。</li>\n<li><strong>场景</strong>：<strong>为了保持登录状态</strong>（Session）。<ul>\n<li><em>如果不用于此：</em> 你的请求一会儿飘到 A 服务器（有你的登录信息），一会儿飘到 B 服务器（没你的信息），你就会莫名其妙被踢下线。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"D-最少连接-Least-Conn\"><a href=\"#D-最少连接-Least-Conn\" class=\"headerlink\" title=\"D. 最少连接 (Least Conn)\"></a>D. 最少连接 (Least Conn)</h3><blockquote>\n<p><strong>谁闲给谁</strong></p>\n</blockquote>\n<ul>\n<li><strong>逻辑</strong>：Nginx 会看哪台服务器当前正在处理的连接数最少，就把新任务给它。</li>\n<li><strong>场景</strong>：有的请求处理很快，有的很慢。这个策略能保证不会有人在“摸鱼”，也不会有人被“累死”。</li>\n</ul>\n<hr>\n<h2 id=\"4-容灾与状态-Status-Failover\"><a href=\"#4-容灾与状态-Status-Failover\" class=\"headerlink\" title=\"4. 容灾与状态 (Status &amp; Failover)\"></a>4. 容灾与状态 (Status &amp; Failover)</h2><p>除了分发，Nginx 还能管理组员的状态。</p>\n<h3 id=\"A-Down-下线\"><a href=\"#A-Down-下线\" class=\"headerlink\" title=\"A. Down (下线)\"></a>A. Down (下线)</h3><ul>\n<li><strong>含义</strong>：告诉 Nginx 这台机器“请假了”。</li>\n<li><strong>作用</strong>：维护升级时，手动把它标记为 down，Nginx 就暂时不给它派活了。</li>\n</ul>\n<h3 id=\"B-Backup-备胎\"><a href=\"#B-Backup-备胎\" class=\"headerlink\" title=\"B. Backup (备胎)\"></a>B. Backup (备胎)</h3><ul>\n<li><strong>含义</strong>：这台机器平时不干活，在旁边歇着。</li>\n<li><strong>触发条件</strong>：只有当<strong>所有</strong>正常工作的机器都挂了（忙不过来了），这个“备胎”才会紧急启动接客。</li>\n</ul>\n<h3 id=\"C-自动剔除-Health-Check\"><a href=\"#C-自动剔除-Health-Check\" class=\"headerlink\" title=\"C. 自动剔除 (Health Check)\"></a>C. 自动剔除 (Health Check)</h3><ul>\n<li><strong>逻辑</strong>：如果你派给 Server A 的活它没接（超时或报错），Nginx 会自动把它标记为“不可用”，并在接下来的一段时间内跳过它。</li>\n<li><strong>通俗理解</strong>：发现员工生病了，组长自动准假，让他休息一会儿再来看看好了没。</li>\n</ul>\n<h1 id=\"动静分离-1\"><a href=\"#动静分离-1\" class=\"headerlink\" title=\"动静分离\"></a>动静分离</h1><blockquote>\n<p>为什么要做动静分离</p>\n<ul>\n<li><strong>🚀</strong>** 速度飞快**：Nginx 处理静态文件的能力比 Tomcat&#x2F;Django 强 10 倍以上，并发能力极强。</li>\n<li><strong>🔋</strong>** 给后端减负**：让昂贵的后端服务器专注于处理复杂的业务逻辑，不再被图片加载这种琐事占用内存和 CPU。</li>\n<li><strong>📂</strong>** 维护方便**：静态文件可以直接由前端工程师更新到 Nginx 目录下，不需要重启后端的应用服务。</li>\n</ul>\n</blockquote>\n<h2 id=\"1-核心概念：什么是“动”和“静”？\"><a href=\"#1-核心概念：什么是“动”和“静”？\" class=\"headerlink\" title=\"1. 核心概念：什么是“动”和“静”？\"></a>1. 核心概念：什么是“动”和“静”？</h2><p>在网站的世界里，资源分为两类：</p>\n<ul>\n<li><strong>🧱</strong>** 静态资源 (Static)**：<ul>\n<li><strong>特点</strong>：谁来访问都一样，不需要计算，拿走就能用。</li>\n<li><strong>例子</strong>：图片 (<code>.jpg</code>)、样式表 (<code>.css</code>)、脚本文件 (<code>.js</code>)、普通的 HTML 页面。</li>\n</ul>\n</li>\n<li><strong>⚙️</strong>** 动态资源 (Dynamic)**：<ul>\n<li><strong>特点</strong>：因人而异，需要经过服务器计算、查数据库才能生成。</li>\n<li><strong>例子</strong>：购物车数据、个人中心、搜索结果、API 接口。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"2-什么是“动静分离”？\"><a href=\"#2-什么是“动静分离”？\" class=\"headerlink\" title=\"2. 什么是“动静分离”？\"></a>2. 什么是“动静分离”？</h2><p><strong>一句话解释</strong>：把“搬运死文件”的粗活交给 <strong>Nginx</strong>，把“计算逻辑”的细活交给 <strong>后端应用服务器</strong>（如 Tomcat、Go、Python）。</p>\n<ul>\n<li><strong>不分离的情况（大锅饭）</strong>： 所有的请求（无论是看一张图，还是查账单）都丢给后端的 Tomcat 处理。Tomcat 既要算账又要搬图，累得半死，效率极低。</li>\n<li><strong>分离的情况（各司其职）</strong>：<ul>\n<li><strong>Nginx</strong>：站在最前面。如果是图片&#x2F;CSS，自己直接从硬盘读取返回（速度极快）。</li>\n<li><strong>后端</strong>：如果是复杂的业务逻辑，Nginx 再转发给 Tomcat&#x2F;Java 处理。</li>\n</ul>\n</li>\n</ul>\n<h1 id=\"从三个角度感受-Nginx\"><a href=\"#从三个角度感受-Nginx\" class=\"headerlink\" title=\"从三个角度感受 Nginx\"></a>从三个角度感受 Nginx</h1><h2 id=\"拯救混乱\"><a href=\"#拯救混乱\" class=\"headerlink\" title=\"拯救混乱\"></a>拯救混乱</h2><p><strong>没有 Nginx 的世界</strong></p>\n<blockquote>\n<p>所有用户直接拥挤到一台应用服务器上，服务器既要拿图片，又要算数据，还要抗并发，最终不堪重负。  </p>\n</blockquote>\n<p><img src=\"https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/1.svg\"></p>\n<p> <strong>有了 Nginx 的世界</strong></p>\n<blockquote>\n<p>Nginx 挡在最前面抗住压力，后端服务器只需专心干好自己的活，整个系统轻松扩容。  </p>\n</blockquote>\n<p><img src=\"https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/2.svg\"></p>\n<h2 id=\"极速分流\"><a href=\"#极速分流\" class=\"headerlink\" title=\"极速分流\"></a>极速分流</h2><blockquote>\n<p>Nginx <strong>动静分离</strong>的魅力：它能瞬间识别请求类型，让简单的请求走“高速公路”，复杂的请求走“普通车道”。  </p>\n</blockquote>\n<p><img src=\"https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/3.svg\"></p>\n<h2 id=\"安全护盾\"><a href=\"#安全护盾\" class=\"headerlink\" title=\"安全护盾\"></a>安全护盾</h2><blockquote>\n<p>Nginx <strong>反向代理</strong>的魅力：它隐藏了后端服务器的真实身份，把危险挡在门外。外界只知道 Nginx 的存在，不知道核心数据到底在哪。  </p>\n</blockquote>\n<p><img src=\"https://my-static-website-bucket.oss-cn-guangzhou.aliyuncs.com/4.svg\"></p>\n<h1 id=\"查看-nginx-进程\"><a href=\"#查看-nginx-进程\" class=\"headerlink\" title=\"查看 nginx 进程\"></a>查看 nginx 进程</h1><p><code>ps -ef | grep nginx</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@1769126960986:~# ps -ef | grep nginx</span><br><span class=\"line\">root     1335626 1335605  0 Feb01 ?        00:00:00 nginx: master process nginx -g daemon off;</span><br><span class=\"line\">message+ 1341281 1335626  0 Feb01 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">message+ 1341282 1335626  0 Feb01 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">message+ 1341283 1335626  0 Feb01 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">message+ 1341284 1335626  0 Feb01 ?        00:00:00 nginx: worker process</span><br><span class=\"line\">root     1538084 1536452  0 00:01 pts/1    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"nginx-进程模型\"><a href=\"#nginx-进程模型\" class=\"headerlink\" title=\"nginx 进程模型\"></a>nginx 进程模型</h1><p><strong>master</strong>：nginx 的主进程，负责读取和验证配置文件，管理 worker 进程</p>\n<p><strong>worker</strong>：nginx 的工作进程，负责处理实际的请求</p>\n<p><code>master</code>只有一个，<code>worker</code>可以有很多个，他们之间的关系就像老板和员工</p>\n<p><code>worker</code>进程的数量可以通过配置文件来调整</p>\n<h1 id=\"nginx-启停\"><a href=\"#nginx-启停\" class=\"headerlink\" title=\"nginx 启停\"></a>nginx 启停</h1><p><code>nginx -s signal</code></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -s signal</span><br><span class=\"line\">quit:\t优雅停止</span><br><span class=\"line\">stop:\t立即停止</span><br><span class=\"line\">reload: 重载配置文件</span><br><span class=\"line\">reopen: 重新打开日志文件</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"nginx-快速部署静态文件\"><a href=\"#nginx-快速部署静态文件\" class=\"headerlink\" title=\"nginx 快速部署静态文件\"></a>nginx 快速部署静态文件</h1><p>通过<code>nginx -V</code> 和 <code>nginx -t</code>来查看 nginx 配置文件路径</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.nginx -V</span><br><span class=\"line\">--http-client-body-temp-path=/var/lib/nginx/body </span><br><span class=\"line\">--http-fastcgi-temp-path=/var/lib/nginx/fastcgi </span><br><span class=\"line\">--http-proxy-temp-path=/var/lib/nginx/proxy </span><br><span class=\"line\">--http-scgi-temp-path=/var/lib/nginx/scgi </span><br><span class=\"line\">--http-uwsgi-temp-path=/var/lib/nginx/uwsgi </span><br><span class=\"line\">--with-compat --with-debug --with-pcre-jit --with-http_ssl_module --with-http_stub_status_module --with-http_realip_module --with-http_auth_request_module --with-http_v2_module --with-http_dav_module --with-http_slice_module --with-threads --with-http_addition_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_mp4_module --with-http_random_index_module --with-http_secure_link_module --with-http_sub_module --with-mail_ssl_module --with-stream_ssl_module --with-stream_ssl_preread_module --with-stream_realip_module --with-http_geoip_module=dynamic --with-http_image_filter_module=dynamic --with-http_perl_module=dynamic --with-http_xslt_module=dynamic --with-mail=dynamic --with-stream=dynamic --with-stream_geoip_module=dynamic=</span><br><span class=\"line\"></span><br><span class=\"line\">2.nginx -t</span><br><span class=\"line\">root@1769126960986:~# nginx -t</span><br><span class=\"line\">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</span><br><span class=\"line\">nginx: configuration file /etc/nginx/nginx.conf test is successful</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n"},{"title":"Hello World","_content":"Welcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","source":"_posts/hello-world.md","raw":"---\ntitle: Hello World\n---\nWelcome to [Hexo](https://hexo.io/)! This is your very first post. Check [documentation](https://hexo.io/docs/) for more info. If you get any problems when using Hexo, you can find the answer in [troubleshooting](https://hexo.io/docs/troubleshooting.html) or you can ask me on [GitHub](https://github.com/hexojs/hexo/issues).\n\n## Quick Start\n\n### Create a new post\n\n``` bash\n$ hexo new \"My New Post\"\n```\n\nMore info: [Writing](https://hexo.io/docs/writing.html)\n\n### Run server\n\n``` bash\n$ hexo server\n```\n\nMore info: [Server](https://hexo.io/docs/server.html)\n\n### Generate static files\n\n``` bash\n$ hexo generate\n```\n\nMore info: [Generating](https://hexo.io/docs/generating.html)\n\n### Deploy to remote sites\n\n``` bash\n$ hexo deploy\n```\n\nMore info: [Deployment](https://hexo.io/docs/one-command-deployment.html)\n","slug":"hello-world","published":1,"date":"2026-01-29T18:55:04.096Z","updated":"2026-01-29T18:55:04.096Z","comments":1,"layout":"post","photos":[],"_id":"cml85ywz900019znxfz55clyz","content":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n","excerpt":"","more":"<p>Welcome to <a href=\"https://hexo.io/\">Hexo</a>! This is your very first post. Check <a href=\"https://hexo.io/docs/\">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href=\"https://hexo.io/docs/troubleshooting.html\">troubleshooting</a> or you can ask me on <a href=\"https://github.com/hexojs/hexo/issues\">GitHub</a>.</p>\n<h2 id=\"Quick-Start\"><a href=\"#Quick-Start\" class=\"headerlink\" title=\"Quick Start\"></a>Quick Start</h2><h3 id=\"Create-a-new-post\"><a href=\"#Create-a-new-post\" class=\"headerlink\" title=\"Create a new post\"></a>Create a new post</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/writing.html\">Writing</a></p>\n<h3 id=\"Run-server\"><a href=\"#Run-server\" class=\"headerlink\" title=\"Run server\"></a>Run server</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/server.html\">Server</a></p>\n<h3 id=\"Generate-static-files\"><a href=\"#Generate-static-files\" class=\"headerlink\" title=\"Generate static files\"></a>Generate static files</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/generating.html\">Generating</a></p>\n<h3 id=\"Deploy-to-remote-sites\"><a href=\"#Deploy-to-remote-sites\" class=\"headerlink\" title=\"Deploy to remote sites\"></a>Deploy to remote sites</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n\n<p>More info: <a href=\"https://hexo.io/docs/one-command-deployment.html\">Deployment</a></p>\n"},{"title":"基于 Docker + Prometheus + Grafana 的全栈监控平台","date":"2026-01-31T12:31:00.000Z","_content":"# 基于 Docker + Prometheus + Grafana 的全栈监控平台\n## 1. 项目背景与架构\n+ **项目目标**：在单台云服务器上构建轻量级、高可用的运维监控体系，解决“服务器黑盒”问题，实现对主机硬件及 Docker 容器的实时监控。\n+ **技术栈**：Docker, Docker Compose, Prometheus, Grafana, Node Exporter, cAdvisor。\n+ **架构流向**：\n\n> 数据源 (Node Exporter/cAdvisor) -> 拉取存储 (Prometheus) -> 数据展示 (Grafana)\n>\n\n## 2. 环境准备\n确保服务器已安装 `Docker` 和 `Docker Compose`。\n\n```bash\n# 1. 创建统一的项目目录，遵循运维规范\nmkdir -p /opt/monitor/prometheus  # 存放 Prometheus 配置\nmkdir -p /opt/monitor/grafana     # 存放 Grafana 持久化数据\ncd /opt/monitor\n```\n\n## 3. 配置文件编写\n### 3.1 配置 Prometheus (`prometheus.yml`)\n创建并编辑 `/opt/monitor/prometheus/prometheus.yml`，定义数据抓取任务。\n\n```yaml\nglobal:\n  scrape_interval: 15s      # 全局抓取间隔\n  evaluation_interval: 15s\n\nscrape_configs:\n  # 1. 监控 Prometheus 自身\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n\n  # 2. 监控宿主机硬件 (Node Exporter)\n  - job_name: 'node_exporter'\n    static_configs:\n      - targets: ['node-exporter:9100']\n\n  # 3. 监控 Docker 容器资源 (cAdvisor)\n  - job_name: 'cadvisor'\n    static_configs:\n      - targets: ['cadvisor:8080']\n```\n\n### 3.2 编写编排文件 (`docker-compose.yml`)\n在 `/opt/monitor/` 下创建，一次性编排所有服务。\n\n```yaml\nversion: '3.8'\n\nservices:\n  # --- 核心数据库: Prometheus ---\n  prometheus:\n    image: prom/prometheus:latest\n    container_name: prometheus\n    restart: always\n    volumes:\n      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml\n      - prometheus_data:/prometheus\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n      - '--storage.tsdb.retention.time=15d' # 数据保留15天\n    ports:\n      - \"9090:9090\"\n    networks:\n      - monitor-net\n\n  # --- 可视化面板: Grafana ---\n  grafana:\n    image: grafana/grafana:latest\n    container_name: grafana\n    restart: always\n    volumes:\n      - grafana_data:/var/lib/grafana\n    environment:\n      - GF_SECURITY_ADMIN_PASSWORD=admin # 初始密码\n    ports:\n      - \"3000:3000\"\n    networks:\n      - monitor-net\n\n  # --- 宿主机采集器: Node Exporter ---\n  node-exporter:\n    image: prom/node-exporter:latest\n    container_name: node-exporter\n    restart: always\n    ports:\n      - \"9100:9100\"\n    volumes:\n      - /proc:/host/proc:ro\n      - /sys:/host/sys:ro\n      - /:/rootfs:ro\n    command:\n      - '--path.procfs=/host/proc'\n      - '--path.sysfs=/host/sys'\n      - '--path.rootfs=/rootfs'\n    networks:\n      - monitor-net\n\n  # --- 容器采集器: cAdvisor ---\n  cadvisor:\n    image: zcube/cadvisor:latest\n    container_name: cadvisor\n    restart: always\n    privileged: true\n    ports:\n      - \"8080:8080\"\n    devices:\n      - /dev/kmsg\n    volumes:\n      - /:/rootfs:ro\n      - /var/run:/var/run:ro\n      - /sys:/sys:ro\n      - /var/lib/docker/:/var/lib/docker:ro\n      - /dev/disk/:/dev/disk:ro\n      - /sys/fs/cgroup:/sys/fs/cgroup:ro\n    networks:\n      - monitor-net\n\nvolumes:\n  prometheus_data:\n  grafana_data:\n\nnetworks:\n  monitor-net:\n```\n\n## 4. 部署与启动\n```bash\n# 在 /opt/monitor 目录下执行\ndocker compose up -d\n\n# 检查运行状态（确保所有 State 均为 Up）\ndocker compose ps\n```\n\n## 5. Grafana 深度配置与可视化\n访问地址：`http://<服务器IP>:3000` (账号/密码: admin/admin)\n\n### 5.1 设置中文界面\n1. 进入 **Profile (个人资料)** -> **Preferences**。\n2. **Language** 选择 **简体中文** -> Save。\n\n### 5.2 配置数据源\n1. 左侧菜单 -> **连接** -> **数据源** -> **Add new data source**。\n2. 选择 **Prometheus**。\n3. **Connection URL** 填写：`http://prometheus:9090` (利用 Docker 内部 DNS 解析)。\n4. 点击底部 **Save & Test**，出现绿色提示即成功。\n\n### 5.3 导入核心仪表盘\n左侧菜单 -> **仪表盘** -> **导入 (Import)**，输入以下 ID 并加载：\n\n| 监控维度 | 推荐模板 ID | 关键指标 |\n| --- | --- | --- |\n| **宿主机监控** (Node Exporter) | **8919** | CPU 核数负载、内存明细、磁盘 I/O 读写、网络上下行流量 |\n| **Docker 容器监控** (cAdvisor) | **14282** (或 193) | 单容器 CPU 使用率、单容器内存占用、网络流量排行 |\n\n\n> **注意**：导入时在底部的 Data Source 选项中，务必选择刚刚创建的 Prometheus 数据源。\n>\n\n## 6. 基于 Alertmanager 的自动化告警闭环\n> 为了实现 7*24 小时无人值守监控，我们引入 Alertmanager 组件\n>\n\n流程：Prometheus (发现异常) -> Push -> Alertmanager (去重、分组、路由) -> Send -> Email (管理员)。\n\n### 6.1 配置文件编写\n#### 6.1.1 创建告警规则 (`rules.yml`)\n在 /opt/monitor/prometheus/ 目录下创建 `rules.yml`，定义什么样的指标属于“故障”。\n\n```bash\ngroups:\n  - name: host_monitoring\n    rules:\n    - alert: HostCpuUsageTooHigh\n      # 表达式含义：(1 - 空闲率) * 100 > 50%\n      expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[1m])) * 100) > 50\n      for: 1m  # 持续 1 分钟才报警，避免抖动误报\n      labels:\n        severity: warning\n      annotations:\n        summary: \"主机 {{ $labels.instance }} CPU 负载过高\"\n        description: \"当前 CPU 使用率已超过 50% (当前值: {{ $value | printf \\\"%.2f\\\" }}%)\"\n```\n\n#### 6.1.2 配置 Alertmanager (`config.yml`)\n创建目录 `/opt/monitor/alertmanager `并新建`config.yml`。\n\n> 注意：此处以 QQ 邮箱为例，密码必须使用 SMTP 授权码。\n>\n\n```bash\nglobal:\n  resolve_timeout: 5m\n  smtp_smarthost: 'smtp.qq.com:465'      # SMTP 服务器\n  smtp_from: '你的邮箱@qq.com'           # 发件人\n  smtp_auth_username: '你的邮箱@qq.com'  # 账号\n  smtp_auth_password: '你的授权码'       # 授权码 (非登录密码)\n  smtp_require_tls: false                # 465端口通常为false\n\nroute:\n  group_by: ['alertname']\n  group_wait: 10s\n  group_interval: 10s\n  repeat_interval: 1h       # 报警未解决，1小时后重发\n  receiver: 'email-receiver'\n\nreceivers:\n  - name: 'email-receiver'\n    email_configs:\n      - to: '接收者邮箱@example.com'\n        send_resolved: true # 故障恢复后发送通知\n        headers:\n          Subject: \"【云服务器告警】 {{ .CommonAnnotations.summary }}\"\n```\n\n#### 6.1.3 关联 Prometheus\n修改 `/opt/monitor/prometheus/prometheus.yml`，加入规则文件和 Alertmanager 地址\n\n```bash\n# 在 global 块之后添加\nrule_files:\n  - \"rules.yml\"  # 引用刚刚写的规则文件\n\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets: ['alertmanager:9093']\n```\n\n### 6.2 服务编排更新 (`docker-compose.yml`)\n修改 `/opt/monitor/docker-compose.yml`，新增 Alertmanager 服务，并更新 Prometheus 的挂载。\n\n```bash\nservices:\n  # ... (其他服务保持不变) ...\n  prometheus:\n    # ... (image, ports 等保持不变) ...\n    volumes:\n      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml\n      - ./prometheus/rules.yml:/etc/prometheus/rules.yml  # <--- 新增：挂载规则文件\n      - prometheus_data:/prometheus\n\n  # --- 新增服务: 告警中心 ---\n  alertmanager:\n    image: prom/alertmanager:latest\n    container_name: alertmanager\n    restart: always\n    volumes:\n      # ⚠️ 关键点：将本地 config.yml 强制挂载为容器内的 alertmanager.yml 以覆盖默认配置\n      - ./alertmanager/config.yml:/etc/alertmanager/alertmanager.yml\n    ports:\n      - \"9093:9093\"\n    networks:\n      - monitor-net\n```\n\n### 6.3 部署验证\n#### 6.3.1 重启服务\n由于修改了挂载卷配置，建议先删除旧容器再启动：\n\n```bash\ncd /opt/monitor\ndocker compose down\ndocker compose up -d\n```\n\n#### 6.3.2 压力测试（验证告警）\n安装压力测试工具 stress，模拟 CPU 飙升场景\n\n```bash\n# 模拟 2 个核满载，持续 120 秒\nstress -c 2 -t 120\n```\n\n#### 6.3.3 观察流程\n+ **触发**：Prometheus 界面 (Status -> Alerts) 中，`HostCpuUsageTooHigh` 状态由 Green -> Yellow (Pending) -> Red (Firing)。\n+ **发送**：Alertmanager 收到 Firing 信号，处理后投递邮件。\n+ **恢复**：stress 结束后，收到标题带 [Resolved] 的恢复邮件。\n\n### 6.4 常见问题排查\n+ **问题 1：**Alertmanager 报错 connection refused 127.0.0.1:5001。\n    - 原因：配置文件挂载路径错误，导致容器读取了镜像自带的默认配置（默认配置是指向本地 webhook 的）。\n    - 解决：确保 docker-compose 中挂载目标路径为 `/etc/alertmanager/alertmanager.yml`。\n+ **问题 2：**邮件发送失败 535 Authentication failed。\n    - 原因：使用了邮箱登录密码，而非 SMTP 专用授权码。\n+ **问题 3：**容器无法联网 i/o timeout。\n    - 原因：Docker DNS 配置问题或云服务器安全组未放行。\n+ **问题 4：**cAdvisor 报错 mountpoint for cpu not found \n    - 原因：ubuntu 24.04 默认启用 **Cgroup** **v2**，而 docler hub 上的 cadvisor 旧版本只支持 **Cgroup** **v1**\n    - **解决：**通过更改 **zcube/cadvisor** 镜像并配置 **privileged** 模式解决版本兼容性问题\n\n## 7. 基于 PLG 的轻量级日志分析\n> 为了解决“出现故障需要登录服务器一条条查 logs”的低效问题，引入 PLG 技术栈 (Promtail + Loki + Grafana)。\n>\n\n+ 优势：相比 ELK (Elasticsearch)，Loki 不建立全文索引，仅索引元数据（标签），内存占用极低，非常适合云服务器单机环境。\n+ 流向：Promtail (自动发现容器) -> 采集日志 -> Loki (存储与索引) -> Grafana (统一查询)。\n\n### 7.1 配置文件编写\n首先创建日志组件的专用目录：\n\n```yaml\nmkdir -p /opt/monitor/loki\nmkdir -p /opt/monitor/promtail\n```\n\n#### 7.1.1 配置 Loki 存储端 (`loki-config.yaml`)\n创建`/opt/monitor/loki/loki-config.yaml`，定义日志如何存储。采用本地文件系统存储，简单高效。\n\n```yaml\nauth_enabled: false\n\nserver:\n  http_listen_port: 3100\n\ncommon:\n  path_prefix: /loki\n  storage:\n    filesystem:\n      chunks_directory: /loki/chunks\n      rules_directory: /loki/rules\n  replication_factor: 1\n  ring:\n    instance_addr: 127.0.0.1\n    kvstore:\n      store: inmemory\n\nschema_config:\n  configs:\n    - from: 2020-10-24\n      store: tsdb\n      object_store: filesystem\n      schema: v13\n      index:\n        prefix: index_\n        period: 24h\n```\n\n#### 7.1.2 配置 Promtail 采集端 (`promtail-config.yaml`)\n创建 `/opt/monitor/promtail/promtail-config.yaml`。、\n\n> 核心逻辑：通过挂载 Docker Socket，自动发现当前运行的所有容器，并利用 relabel 机制将 Docker 内部名称格式化为易读的标签。\n>\n\n```yaml\nserver:\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /tmp/positions.yaml # 记录采集游标，防止重启后日志重复或丢失\n\nclients:\n  - url: http://loki:3100/loki/api/v1/push # 推送给 Loki\n\nscrape_configs:\n  - job_name: system\n    docker_sd_configs:\n      - host: unix:///var/run/docker.sock # 监听 Docker 事件\n        refresh_interval: 5s\n    relabel_configs:\n      # 只保留有名称的容器\n      - source_labels: ['__meta_docker_container_name']\n        regex: '/(.*)'\n        target_label: 'container' # 重命名标签为 container，方便检索\n```\n\n### 7.2 服务编排更新 (`docker-compose.yml`)\n编辑 `/opt/monitor/docker-compose.yml`，新增 Loki 和 Promtail 服务，并挂载必要的数据卷。\n\n```yaml\nservices:\n  # ... (之前的 Prometheus, Grafana, Alertmanager 等保持不变) ...\n\n  # --- 新增: 日志存储 Loki ---\n  loki:\n    image: grafana/loki:latest\n    container_name: loki\n    restart: always\n    volumes:\n      - ./loki/loki-config.yaml:/etc/loki/local-config.yaml\n      - loki_data:/loki\n    ports:\n      - \"3100:3100\"\n    networks:\n      - monitor-net\n\n  # --- 新增: 日志采集 Promtail ---\n  promtail:\n    image: grafana/promtail:latest\n    container_name: promtail\n    restart: always\n    volumes:\n      - ./promtail/promtail-config.yaml:/etc/promtail/config.yml\n      # ⚠️ 关键挂载 1: 允许 Promtail 访问 Docker 守护进程以发现容器\n      - /var/run/docker.sock:/var/run/docker.sock\n      # ⚠️ 关键挂载 2: 允许 Promtail 读取实际的日志文件 (只读模式)\n      - /var/lib/docker/containers:/var/lib/docker/containers:ro\n    networks:\n      - monitor-net\n\nvolumes:\n  prometheus_data:\n  grafana_data:\n  loki_data: # <--- 别忘了新增这个卷用于持久化日志\n\nnetworks:\n  monitor-net:\n```\n\n### 7.3 部署与 Grafana 配置\n#### 7.3.1 重启服务\n```yaml\ncd /opt/monitor\ndocker compose up -d\n# 检查 loki 和 promtail 状态是否为 Up\ndocker compose ps\n```\n\n#### 7.3.2 在 Grafana 接入数据源\n+ 登录 Grafana -> Connections -> Data sources -> Add new data source。\n+ 选择 Loki。\n+ URL 填写：[http://loki:3100。](http://loki:3100。)\n+ 点击 Save & Test，出现绿色提示 \"Data source connected\" 即成功。\n\n### 7.4 如何进行日志排查\n+ 进入 Grafana 左侧菜单 Explore (探索)。\n+ 顶部数据源选择 Loki。\n+ Label filters 选择 container = 你的应用容器名 (例如 cadvisor)。\n+ 点击 Run query。\n+ 效果：可以看到实时的应用日志流。配合 Live 按钮，可以像在终端使用 `tail -f` 一样监控线上日志。\n\n---\n\n## 8. 简历上的项目描述\n**项目名称：基于 Docker 的云服务器监控平台**\n\n**项目描述：**  \n针对单体云服务器缺乏可视化监控、故障排查困难的问题，基于 Docker 搭建了一套标准化的监控告警系统。实现了从硬件层到应用容器层的全方位可观测性。\n\n**操作系统**：Ubuntu 24.04\n\n**技术栈**：Docker + Prometheus + Grafana + Alertmanager + cAdvisor + Loki + Promtail \n\n**核心技术：**\n\n+ **容器化基础设施**：使用 **Docker Compose** 统一编排 **Prometheus、Grafana、Loki** 等 6 个服务组件，实现了“一键拉起”的标准化部署环境。\n+ **多维度监控**：通过 **Node Exporter** 采集宿主机 CPU 使用率、磁盘 IO 等核心指标；引入 **cAdvisor** 解决了 Docker 容器资源隔离不可见的问题，实现了对单容器内存泄漏的实时监测。\n+ **可视化监控**：基于 **Grafana** 自定义监控仪表盘，配置了 **Prometheus 数据源**，实现了服务器资源使用率的秒级刷新展示。\n+ **自动化告警**：编写 PromQL 规则（如 CPU > 90%），结合 **Alertmanager **实现了邮件实时告警，经**压测**验证，平均故障响应时间缩短至 2 分钟以内\n+ **日志聚合分析：**引入**Promtail + Loki + Grafana **技术栈，实现 docker 容器日志的自动化采集和聚合，与传统 ELK 方案相比，资源占用更低\n\n---\n\n","source":"_posts/基于 Docker + Prometheus + Grafana 的全栈监控平台.md","raw":"---\ntitle: 基于 Docker + Prometheus + Grafana 的全栈监控平台\ndate: 2026-01-31 20:31:00\ntags:\n    - 教程\n    - Docker\ncategories: 系统搭建\n---\n# 基于 Docker + Prometheus + Grafana 的全栈监控平台\n## 1. 项目背景与架构\n+ **项目目标**：在单台云服务器上构建轻量级、高可用的运维监控体系，解决“服务器黑盒”问题，实现对主机硬件及 Docker 容器的实时监控。\n+ **技术栈**：Docker, Docker Compose, Prometheus, Grafana, Node Exporter, cAdvisor。\n+ **架构流向**：\n\n> 数据源 (Node Exporter/cAdvisor) -> 拉取存储 (Prometheus) -> 数据展示 (Grafana)\n>\n\n## 2. 环境准备\n确保服务器已安装 `Docker` 和 `Docker Compose`。\n\n```bash\n# 1. 创建统一的项目目录，遵循运维规范\nmkdir -p /opt/monitor/prometheus  # 存放 Prometheus 配置\nmkdir -p /opt/monitor/grafana     # 存放 Grafana 持久化数据\ncd /opt/monitor\n```\n\n## 3. 配置文件编写\n### 3.1 配置 Prometheus (`prometheus.yml`)\n创建并编辑 `/opt/monitor/prometheus/prometheus.yml`，定义数据抓取任务。\n\n```yaml\nglobal:\n  scrape_interval: 15s      # 全局抓取间隔\n  evaluation_interval: 15s\n\nscrape_configs:\n  # 1. 监控 Prometheus 自身\n  - job_name: 'prometheus'\n    static_configs:\n      - targets: ['localhost:9090']\n\n  # 2. 监控宿主机硬件 (Node Exporter)\n  - job_name: 'node_exporter'\n    static_configs:\n      - targets: ['node-exporter:9100']\n\n  # 3. 监控 Docker 容器资源 (cAdvisor)\n  - job_name: 'cadvisor'\n    static_configs:\n      - targets: ['cadvisor:8080']\n```\n\n### 3.2 编写编排文件 (`docker-compose.yml`)\n在 `/opt/monitor/` 下创建，一次性编排所有服务。\n\n```yaml\nversion: '3.8'\n\nservices:\n  # --- 核心数据库: Prometheus ---\n  prometheus:\n    image: prom/prometheus:latest\n    container_name: prometheus\n    restart: always\n    volumes:\n      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml\n      - prometheus_data:/prometheus\n    command:\n      - '--config.file=/etc/prometheus/prometheus.yml'\n      - '--storage.tsdb.retention.time=15d' # 数据保留15天\n    ports:\n      - \"9090:9090\"\n    networks:\n      - monitor-net\n\n  # --- 可视化面板: Grafana ---\n  grafana:\n    image: grafana/grafana:latest\n    container_name: grafana\n    restart: always\n    volumes:\n      - grafana_data:/var/lib/grafana\n    environment:\n      - GF_SECURITY_ADMIN_PASSWORD=admin # 初始密码\n    ports:\n      - \"3000:3000\"\n    networks:\n      - monitor-net\n\n  # --- 宿主机采集器: Node Exporter ---\n  node-exporter:\n    image: prom/node-exporter:latest\n    container_name: node-exporter\n    restart: always\n    ports:\n      - \"9100:9100\"\n    volumes:\n      - /proc:/host/proc:ro\n      - /sys:/host/sys:ro\n      - /:/rootfs:ro\n    command:\n      - '--path.procfs=/host/proc'\n      - '--path.sysfs=/host/sys'\n      - '--path.rootfs=/rootfs'\n    networks:\n      - monitor-net\n\n  # --- 容器采集器: cAdvisor ---\n  cadvisor:\n    image: zcube/cadvisor:latest\n    container_name: cadvisor\n    restart: always\n    privileged: true\n    ports:\n      - \"8080:8080\"\n    devices:\n      - /dev/kmsg\n    volumes:\n      - /:/rootfs:ro\n      - /var/run:/var/run:ro\n      - /sys:/sys:ro\n      - /var/lib/docker/:/var/lib/docker:ro\n      - /dev/disk/:/dev/disk:ro\n      - /sys/fs/cgroup:/sys/fs/cgroup:ro\n    networks:\n      - monitor-net\n\nvolumes:\n  prometheus_data:\n  grafana_data:\n\nnetworks:\n  monitor-net:\n```\n\n## 4. 部署与启动\n```bash\n# 在 /opt/monitor 目录下执行\ndocker compose up -d\n\n# 检查运行状态（确保所有 State 均为 Up）\ndocker compose ps\n```\n\n## 5. Grafana 深度配置与可视化\n访问地址：`http://<服务器IP>:3000` (账号/密码: admin/admin)\n\n### 5.1 设置中文界面\n1. 进入 **Profile (个人资料)** -> **Preferences**。\n2. **Language** 选择 **简体中文** -> Save。\n\n### 5.2 配置数据源\n1. 左侧菜单 -> **连接** -> **数据源** -> **Add new data source**。\n2. 选择 **Prometheus**。\n3. **Connection URL** 填写：`http://prometheus:9090` (利用 Docker 内部 DNS 解析)。\n4. 点击底部 **Save & Test**，出现绿色提示即成功。\n\n### 5.3 导入核心仪表盘\n左侧菜单 -> **仪表盘** -> **导入 (Import)**，输入以下 ID 并加载：\n\n| 监控维度 | 推荐模板 ID | 关键指标 |\n| --- | --- | --- |\n| **宿主机监控** (Node Exporter) | **8919** | CPU 核数负载、内存明细、磁盘 I/O 读写、网络上下行流量 |\n| **Docker 容器监控** (cAdvisor) | **14282** (或 193) | 单容器 CPU 使用率、单容器内存占用、网络流量排行 |\n\n\n> **注意**：导入时在底部的 Data Source 选项中，务必选择刚刚创建的 Prometheus 数据源。\n>\n\n## 6. 基于 Alertmanager 的自动化告警闭环\n> 为了实现 7*24 小时无人值守监控，我们引入 Alertmanager 组件\n>\n\n流程：Prometheus (发现异常) -> Push -> Alertmanager (去重、分组、路由) -> Send -> Email (管理员)。\n\n### 6.1 配置文件编写\n#### 6.1.1 创建告警规则 (`rules.yml`)\n在 /opt/monitor/prometheus/ 目录下创建 `rules.yml`，定义什么样的指标属于“故障”。\n\n```bash\ngroups:\n  - name: host_monitoring\n    rules:\n    - alert: HostCpuUsageTooHigh\n      # 表达式含义：(1 - 空闲率) * 100 > 50%\n      expr: 100 - (avg by (instance) (rate(node_cpu_seconds_total{mode=\"idle\"}[1m])) * 100) > 50\n      for: 1m  # 持续 1 分钟才报警，避免抖动误报\n      labels:\n        severity: warning\n      annotations:\n        summary: \"主机 {{ $labels.instance }} CPU 负载过高\"\n        description: \"当前 CPU 使用率已超过 50% (当前值: {{ $value | printf \\\"%.2f\\\" }}%)\"\n```\n\n#### 6.1.2 配置 Alertmanager (`config.yml`)\n创建目录 `/opt/monitor/alertmanager `并新建`config.yml`。\n\n> 注意：此处以 QQ 邮箱为例，密码必须使用 SMTP 授权码。\n>\n\n```bash\nglobal:\n  resolve_timeout: 5m\n  smtp_smarthost: 'smtp.qq.com:465'      # SMTP 服务器\n  smtp_from: '你的邮箱@qq.com'           # 发件人\n  smtp_auth_username: '你的邮箱@qq.com'  # 账号\n  smtp_auth_password: '你的授权码'       # 授权码 (非登录密码)\n  smtp_require_tls: false                # 465端口通常为false\n\nroute:\n  group_by: ['alertname']\n  group_wait: 10s\n  group_interval: 10s\n  repeat_interval: 1h       # 报警未解决，1小时后重发\n  receiver: 'email-receiver'\n\nreceivers:\n  - name: 'email-receiver'\n    email_configs:\n      - to: '接收者邮箱@example.com'\n        send_resolved: true # 故障恢复后发送通知\n        headers:\n          Subject: \"【云服务器告警】 {{ .CommonAnnotations.summary }}\"\n```\n\n#### 6.1.3 关联 Prometheus\n修改 `/opt/monitor/prometheus/prometheus.yml`，加入规则文件和 Alertmanager 地址\n\n```bash\n# 在 global 块之后添加\nrule_files:\n  - \"rules.yml\"  # 引用刚刚写的规则文件\n\nalerting:\n  alertmanagers:\n    - static_configs:\n        - targets: ['alertmanager:9093']\n```\n\n### 6.2 服务编排更新 (`docker-compose.yml`)\n修改 `/opt/monitor/docker-compose.yml`，新增 Alertmanager 服务，并更新 Prometheus 的挂载。\n\n```bash\nservices:\n  # ... (其他服务保持不变) ...\n  prometheus:\n    # ... (image, ports 等保持不变) ...\n    volumes:\n      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml\n      - ./prometheus/rules.yml:/etc/prometheus/rules.yml  # <--- 新增：挂载规则文件\n      - prometheus_data:/prometheus\n\n  # --- 新增服务: 告警中心 ---\n  alertmanager:\n    image: prom/alertmanager:latest\n    container_name: alertmanager\n    restart: always\n    volumes:\n      # ⚠️ 关键点：将本地 config.yml 强制挂载为容器内的 alertmanager.yml 以覆盖默认配置\n      - ./alertmanager/config.yml:/etc/alertmanager/alertmanager.yml\n    ports:\n      - \"9093:9093\"\n    networks:\n      - monitor-net\n```\n\n### 6.3 部署验证\n#### 6.3.1 重启服务\n由于修改了挂载卷配置，建议先删除旧容器再启动：\n\n```bash\ncd /opt/monitor\ndocker compose down\ndocker compose up -d\n```\n\n#### 6.3.2 压力测试（验证告警）\n安装压力测试工具 stress，模拟 CPU 飙升场景\n\n```bash\n# 模拟 2 个核满载，持续 120 秒\nstress -c 2 -t 120\n```\n\n#### 6.3.3 观察流程\n+ **触发**：Prometheus 界面 (Status -> Alerts) 中，`HostCpuUsageTooHigh` 状态由 Green -> Yellow (Pending) -> Red (Firing)。\n+ **发送**：Alertmanager 收到 Firing 信号，处理后投递邮件。\n+ **恢复**：stress 结束后，收到标题带 [Resolved] 的恢复邮件。\n\n### 6.4 常见问题排查\n+ **问题 1：**Alertmanager 报错 connection refused 127.0.0.1:5001。\n    - 原因：配置文件挂载路径错误，导致容器读取了镜像自带的默认配置（默认配置是指向本地 webhook 的）。\n    - 解决：确保 docker-compose 中挂载目标路径为 `/etc/alertmanager/alertmanager.yml`。\n+ **问题 2：**邮件发送失败 535 Authentication failed。\n    - 原因：使用了邮箱登录密码，而非 SMTP 专用授权码。\n+ **问题 3：**容器无法联网 i/o timeout。\n    - 原因：Docker DNS 配置问题或云服务器安全组未放行。\n+ **问题 4：**cAdvisor 报错 mountpoint for cpu not found \n    - 原因：ubuntu 24.04 默认启用 **Cgroup** **v2**，而 docler hub 上的 cadvisor 旧版本只支持 **Cgroup** **v1**\n    - **解决：**通过更改 **zcube/cadvisor** 镜像并配置 **privileged** 模式解决版本兼容性问题\n\n## 7. 基于 PLG 的轻量级日志分析\n> 为了解决“出现故障需要登录服务器一条条查 logs”的低效问题，引入 PLG 技术栈 (Promtail + Loki + Grafana)。\n>\n\n+ 优势：相比 ELK (Elasticsearch)，Loki 不建立全文索引，仅索引元数据（标签），内存占用极低，非常适合云服务器单机环境。\n+ 流向：Promtail (自动发现容器) -> 采集日志 -> Loki (存储与索引) -> Grafana (统一查询)。\n\n### 7.1 配置文件编写\n首先创建日志组件的专用目录：\n\n```yaml\nmkdir -p /opt/monitor/loki\nmkdir -p /opt/monitor/promtail\n```\n\n#### 7.1.1 配置 Loki 存储端 (`loki-config.yaml`)\n创建`/opt/monitor/loki/loki-config.yaml`，定义日志如何存储。采用本地文件系统存储，简单高效。\n\n```yaml\nauth_enabled: false\n\nserver:\n  http_listen_port: 3100\n\ncommon:\n  path_prefix: /loki\n  storage:\n    filesystem:\n      chunks_directory: /loki/chunks\n      rules_directory: /loki/rules\n  replication_factor: 1\n  ring:\n    instance_addr: 127.0.0.1\n    kvstore:\n      store: inmemory\n\nschema_config:\n  configs:\n    - from: 2020-10-24\n      store: tsdb\n      object_store: filesystem\n      schema: v13\n      index:\n        prefix: index_\n        period: 24h\n```\n\n#### 7.1.2 配置 Promtail 采集端 (`promtail-config.yaml`)\n创建 `/opt/monitor/promtail/promtail-config.yaml`。、\n\n> 核心逻辑：通过挂载 Docker Socket，自动发现当前运行的所有容器，并利用 relabel 机制将 Docker 内部名称格式化为易读的标签。\n>\n\n```yaml\nserver:\n  http_listen_port: 9080\n  grpc_listen_port: 0\n\npositions:\n  filename: /tmp/positions.yaml # 记录采集游标，防止重启后日志重复或丢失\n\nclients:\n  - url: http://loki:3100/loki/api/v1/push # 推送给 Loki\n\nscrape_configs:\n  - job_name: system\n    docker_sd_configs:\n      - host: unix:///var/run/docker.sock # 监听 Docker 事件\n        refresh_interval: 5s\n    relabel_configs:\n      # 只保留有名称的容器\n      - source_labels: ['__meta_docker_container_name']\n        regex: '/(.*)'\n        target_label: 'container' # 重命名标签为 container，方便检索\n```\n\n### 7.2 服务编排更新 (`docker-compose.yml`)\n编辑 `/opt/monitor/docker-compose.yml`，新增 Loki 和 Promtail 服务，并挂载必要的数据卷。\n\n```yaml\nservices:\n  # ... (之前的 Prometheus, Grafana, Alertmanager 等保持不变) ...\n\n  # --- 新增: 日志存储 Loki ---\n  loki:\n    image: grafana/loki:latest\n    container_name: loki\n    restart: always\n    volumes:\n      - ./loki/loki-config.yaml:/etc/loki/local-config.yaml\n      - loki_data:/loki\n    ports:\n      - \"3100:3100\"\n    networks:\n      - monitor-net\n\n  # --- 新增: 日志采集 Promtail ---\n  promtail:\n    image: grafana/promtail:latest\n    container_name: promtail\n    restart: always\n    volumes:\n      - ./promtail/promtail-config.yaml:/etc/promtail/config.yml\n      # ⚠️ 关键挂载 1: 允许 Promtail 访问 Docker 守护进程以发现容器\n      - /var/run/docker.sock:/var/run/docker.sock\n      # ⚠️ 关键挂载 2: 允许 Promtail 读取实际的日志文件 (只读模式)\n      - /var/lib/docker/containers:/var/lib/docker/containers:ro\n    networks:\n      - monitor-net\n\nvolumes:\n  prometheus_data:\n  grafana_data:\n  loki_data: # <--- 别忘了新增这个卷用于持久化日志\n\nnetworks:\n  monitor-net:\n```\n\n### 7.3 部署与 Grafana 配置\n#### 7.3.1 重启服务\n```yaml\ncd /opt/monitor\ndocker compose up -d\n# 检查 loki 和 promtail 状态是否为 Up\ndocker compose ps\n```\n\n#### 7.3.2 在 Grafana 接入数据源\n+ 登录 Grafana -> Connections -> Data sources -> Add new data source。\n+ 选择 Loki。\n+ URL 填写：[http://loki:3100。](http://loki:3100。)\n+ 点击 Save & Test，出现绿色提示 \"Data source connected\" 即成功。\n\n### 7.4 如何进行日志排查\n+ 进入 Grafana 左侧菜单 Explore (探索)。\n+ 顶部数据源选择 Loki。\n+ Label filters 选择 container = 你的应用容器名 (例如 cadvisor)。\n+ 点击 Run query。\n+ 效果：可以看到实时的应用日志流。配合 Live 按钮，可以像在终端使用 `tail -f` 一样监控线上日志。\n\n---\n\n## 8. 简历上的项目描述\n**项目名称：基于 Docker 的云服务器监控平台**\n\n**项目描述：**  \n针对单体云服务器缺乏可视化监控、故障排查困难的问题，基于 Docker 搭建了一套标准化的监控告警系统。实现了从硬件层到应用容器层的全方位可观测性。\n\n**操作系统**：Ubuntu 24.04\n\n**技术栈**：Docker + Prometheus + Grafana + Alertmanager + cAdvisor + Loki + Promtail \n\n**核心技术：**\n\n+ **容器化基础设施**：使用 **Docker Compose** 统一编排 **Prometheus、Grafana、Loki** 等 6 个服务组件，实现了“一键拉起”的标准化部署环境。\n+ **多维度监控**：通过 **Node Exporter** 采集宿主机 CPU 使用率、磁盘 IO 等核心指标；引入 **cAdvisor** 解决了 Docker 容器资源隔离不可见的问题，实现了对单容器内存泄漏的实时监测。\n+ **可视化监控**：基于 **Grafana** 自定义监控仪表盘，配置了 **Prometheus 数据源**，实现了服务器资源使用率的秒级刷新展示。\n+ **自动化告警**：编写 PromQL 规则（如 CPU > 90%），结合 **Alertmanager **实现了邮件实时告警，经**压测**验证，平均故障响应时间缩短至 2 分钟以内\n+ **日志聚合分析：**引入**Promtail + Loki + Grafana **技术栈，实现 docker 容器日志的自动化采集和聚合，与传统 ELK 方案相比，资源占用更低\n\n---\n\n","slug":"基于 Docker + Prometheus + Grafana 的全栈监控平台","published":1,"updated":"2026-01-31T12:32:53.162Z","comments":1,"layout":"post","photos":[],"_id":"cml85ywze00039znxbo30cjhk","content":"<h1 id=\"基于-Docker-Prometheus-Grafana-的全栈监控平台\"><a href=\"#基于-Docker-Prometheus-Grafana-的全栈监控平台\" class=\"headerlink\" title=\"基于 Docker + Prometheus + Grafana 的全栈监控平台\"></a>基于 Docker + Prometheus + Grafana 的全栈监控平台</h1><h2 id=\"1-项目背景与架构\"><a href=\"#1-项目背景与架构\" class=\"headerlink\" title=\"1. 项目背景与架构\"></a>1. 项目背景与架构</h2><ul>\n<li><strong>项目目标</strong>：在单台云服务器上构建轻量级、高可用的运维监控体系，解决“服务器黑盒”问题，实现对主机硬件及 Docker 容器的实时监控。</li>\n<li><strong>技术栈</strong>：Docker, Docker Compose, Prometheus, Grafana, Node Exporter, cAdvisor。</li>\n<li><strong>架构流向</strong>：</li>\n</ul>\n<blockquote>\n<p>数据源 (Node Exporter&#x2F;cAdvisor) -&gt; 拉取存储 (Prometheus) -&gt; 数据展示 (Grafana)</p>\n</blockquote>\n<h2 id=\"2-环境准备\"><a href=\"#2-环境准备\" class=\"headerlink\" title=\"2. 环境准备\"></a>2. 环境准备</h2><p>确保服务器已安装 <code>Docker</code> 和 <code>Docker Compose</code>。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1. 创建统一的项目目录，遵循运维规范</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /opt/monitor/prometheus  <span class=\"comment\"># 存放 Prometheus 配置</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /opt/monitor/grafana     <span class=\"comment\"># 存放 Grafana 持久化数据</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /opt/monitor</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-配置文件编写\"><a href=\"#3-配置文件编写\" class=\"headerlink\" title=\"3. 配置文件编写\"></a>3. 配置文件编写</h2><h3 id=\"3-1-配置-Prometheus-prometheus-yml\"><a href=\"#3-1-配置-Prometheus-prometheus-yml\" class=\"headerlink\" title=\"3.1 配置 Prometheus (prometheus.yml)\"></a>3.1 配置 Prometheus (<code>prometheus.yml</code>)</h3><p>创建并编辑 <code>/opt/monitor/prometheus/prometheus.yml</code>，定义数据抓取任务。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\">  <span class=\"attr\">scrape_interval:</span> <span class=\"string\">15s</span>      <span class=\"comment\"># 全局抓取间隔</span></span><br><span class=\"line\">  <span class=\"attr\">evaluation_interval:</span> <span class=\"string\">15s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">scrape_configs:</span></span><br><span class=\"line\">  <span class=\"comment\"># 1. 监控 Prometheus 自身</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;prometheus&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;localhost:9090&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 2. 监控宿主机硬件 (Node Exporter)</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;node_exporter&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;node-exporter:9100&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 3. 监控 Docker 容器资源 (cAdvisor)</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;cadvisor&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;cadvisor:8080&#x27;</span>]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-2-编写编排文件-docker-compose-yml\"><a href=\"#3-2-编写编排文件-docker-compose-yml\" class=\"headerlink\" title=\"3.2 编写编排文件 (docker-compose.yml)\"></a>3.2 编写编排文件 (<code>docker-compose.yml</code>)</h3><p>在 <code>/opt/monitor/</code> 下创建，一次性编排所有服务。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.8&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"comment\"># --- 核心数据库: Prometheus ---</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">prom/prometheus:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">prometheus_data:/prometheus</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--storage.tsdb.retention.time=15d&#x27;</span> <span class=\"comment\"># 数据保留15天</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;9090:9090&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 可视化面板: Grafana ---</span></span><br><span class=\"line\">  <span class=\"attr\">grafana:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/grafana:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">grafana_data:/var/lib/grafana</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">GF_SECURITY_ADMIN_PASSWORD=admin</span> <span class=\"comment\"># 初始密码</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3000:3000&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 宿主机采集器: Node Exporter ---</span></span><br><span class=\"line\">  <span class=\"attr\">node-exporter:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">prom/node-exporter:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">node-exporter</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;9100:9100&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/proc:/host/proc:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/sys:/host/sys:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/:/rootfs:ro</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--path.procfs=/host/proc&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--path.sysfs=/host/sys&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--path.rootfs=/rootfs&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 容器采集器: cAdvisor ---</span></span><br><span class=\"line\">  <span class=\"attr\">cadvisor:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">zcube/cadvisor:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">cadvisor</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;8080:8080&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">devices:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/dev/kmsg</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/:/rootfs:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/run:/var/run:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/sys:/sys:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/lib/docker/:/var/lib/docker:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/dev/disk/:/dev/disk:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/sys/fs/cgroup:/sys/fs/cgroup:ro</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus_data:</span></span><br><span class=\"line\">  <span class=\"attr\">grafana_data:</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">monitor-net:</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-部署与启动\"><a href=\"#4-部署与启动\" class=\"headerlink\" title=\"4. 部署与启动\"></a>4. 部署与启动</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在 /opt/monitor 目录下执行</span></span><br><span class=\"line\">docker compose up -d</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查运行状态（确保所有 State 均为 Up）</span></span><br><span class=\"line\">docker compose ps</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-Grafana-深度配置与可视化\"><a href=\"#5-Grafana-深度配置与可视化\" class=\"headerlink\" title=\"5. Grafana 深度配置与可视化\"></a>5. Grafana 深度配置与可视化</h2><p>访问地址：<code>http://&lt;服务器IP&gt;:3000</code> (账号&#x2F;密码: admin&#x2F;admin)</p>\n<h3 id=\"5-1-设置中文界面\"><a href=\"#5-1-设置中文界面\" class=\"headerlink\" title=\"5.1 设置中文界面\"></a>5.1 设置中文界面</h3><ol>\n<li>进入 <strong>Profile (个人资料)</strong> -&gt; <strong>Preferences</strong>。</li>\n<li><strong>Language</strong> 选择 <strong>简体中文</strong> -&gt; Save。</li>\n</ol>\n<h3 id=\"5-2-配置数据源\"><a href=\"#5-2-配置数据源\" class=\"headerlink\" title=\"5.2 配置数据源\"></a>5.2 配置数据源</h3><ol>\n<li>左侧菜单 -&gt; <strong>连接</strong> -&gt; <strong>数据源</strong> -&gt; <strong>Add new data source</strong>。</li>\n<li>选择 <strong>Prometheus</strong>。</li>\n<li><strong>Connection URL</strong> 填写：<code>http://prometheus:9090</code> (利用 Docker 内部 DNS 解析)。</li>\n<li>点击底部 <strong>Save &amp; Test</strong>，出现绿色提示即成功。</li>\n</ol>\n<h3 id=\"5-3-导入核心仪表盘\"><a href=\"#5-3-导入核心仪表盘\" class=\"headerlink\" title=\"5.3 导入核心仪表盘\"></a>5.3 导入核心仪表盘</h3><p>左侧菜单 -&gt; <strong>仪表盘</strong> -&gt; **导入 (Import)**，输入以下 ID 并加载：</p>\n<table>\n<thead>\n<tr>\n<th>监控维度</th>\n<th>推荐模板 ID</th>\n<th>关键指标</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>宿主机监控</strong> (Node Exporter)</td>\n<td><strong>8919</strong></td>\n<td>CPU 核数负载、内存明细、磁盘 I&#x2F;O 读写、网络上下行流量</td>\n</tr>\n<tr>\n<td><strong>Docker 容器监控</strong> (cAdvisor)</td>\n<td><strong>14282</strong> (或 193)</td>\n<td>单容器 CPU 使用率、单容器内存占用、网络流量排行</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>注意</strong>：导入时在底部的 Data Source 选项中，务必选择刚刚创建的 Prometheus 数据源。</p>\n</blockquote>\n<h2 id=\"6-基于-Alertmanager-的自动化告警闭环\"><a href=\"#6-基于-Alertmanager-的自动化告警闭环\" class=\"headerlink\" title=\"6. 基于 Alertmanager 的自动化告警闭环\"></a>6. 基于 Alertmanager 的自动化告警闭环</h2><blockquote>\n<p>为了实现 7*24 小时无人值守监控，我们引入 Alertmanager 组件</p>\n</blockquote>\n<p>流程：Prometheus (发现异常) -&gt; Push -&gt; Alertmanager (去重、分组、路由) -&gt; Send -&gt; Email (管理员)。</p>\n<h3 id=\"6-1-配置文件编写\"><a href=\"#6-1-配置文件编写\" class=\"headerlink\" title=\"6.1 配置文件编写\"></a>6.1 配置文件编写</h3><h4 id=\"6-1-1-创建告警规则-rules-yml\"><a href=\"#6-1-1-创建告警规则-rules-yml\" class=\"headerlink\" title=\"6.1.1 创建告警规则 (rules.yml)\"></a>6.1.1 创建告警规则 (<code>rules.yml</code>)</h4><p>在 &#x2F;opt&#x2F;monitor&#x2F;prometheus&#x2F; 目录下创建 <code>rules.yml</code>，定义什么样的指标属于“故障”。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">groups</span>:</span><br><span class=\"line\">  - name: host_monitoring</span><br><span class=\"line\">    rules:</span><br><span class=\"line\">    - alert: HostCpuUsageTooHigh</span><br><span class=\"line\">      <span class=\"comment\"># 表达式含义：(1 - 空闲率) * 100 &gt; 50%</span></span><br><span class=\"line\">      <span class=\"built_in\">expr</span>: 100 - (avg by (instance) (rate(node_cpu_seconds_total&#123;mode=<span class=\"string\">&quot;idle&quot;</span>&#125;[1m])) * 100) &gt; 50</span><br><span class=\"line\">      <span class=\"keyword\">for</span>: 1m  <span class=\"comment\"># 持续 1 分钟才报警，避免抖动误报</span></span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        severity: warning</span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        summary: <span class=\"string\">&quot;主机 &#123;&#123; <span class=\"variable\">$labels</span>.instance &#125;&#125; CPU 负载过高&quot;</span></span><br><span class=\"line\">        description: <span class=\"string\">&quot;当前 CPU 使用率已超过 50% (当前值: &#123;&#123; <span class=\"variable\">$value</span> | printf \\&quot;%.2f\\&quot; &#125;&#125;%)&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-1-2-配置-Alertmanager-config-yml\"><a href=\"#6-1-2-配置-Alertmanager-config-yml\" class=\"headerlink\" title=\"6.1.2 配置 Alertmanager (config.yml)\"></a>6.1.2 配置 Alertmanager (<code>config.yml</code>)</h4><p>创建目录 <code>/opt/monitor/alertmanager </code>并新建<code>config.yml</code>。</p>\n<blockquote>\n<p>注意：此处以 QQ 邮箱为例，密码必须使用 SMTP 授权码。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">global:</span><br><span class=\"line\">  resolve_timeout: 5m</span><br><span class=\"line\">  smtp_smarthost: <span class=\"string\">&#x27;smtp.qq.com:465&#x27;</span>      <span class=\"comment\"># SMTP 服务器</span></span><br><span class=\"line\">  smtp_from: <span class=\"string\">&#x27;你的邮箱@qq.com&#x27;</span>           <span class=\"comment\"># 发件人</span></span><br><span class=\"line\">  smtp_auth_username: <span class=\"string\">&#x27;你的邮箱@qq.com&#x27;</span>  <span class=\"comment\"># 账号</span></span><br><span class=\"line\">  smtp_auth_password: <span class=\"string\">&#x27;你的授权码&#x27;</span>       <span class=\"comment\"># 授权码 (非登录密码)</span></span><br><span class=\"line\">  smtp_require_tls: <span class=\"literal\">false</span>                <span class=\"comment\"># 465端口通常为false</span></span><br><span class=\"line\"></span><br><span class=\"line\">route:</span><br><span class=\"line\">  group_by: [<span class=\"string\">&#x27;alertname&#x27;</span>]</span><br><span class=\"line\">  group_wait: 10s</span><br><span class=\"line\">  group_interval: 10s</span><br><span class=\"line\">  repeat_interval: 1h       <span class=\"comment\"># 报警未解决，1小时后重发</span></span><br><span class=\"line\">  receiver: <span class=\"string\">&#x27;email-receiver&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">receivers:</span><br><span class=\"line\">  - name: <span class=\"string\">&#x27;email-receiver&#x27;</span></span><br><span class=\"line\">    email_configs:</span><br><span class=\"line\">      - to: <span class=\"string\">&#x27;接收者邮箱@example.com&#x27;</span></span><br><span class=\"line\">        send_resolved: <span class=\"literal\">true</span> <span class=\"comment\"># 故障恢复后发送通知</span></span><br><span class=\"line\">        headers:</span><br><span class=\"line\">          Subject: <span class=\"string\">&quot;【云服务器告警】 &#123;&#123; .CommonAnnotations.summary &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-1-3-关联-Prometheus\"><a href=\"#6-1-3-关联-Prometheus\" class=\"headerlink\" title=\"6.1.3 关联 Prometheus\"></a>6.1.3 关联 Prometheus</h4><p>修改 <code>/opt/monitor/prometheus/prometheus.yml</code>，加入规则文件和 Alertmanager 地址</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在 global 块之后添加</span></span><br><span class=\"line\">rule_files:</span><br><span class=\"line\">  - <span class=\"string\">&quot;rules.yml&quot;</span>  <span class=\"comment\"># 引用刚刚写的规则文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">alerting:</span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">    - static_configs:</span><br><span class=\"line\">        - targets: [<span class=\"string\">&#x27;alertmanager:9093&#x27;</span>]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-2-服务编排更新-docker-compose-yml\"><a href=\"#6-2-服务编排更新-docker-compose-yml\" class=\"headerlink\" title=\"6.2 服务编排更新 (docker-compose.yml)\"></a>6.2 服务编排更新 (<code>docker-compose.yml</code>)</h3><p>修改 <code>/opt/monitor/docker-compose.yml</code>，新增 Alertmanager 服务，并更新 Prometheus 的挂载。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services:</span><br><span class=\"line\">  <span class=\"comment\"># ... (其他服务保持不变) ...</span></span><br><span class=\"line\">  prometheus:</span><br><span class=\"line\">    <span class=\"comment\"># ... (image, ports 等保持不变) ...</span></span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml</span><br><span class=\"line\">      - ./prometheus/rules.yml:/etc/prometheus/rules.yml  <span class=\"comment\"># &lt;--- 新增：挂载规则文件</span></span><br><span class=\"line\">      - prometheus_data:/prometheus</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 新增服务: 告警中心 ---</span></span><br><span class=\"line\">  alertmanager:</span><br><span class=\"line\">    image: prom/alertmanager:latest</span><br><span class=\"line\">    container_name: alertmanager</span><br><span class=\"line\">    restart: always</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      <span class=\"comment\"># ⚠️ 关键点：将本地 config.yml 强制挂载为容器内的 alertmanager.yml 以覆盖默认配置</span></span><br><span class=\"line\">      - ./alertmanager/config.yml:/etc/alertmanager/alertmanager.yml</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - <span class=\"string\">&quot;9093:9093&quot;</span></span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - monitor-net</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-3-部署验证\"><a href=\"#6-3-部署验证\" class=\"headerlink\" title=\"6.3 部署验证\"></a>6.3 部署验证</h3><h4 id=\"6-3-1-重启服务\"><a href=\"#6-3-1-重启服务\" class=\"headerlink\" title=\"6.3.1 重启服务\"></a>6.3.1 重启服务</h4><p>由于修改了挂载卷配置，建议先删除旧容器再启动：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /opt/monitor</span><br><span class=\"line\">docker compose down</span><br><span class=\"line\">docker compose up -d</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-3-2-压力测试（验证告警）\"><a href=\"#6-3-2-压力测试（验证告警）\" class=\"headerlink\" title=\"6.3.2 压力测试（验证告警）\"></a>6.3.2 压力测试（验证告警）</h4><p>安装压力测试工具 stress，模拟 CPU 飙升场景</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 模拟 2 个核满载，持续 120 秒</span></span><br><span class=\"line\">stress -c 2 -t 120</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-3-3-观察流程\"><a href=\"#6-3-3-观察流程\" class=\"headerlink\" title=\"6.3.3 观察流程\"></a>6.3.3 观察流程</h4><ul>\n<li><strong>触发</strong>：Prometheus 界面 (Status -&gt; Alerts) 中，<code>HostCpuUsageTooHigh</code> 状态由 Green -&gt; Yellow (Pending) -&gt; Red (Firing)。</li>\n<li><strong>发送</strong>：Alertmanager 收到 Firing 信号，处理后投递邮件。</li>\n<li><strong>恢复</strong>：stress 结束后，收到标题带 [Resolved] 的恢复邮件。</li>\n</ul>\n<h3 id=\"6-4-常见问题排查\"><a href=\"#6-4-常见问题排查\" class=\"headerlink\" title=\"6.4 常见问题排查\"></a>6.4 常见问题排查</h3><ul>\n<li><strong>问题 1：</strong>Alertmanager 报错 connection refused 127.0.0.1:5001。<ul>\n<li>原因：配置文件挂载路径错误，导致容器读取了镜像自带的默认配置（默认配置是指向本地 webhook 的）。</li>\n<li>解决：确保 docker-compose 中挂载目标路径为 <code>/etc/alertmanager/alertmanager.yml</code>。</li>\n</ul>\n</li>\n<li><strong>问题 2：</strong>邮件发送失败 535 Authentication failed。<ul>\n<li>原因：使用了邮箱登录密码，而非 SMTP 专用授权码。</li>\n</ul>\n</li>\n<li><strong>问题 3：</strong>容器无法联网 i&#x2F;o timeout。<ul>\n<li>原因：Docker DNS 配置问题或云服务器安全组未放行。</li>\n</ul>\n</li>\n<li><strong>问题 4：</strong>cAdvisor 报错 mountpoint for cpu not found <ul>\n<li>原因：ubuntu 24.04 默认启用 <strong>Cgroup</strong> <strong>v2</strong>，而 docler hub 上的 cadvisor 旧版本只支持 <strong>Cgroup</strong> <strong>v1</strong></li>\n<li><strong>解决：</strong>通过更改 <strong>zcube&#x2F;cadvisor</strong> 镜像并配置 <strong>privileged</strong> 模式解决版本兼容性问题</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"7-基于-PLG-的轻量级日志分析\"><a href=\"#7-基于-PLG-的轻量级日志分析\" class=\"headerlink\" title=\"7. 基于 PLG 的轻量级日志分析\"></a>7. 基于 PLG 的轻量级日志分析</h2><blockquote>\n<p>为了解决“出现故障需要登录服务器一条条查 logs”的低效问题，引入 PLG 技术栈 (Promtail + Loki + Grafana)。</p>\n</blockquote>\n<ul>\n<li>优势：相比 ELK (Elasticsearch)，Loki 不建立全文索引，仅索引元数据（标签），内存占用极低，非常适合云服务器单机环境。</li>\n<li>流向：Promtail (自动发现容器) -&gt; 采集日志 -&gt; Loki (存储与索引) -&gt; Grafana (统一查询)。</li>\n</ul>\n<h3 id=\"7-1-配置文件编写\"><a href=\"#7-1-配置文件编写\" class=\"headerlink\" title=\"7.1 配置文件编写\"></a>7.1 配置文件编写</h3><p>首先创建日志组件的专用目录：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">mkdir</span> <span class=\"string\">-p</span> <span class=\"string\">/opt/monitor/loki</span></span><br><span class=\"line\"><span class=\"string\">mkdir</span> <span class=\"string\">-p</span> <span class=\"string\">/opt/monitor/promtail</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"7-1-1-配置-Loki-存储端-loki-config-yaml\"><a href=\"#7-1-1-配置-Loki-存储端-loki-config-yaml\" class=\"headerlink\" title=\"7.1.1 配置 Loki 存储端 (loki-config.yaml)\"></a>7.1.1 配置 Loki 存储端 (<code>loki-config.yaml</code>)</h4><p>创建<code>/opt/monitor/loki/loki-config.yaml</code>，定义日志如何存储。采用本地文件系统存储，简单高效。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">auth_enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">http_listen_port:</span> <span class=\"number\">3100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">common:</span></span><br><span class=\"line\">  <span class=\"attr\">path_prefix:</span> <span class=\"string\">/loki</span></span><br><span class=\"line\">  <span class=\"attr\">storage:</span></span><br><span class=\"line\">    <span class=\"attr\">filesystem:</span></span><br><span class=\"line\">      <span class=\"attr\">chunks_directory:</span> <span class=\"string\">/loki/chunks</span></span><br><span class=\"line\">      <span class=\"attr\">rules_directory:</span> <span class=\"string\">/loki/rules</span></span><br><span class=\"line\">  <span class=\"attr\">replication_factor:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">ring:</span></span><br><span class=\"line\">    <span class=\"attr\">instance_addr:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\">    <span class=\"attr\">kvstore:</span></span><br><span class=\"line\">      <span class=\"attr\">store:</span> <span class=\"string\">inmemory</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">schema_config:</span></span><br><span class=\"line\">  <span class=\"attr\">configs:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">from:</span> <span class=\"number\">2020-10-24</span></span><br><span class=\"line\">      <span class=\"attr\">store:</span> <span class=\"string\">tsdb</span></span><br><span class=\"line\">      <span class=\"attr\">object_store:</span> <span class=\"string\">filesystem</span></span><br><span class=\"line\">      <span class=\"attr\">schema:</span> <span class=\"string\">v13</span></span><br><span class=\"line\">      <span class=\"attr\">index:</span></span><br><span class=\"line\">        <span class=\"attr\">prefix:</span> <span class=\"string\">index_</span></span><br><span class=\"line\">        <span class=\"attr\">period:</span> <span class=\"string\">24h</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"7-1-2-配置-Promtail-采集端-promtail-config-yaml\"><a href=\"#7-1-2-配置-Promtail-采集端-promtail-config-yaml\" class=\"headerlink\" title=\"7.1.2 配置 Promtail 采集端 (promtail-config.yaml)\"></a>7.1.2 配置 Promtail 采集端 (<code>promtail-config.yaml</code>)</h4><p>创建 <code>/opt/monitor/promtail/promtail-config.yaml</code>。、</p>\n<blockquote>\n<p>核心逻辑：通过挂载 Docker Socket，自动发现当前运行的所有容器，并利用 relabel 机制将 Docker 内部名称格式化为易读的标签。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">http_listen_port:</span> <span class=\"number\">9080</span></span><br><span class=\"line\">  <span class=\"attr\">grpc_listen_port:</span> <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">positions:</span></span><br><span class=\"line\">  <span class=\"attr\">filename:</span> <span class=\"string\">/tmp/positions.yaml</span> <span class=\"comment\"># 记录采集游标，防止重启后日志重复或丢失</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">clients:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">http://loki:3100/loki/api/v1/push</span> <span class=\"comment\"># 推送给 Loki</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">scrape_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">system</span></span><br><span class=\"line\">    <span class=\"attr\">docker_sd_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">unix:///var/run/docker.sock</span> <span class=\"comment\"># 监听 Docker 事件</span></span><br><span class=\"line\">        <span class=\"attr\">refresh_interval:</span> <span class=\"string\">5s</span></span><br><span class=\"line\">    <span class=\"attr\">relabel_configs:</span></span><br><span class=\"line\">      <span class=\"comment\"># 只保留有名称的容器</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">source_labels:</span> [<span class=\"string\">&#x27;__meta_docker_container_name&#x27;</span>]</span><br><span class=\"line\">        <span class=\"attr\">regex:</span> <span class=\"string\">&#x27;/(.*)&#x27;</span></span><br><span class=\"line\">        <span class=\"attr\">target_label:</span> <span class=\"string\">&#x27;container&#x27;</span> <span class=\"comment\"># 重命名标签为 container，方便检索</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-2-服务编排更新-docker-compose-yml\"><a href=\"#7-2-服务编排更新-docker-compose-yml\" class=\"headerlink\" title=\"7.2 服务编排更新 (docker-compose.yml)\"></a>7.2 服务编排更新 (<code>docker-compose.yml</code>)</h3><p>编辑 <code>/opt/monitor/docker-compose.yml</code>，新增 Loki 和 Promtail 服务，并挂载必要的数据卷。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"comment\"># ... (之前的 Prometheus, Grafana, Alertmanager 等保持不变) ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 新增: 日志存储 Loki ---</span></span><br><span class=\"line\">  <span class=\"attr\">loki:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/loki:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">loki</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./loki/loki-config.yaml:/etc/loki/local-config.yaml</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">loki_data:/loki</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3100:3100&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 新增: 日志采集 Promtail ---</span></span><br><span class=\"line\">  <span class=\"attr\">promtail:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/promtail:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">promtail</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./promtail/promtail-config.yaml:/etc/promtail/config.yml</span></span><br><span class=\"line\">      <span class=\"comment\"># ⚠️ 关键挂载 1: 允许 Promtail 访问 Docker 守护进程以发现容器</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class=\"line\">      <span class=\"comment\"># ⚠️ 关键挂载 2: 允许 Promtail 读取实际的日志文件 (只读模式)</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/lib/docker/containers:/var/lib/docker/containers:ro</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus_data:</span></span><br><span class=\"line\">  <span class=\"attr\">grafana_data:</span></span><br><span class=\"line\">  <span class=\"attr\">loki_data:</span> <span class=\"comment\"># &lt;--- 别忘了新增这个卷用于持久化日志</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">monitor-net:</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-3-部署与-Grafana-配置\"><a href=\"#7-3-部署与-Grafana-配置\" class=\"headerlink\" title=\"7.3 部署与 Grafana 配置\"></a>7.3 部署与 Grafana 配置</h3><h4 id=\"7-3-1-重启服务\"><a href=\"#7-3-1-重启服务\" class=\"headerlink\" title=\"7.3.1 重启服务\"></a>7.3.1 重启服务</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cd</span> <span class=\"string\">/opt/monitor</span></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">compose</span> <span class=\"string\">up</span> <span class=\"string\">-d</span></span><br><span class=\"line\"><span class=\"comment\"># 检查 loki 和 promtail 状态是否为 Up</span></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">compose</span> <span class=\"string\">ps</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"7-3-2-在-Grafana-接入数据源\"><a href=\"#7-3-2-在-Grafana-接入数据源\" class=\"headerlink\" title=\"7.3.2 在 Grafana 接入数据源\"></a>7.3.2 在 Grafana 接入数据源</h4><ul>\n<li>登录 Grafana -&gt; Connections -&gt; Data sources -&gt; Add new data source。</li>\n<li>选择 Loki。</li>\n<li>URL 填写：<a href=\"http://loki:3100。\">http://loki:3100。</a></li>\n<li>点击 Save &amp; Test，出现绿色提示 “Data source connected” 即成功。</li>\n</ul>\n<h3 id=\"7-4-如何进行日志排查\"><a href=\"#7-4-如何进行日志排查\" class=\"headerlink\" title=\"7.4 如何进行日志排查\"></a>7.4 如何进行日志排查</h3><ul>\n<li>进入 Grafana 左侧菜单 Explore (探索)。</li>\n<li>顶部数据源选择 Loki。</li>\n<li>Label filters 选择 container &#x3D; 你的应用容器名 (例如 cadvisor)。</li>\n<li>点击 Run query。</li>\n<li>效果：可以看到实时的应用日志流。配合 Live 按钮，可以像在终端使用 <code>tail -f</code> 一样监控线上日志。</li>\n</ul>\n<hr>\n<h2 id=\"8-简历上的项目描述\"><a href=\"#8-简历上的项目描述\" class=\"headerlink\" title=\"8. 简历上的项目描述\"></a>8. 简历上的项目描述</h2><p><strong>项目名称：基于 Docker 的云服务器监控平台</strong></p>\n<p><strong>项目描述：</strong><br>针对单体云服务器缺乏可视化监控、故障排查困难的问题，基于 Docker 搭建了一套标准化的监控告警系统。实现了从硬件层到应用容器层的全方位可观测性。</p>\n<p><strong>操作系统</strong>：Ubuntu 24.04</p>\n<p><strong>技术栈</strong>：Docker + Prometheus + Grafana + Alertmanager + cAdvisor + Loki + Promtail </p>\n<p><strong>核心技术：</strong></p>\n<ul>\n<li><strong>容器化基础设施</strong>：使用 <strong>Docker Compose</strong> 统一编排 <strong>Prometheus、Grafana、Loki</strong> 等 6 个服务组件，实现了“一键拉起”的标准化部署环境。</li>\n<li><strong>多维度监控</strong>：通过 <strong>Node Exporter</strong> 采集宿主机 CPU 使用率、磁盘 IO 等核心指标；引入 <strong>cAdvisor</strong> 解决了 Docker 容器资源隔离不可见的问题，实现了对单容器内存泄漏的实时监测。</li>\n<li><strong>可视化监控</strong>：基于 <strong>Grafana</strong> 自定义监控仪表盘，配置了 <strong>Prometheus 数据源</strong>，实现了服务器资源使用率的秒级刷新展示。</li>\n<li><strong>自动化告警</strong>：编写 PromQL 规则（如 CPU &gt; 90%），结合 <strong>Alertmanager <strong>实现了邮件实时告警，经</strong>压测</strong>验证，平均故障响应时间缩短至 2 分钟以内</li>\n<li><strong>日志聚合分析：</strong>引入**Promtail + Loki + Grafana **技术栈，实现 docker 容器日志的自动化采集和聚合，与传统 ELK 方案相比，资源占用更低</li>\n</ul>\n<hr>\n","excerpt":"","more":"<h1 id=\"基于-Docker-Prometheus-Grafana-的全栈监控平台\"><a href=\"#基于-Docker-Prometheus-Grafana-的全栈监控平台\" class=\"headerlink\" title=\"基于 Docker + Prometheus + Grafana 的全栈监控平台\"></a>基于 Docker + Prometheus + Grafana 的全栈监控平台</h1><h2 id=\"1-项目背景与架构\"><a href=\"#1-项目背景与架构\" class=\"headerlink\" title=\"1. 项目背景与架构\"></a>1. 项目背景与架构</h2><ul>\n<li><strong>项目目标</strong>：在单台云服务器上构建轻量级、高可用的运维监控体系，解决“服务器黑盒”问题，实现对主机硬件及 Docker 容器的实时监控。</li>\n<li><strong>技术栈</strong>：Docker, Docker Compose, Prometheus, Grafana, Node Exporter, cAdvisor。</li>\n<li><strong>架构流向</strong>：</li>\n</ul>\n<blockquote>\n<p>数据源 (Node Exporter&#x2F;cAdvisor) -&gt; 拉取存储 (Prometheus) -&gt; 数据展示 (Grafana)</p>\n</blockquote>\n<h2 id=\"2-环境准备\"><a href=\"#2-环境准备\" class=\"headerlink\" title=\"2. 环境准备\"></a>2. 环境准备</h2><p>确保服务器已安装 <code>Docker</code> 和 <code>Docker Compose</code>。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1. 创建统一的项目目录，遵循运维规范</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /opt/monitor/prometheus  <span class=\"comment\"># 存放 Prometheus 配置</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /opt/monitor/grafana     <span class=\"comment\"># 存放 Grafana 持久化数据</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /opt/monitor</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-配置文件编写\"><a href=\"#3-配置文件编写\" class=\"headerlink\" title=\"3. 配置文件编写\"></a>3. 配置文件编写</h2><h3 id=\"3-1-配置-Prometheus-prometheus-yml\"><a href=\"#3-1-配置-Prometheus-prometheus-yml\" class=\"headerlink\" title=\"3.1 配置 Prometheus (prometheus.yml)\"></a>3.1 配置 Prometheus (<code>prometheus.yml</code>)</h3><p>创建并编辑 <code>/opt/monitor/prometheus/prometheus.yml</code>，定义数据抓取任务。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">global:</span></span><br><span class=\"line\">  <span class=\"attr\">scrape_interval:</span> <span class=\"string\">15s</span>      <span class=\"comment\"># 全局抓取间隔</span></span><br><span class=\"line\">  <span class=\"attr\">evaluation_interval:</span> <span class=\"string\">15s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">scrape_configs:</span></span><br><span class=\"line\">  <span class=\"comment\"># 1. 监控 Prometheus 自身</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;prometheus&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;localhost:9090&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 2. 监控宿主机硬件 (Node Exporter)</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;node_exporter&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;node-exporter:9100&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># 3. 监控 Docker 容器资源 (cAdvisor)</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;cadvisor&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;cadvisor:8080&#x27;</span>]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"3-2-编写编排文件-docker-compose-yml\"><a href=\"#3-2-编写编排文件-docker-compose-yml\" class=\"headerlink\" title=\"3.2 编写编排文件 (docker-compose.yml)\"></a>3.2 编写编排文件 (<code>docker-compose.yml</code>)</h3><p>在 <code>/opt/monitor/</code> 下创建，一次性编排所有服务。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.8&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"comment\"># --- 核心数据库: Prometheus ---</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">prom/prometheus:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">prometheus_data:/prometheus</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--config.file=/etc/prometheus/prometheus.yml&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--storage.tsdb.retention.time=15d&#x27;</span> <span class=\"comment\"># 数据保留15天</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;9090:9090&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 可视化面板: Grafana ---</span></span><br><span class=\"line\">  <span class=\"attr\">grafana:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/grafana:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">grafana</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">grafana_data:/var/lib/grafana</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">GF_SECURITY_ADMIN_PASSWORD=admin</span> <span class=\"comment\"># 初始密码</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3000:3000&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 宿主机采集器: Node Exporter ---</span></span><br><span class=\"line\">  <span class=\"attr\">node-exporter:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">prom/node-exporter:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">node-exporter</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;9100:9100&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/proc:/host/proc:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/sys:/host/sys:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/:/rootfs:ro</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--path.procfs=/host/proc&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--path.sysfs=/host/sys&#x27;</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;--path.rootfs=/rootfs&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 容器采集器: cAdvisor ---</span></span><br><span class=\"line\">  <span class=\"attr\">cadvisor:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">zcube/cadvisor:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">cadvisor</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;8080:8080&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">devices:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/dev/kmsg</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/:/rootfs:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/run:/var/run:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/sys:/sys:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/lib/docker/:/var/lib/docker:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/dev/disk/:/dev/disk:ro</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/sys/fs/cgroup:/sys/fs/cgroup:ro</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus_data:</span></span><br><span class=\"line\">  <span class=\"attr\">grafana_data:</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">monitor-net:</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-部署与启动\"><a href=\"#4-部署与启动\" class=\"headerlink\" title=\"4. 部署与启动\"></a>4. 部署与启动</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在 /opt/monitor 目录下执行</span></span><br><span class=\"line\">docker compose up -d</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 检查运行状态（确保所有 State 均为 Up）</span></span><br><span class=\"line\">docker compose ps</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-Grafana-深度配置与可视化\"><a href=\"#5-Grafana-深度配置与可视化\" class=\"headerlink\" title=\"5. Grafana 深度配置与可视化\"></a>5. Grafana 深度配置与可视化</h2><p>访问地址：<code>http://&lt;服务器IP&gt;:3000</code> (账号&#x2F;密码: admin&#x2F;admin)</p>\n<h3 id=\"5-1-设置中文界面\"><a href=\"#5-1-设置中文界面\" class=\"headerlink\" title=\"5.1 设置中文界面\"></a>5.1 设置中文界面</h3><ol>\n<li>进入 <strong>Profile (个人资料)</strong> -&gt; <strong>Preferences</strong>。</li>\n<li><strong>Language</strong> 选择 <strong>简体中文</strong> -&gt; Save。</li>\n</ol>\n<h3 id=\"5-2-配置数据源\"><a href=\"#5-2-配置数据源\" class=\"headerlink\" title=\"5.2 配置数据源\"></a>5.2 配置数据源</h3><ol>\n<li>左侧菜单 -&gt; <strong>连接</strong> -&gt; <strong>数据源</strong> -&gt; <strong>Add new data source</strong>。</li>\n<li>选择 <strong>Prometheus</strong>。</li>\n<li><strong>Connection URL</strong> 填写：<code>http://prometheus:9090</code> (利用 Docker 内部 DNS 解析)。</li>\n<li>点击底部 <strong>Save &amp; Test</strong>，出现绿色提示即成功。</li>\n</ol>\n<h3 id=\"5-3-导入核心仪表盘\"><a href=\"#5-3-导入核心仪表盘\" class=\"headerlink\" title=\"5.3 导入核心仪表盘\"></a>5.3 导入核心仪表盘</h3><p>左侧菜单 -&gt; <strong>仪表盘</strong> -&gt; **导入 (Import)**，输入以下 ID 并加载：</p>\n<table>\n<thead>\n<tr>\n<th>监控维度</th>\n<th>推荐模板 ID</th>\n<th>关键指标</th>\n</tr>\n</thead>\n<tbody><tr>\n<td><strong>宿主机监控</strong> (Node Exporter)</td>\n<td><strong>8919</strong></td>\n<td>CPU 核数负载、内存明细、磁盘 I&#x2F;O 读写、网络上下行流量</td>\n</tr>\n<tr>\n<td><strong>Docker 容器监控</strong> (cAdvisor)</td>\n<td><strong>14282</strong> (或 193)</td>\n<td>单容器 CPU 使用率、单容器内存占用、网络流量排行</td>\n</tr>\n</tbody></table>\n<blockquote>\n<p><strong>注意</strong>：导入时在底部的 Data Source 选项中，务必选择刚刚创建的 Prometheus 数据源。</p>\n</blockquote>\n<h2 id=\"6-基于-Alertmanager-的自动化告警闭环\"><a href=\"#6-基于-Alertmanager-的自动化告警闭环\" class=\"headerlink\" title=\"6. 基于 Alertmanager 的自动化告警闭环\"></a>6. 基于 Alertmanager 的自动化告警闭环</h2><blockquote>\n<p>为了实现 7*24 小时无人值守监控，我们引入 Alertmanager 组件</p>\n</blockquote>\n<p>流程：Prometheus (发现异常) -&gt; Push -&gt; Alertmanager (去重、分组、路由) -&gt; Send -&gt; Email (管理员)。</p>\n<h3 id=\"6-1-配置文件编写\"><a href=\"#6-1-配置文件编写\" class=\"headerlink\" title=\"6.1 配置文件编写\"></a>6.1 配置文件编写</h3><h4 id=\"6-1-1-创建告警规则-rules-yml\"><a href=\"#6-1-1-创建告警规则-rules-yml\" class=\"headerlink\" title=\"6.1.1 创建告警规则 (rules.yml)\"></a>6.1.1 创建告警规则 (<code>rules.yml</code>)</h4><p>在 &#x2F;opt&#x2F;monitor&#x2F;prometheus&#x2F; 目录下创建 <code>rules.yml</code>，定义什么样的指标属于“故障”。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">groups</span>:</span><br><span class=\"line\">  - name: host_monitoring</span><br><span class=\"line\">    rules:</span><br><span class=\"line\">    - alert: HostCpuUsageTooHigh</span><br><span class=\"line\">      <span class=\"comment\"># 表达式含义：(1 - 空闲率) * 100 &gt; 50%</span></span><br><span class=\"line\">      <span class=\"built_in\">expr</span>: 100 - (avg by (instance) (rate(node_cpu_seconds_total&#123;mode=<span class=\"string\">&quot;idle&quot;</span>&#125;[1m])) * 100) &gt; 50</span><br><span class=\"line\">      <span class=\"keyword\">for</span>: 1m  <span class=\"comment\"># 持续 1 分钟才报警，避免抖动误报</span></span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        severity: warning</span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        summary: <span class=\"string\">&quot;主机 &#123;&#123; <span class=\"variable\">$labels</span>.instance &#125;&#125; CPU 负载过高&quot;</span></span><br><span class=\"line\">        description: <span class=\"string\">&quot;当前 CPU 使用率已超过 50% (当前值: &#123;&#123; <span class=\"variable\">$value</span> | printf \\&quot;%.2f\\&quot; &#125;&#125;%)&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-1-2-配置-Alertmanager-config-yml\"><a href=\"#6-1-2-配置-Alertmanager-config-yml\" class=\"headerlink\" title=\"6.1.2 配置 Alertmanager (config.yml)\"></a>6.1.2 配置 Alertmanager (<code>config.yml</code>)</h4><p>创建目录 <code>/opt/monitor/alertmanager </code>并新建<code>config.yml</code>。</p>\n<blockquote>\n<p>注意：此处以 QQ 邮箱为例，密码必须使用 SMTP 授权码。</p>\n</blockquote>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">global:</span><br><span class=\"line\">  resolve_timeout: 5m</span><br><span class=\"line\">  smtp_smarthost: <span class=\"string\">&#x27;smtp.qq.com:465&#x27;</span>      <span class=\"comment\"># SMTP 服务器</span></span><br><span class=\"line\">  smtp_from: <span class=\"string\">&#x27;你的邮箱@qq.com&#x27;</span>           <span class=\"comment\"># 发件人</span></span><br><span class=\"line\">  smtp_auth_username: <span class=\"string\">&#x27;你的邮箱@qq.com&#x27;</span>  <span class=\"comment\"># 账号</span></span><br><span class=\"line\">  smtp_auth_password: <span class=\"string\">&#x27;你的授权码&#x27;</span>       <span class=\"comment\"># 授权码 (非登录密码)</span></span><br><span class=\"line\">  smtp_require_tls: <span class=\"literal\">false</span>                <span class=\"comment\"># 465端口通常为false</span></span><br><span class=\"line\"></span><br><span class=\"line\">route:</span><br><span class=\"line\">  group_by: [<span class=\"string\">&#x27;alertname&#x27;</span>]</span><br><span class=\"line\">  group_wait: 10s</span><br><span class=\"line\">  group_interval: 10s</span><br><span class=\"line\">  repeat_interval: 1h       <span class=\"comment\"># 报警未解决，1小时后重发</span></span><br><span class=\"line\">  receiver: <span class=\"string\">&#x27;email-receiver&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">receivers:</span><br><span class=\"line\">  - name: <span class=\"string\">&#x27;email-receiver&#x27;</span></span><br><span class=\"line\">    email_configs:</span><br><span class=\"line\">      - to: <span class=\"string\">&#x27;接收者邮箱@example.com&#x27;</span></span><br><span class=\"line\">        send_resolved: <span class=\"literal\">true</span> <span class=\"comment\"># 故障恢复后发送通知</span></span><br><span class=\"line\">        headers:</span><br><span class=\"line\">          Subject: <span class=\"string\">&quot;【云服务器告警】 &#123;&#123; .CommonAnnotations.summary &#125;&#125;&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-1-3-关联-Prometheus\"><a href=\"#6-1-3-关联-Prometheus\" class=\"headerlink\" title=\"6.1.3 关联 Prometheus\"></a>6.1.3 关联 Prometheus</h4><p>修改 <code>/opt/monitor/prometheus/prometheus.yml</code>，加入规则文件和 Alertmanager 地址</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在 global 块之后添加</span></span><br><span class=\"line\">rule_files:</span><br><span class=\"line\">  - <span class=\"string\">&quot;rules.yml&quot;</span>  <span class=\"comment\"># 引用刚刚写的规则文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">alerting:</span><br><span class=\"line\">  alertmanagers:</span><br><span class=\"line\">    - static_configs:</span><br><span class=\"line\">        - targets: [<span class=\"string\">&#x27;alertmanager:9093&#x27;</span>]</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-2-服务编排更新-docker-compose-yml\"><a href=\"#6-2-服务编排更新-docker-compose-yml\" class=\"headerlink\" title=\"6.2 服务编排更新 (docker-compose.yml)\"></a>6.2 服务编排更新 (<code>docker-compose.yml</code>)</h3><p>修改 <code>/opt/monitor/docker-compose.yml</code>，新增 Alertmanager 服务，并更新 Prometheus 的挂载。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">services:</span><br><span class=\"line\">  <span class=\"comment\"># ... (其他服务保持不变) ...</span></span><br><span class=\"line\">  prometheus:</span><br><span class=\"line\">    <span class=\"comment\"># ... (image, ports 等保持不变) ...</span></span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml</span><br><span class=\"line\">      - ./prometheus/rules.yml:/etc/prometheus/rules.yml  <span class=\"comment\"># &lt;--- 新增：挂载规则文件</span></span><br><span class=\"line\">      - prometheus_data:/prometheus</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 新增服务: 告警中心 ---</span></span><br><span class=\"line\">  alertmanager:</span><br><span class=\"line\">    image: prom/alertmanager:latest</span><br><span class=\"line\">    container_name: alertmanager</span><br><span class=\"line\">    restart: always</span><br><span class=\"line\">    volumes:</span><br><span class=\"line\">      <span class=\"comment\"># ⚠️ 关键点：将本地 config.yml 强制挂载为容器内的 alertmanager.yml 以覆盖默认配置</span></span><br><span class=\"line\">      - ./alertmanager/config.yml:/etc/alertmanager/alertmanager.yml</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">      - <span class=\"string\">&quot;9093:9093&quot;</span></span><br><span class=\"line\">    networks:</span><br><span class=\"line\">      - monitor-net</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"6-3-部署验证\"><a href=\"#6-3-部署验证\" class=\"headerlink\" title=\"6.3 部署验证\"></a>6.3 部署验证</h3><h4 id=\"6-3-1-重启服务\"><a href=\"#6-3-1-重启服务\" class=\"headerlink\" title=\"6.3.1 重启服务\"></a>6.3.1 重启服务</h4><p>由于修改了挂载卷配置，建议先删除旧容器再启动：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /opt/monitor</span><br><span class=\"line\">docker compose down</span><br><span class=\"line\">docker compose up -d</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-3-2-压力测试（验证告警）\"><a href=\"#6-3-2-压力测试（验证告警）\" class=\"headerlink\" title=\"6.3.2 压力测试（验证告警）\"></a>6.3.2 压力测试（验证告警）</h4><p>安装压力测试工具 stress，模拟 CPU 飙升场景</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 模拟 2 个核满载，持续 120 秒</span></span><br><span class=\"line\">stress -c 2 -t 120</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"6-3-3-观察流程\"><a href=\"#6-3-3-观察流程\" class=\"headerlink\" title=\"6.3.3 观察流程\"></a>6.3.3 观察流程</h4><ul>\n<li><strong>触发</strong>：Prometheus 界面 (Status -&gt; Alerts) 中，<code>HostCpuUsageTooHigh</code> 状态由 Green -&gt; Yellow (Pending) -&gt; Red (Firing)。</li>\n<li><strong>发送</strong>：Alertmanager 收到 Firing 信号，处理后投递邮件。</li>\n<li><strong>恢复</strong>：stress 结束后，收到标题带 [Resolved] 的恢复邮件。</li>\n</ul>\n<h3 id=\"6-4-常见问题排查\"><a href=\"#6-4-常见问题排查\" class=\"headerlink\" title=\"6.4 常见问题排查\"></a>6.4 常见问题排查</h3><ul>\n<li><strong>问题 1：</strong>Alertmanager 报错 connection refused 127.0.0.1:5001。<ul>\n<li>原因：配置文件挂载路径错误，导致容器读取了镜像自带的默认配置（默认配置是指向本地 webhook 的）。</li>\n<li>解决：确保 docker-compose 中挂载目标路径为 <code>/etc/alertmanager/alertmanager.yml</code>。</li>\n</ul>\n</li>\n<li><strong>问题 2：</strong>邮件发送失败 535 Authentication failed。<ul>\n<li>原因：使用了邮箱登录密码，而非 SMTP 专用授权码。</li>\n</ul>\n</li>\n<li><strong>问题 3：</strong>容器无法联网 i&#x2F;o timeout。<ul>\n<li>原因：Docker DNS 配置问题或云服务器安全组未放行。</li>\n</ul>\n</li>\n<li><strong>问题 4：</strong>cAdvisor 报错 mountpoint for cpu not found <ul>\n<li>原因：ubuntu 24.04 默认启用 <strong>Cgroup</strong> <strong>v2</strong>，而 docler hub 上的 cadvisor 旧版本只支持 <strong>Cgroup</strong> <strong>v1</strong></li>\n<li><strong>解决：</strong>通过更改 <strong>zcube&#x2F;cadvisor</strong> 镜像并配置 <strong>privileged</strong> 模式解决版本兼容性问题</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"7-基于-PLG-的轻量级日志分析\"><a href=\"#7-基于-PLG-的轻量级日志分析\" class=\"headerlink\" title=\"7. 基于 PLG 的轻量级日志分析\"></a>7. 基于 PLG 的轻量级日志分析</h2><blockquote>\n<p>为了解决“出现故障需要登录服务器一条条查 logs”的低效问题，引入 PLG 技术栈 (Promtail + Loki + Grafana)。</p>\n</blockquote>\n<ul>\n<li>优势：相比 ELK (Elasticsearch)，Loki 不建立全文索引，仅索引元数据（标签），内存占用极低，非常适合云服务器单机环境。</li>\n<li>流向：Promtail (自动发现容器) -&gt; 采集日志 -&gt; Loki (存储与索引) -&gt; Grafana (统一查询)。</li>\n</ul>\n<h3 id=\"7-1-配置文件编写\"><a href=\"#7-1-配置文件编写\" class=\"headerlink\" title=\"7.1 配置文件编写\"></a>7.1 配置文件编写</h3><p>首先创建日志组件的专用目录：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">mkdir</span> <span class=\"string\">-p</span> <span class=\"string\">/opt/monitor/loki</span></span><br><span class=\"line\"><span class=\"string\">mkdir</span> <span class=\"string\">-p</span> <span class=\"string\">/opt/monitor/promtail</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"7-1-1-配置-Loki-存储端-loki-config-yaml\"><a href=\"#7-1-1-配置-Loki-存储端-loki-config-yaml\" class=\"headerlink\" title=\"7.1.1 配置 Loki 存储端 (loki-config.yaml)\"></a>7.1.1 配置 Loki 存储端 (<code>loki-config.yaml</code>)</h4><p>创建<code>/opt/monitor/loki/loki-config.yaml</code>，定义日志如何存储。采用本地文件系统存储，简单高效。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">auth_enabled:</span> <span class=\"literal\">false</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">http_listen_port:</span> <span class=\"number\">3100</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">common:</span></span><br><span class=\"line\">  <span class=\"attr\">path_prefix:</span> <span class=\"string\">/loki</span></span><br><span class=\"line\">  <span class=\"attr\">storage:</span></span><br><span class=\"line\">    <span class=\"attr\">filesystem:</span></span><br><span class=\"line\">      <span class=\"attr\">chunks_directory:</span> <span class=\"string\">/loki/chunks</span></span><br><span class=\"line\">      <span class=\"attr\">rules_directory:</span> <span class=\"string\">/loki/rules</span></span><br><span class=\"line\">  <span class=\"attr\">replication_factor:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">ring:</span></span><br><span class=\"line\">    <span class=\"attr\">instance_addr:</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\">    <span class=\"attr\">kvstore:</span></span><br><span class=\"line\">      <span class=\"attr\">store:</span> <span class=\"string\">inmemory</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">schema_config:</span></span><br><span class=\"line\">  <span class=\"attr\">configs:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">from:</span> <span class=\"number\">2020-10-24</span></span><br><span class=\"line\">      <span class=\"attr\">store:</span> <span class=\"string\">tsdb</span></span><br><span class=\"line\">      <span class=\"attr\">object_store:</span> <span class=\"string\">filesystem</span></span><br><span class=\"line\">      <span class=\"attr\">schema:</span> <span class=\"string\">v13</span></span><br><span class=\"line\">      <span class=\"attr\">index:</span></span><br><span class=\"line\">        <span class=\"attr\">prefix:</span> <span class=\"string\">index_</span></span><br><span class=\"line\">        <span class=\"attr\">period:</span> <span class=\"string\">24h</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"7-1-2-配置-Promtail-采集端-promtail-config-yaml\"><a href=\"#7-1-2-配置-Promtail-采集端-promtail-config-yaml\" class=\"headerlink\" title=\"7.1.2 配置 Promtail 采集端 (promtail-config.yaml)\"></a>7.1.2 配置 Promtail 采集端 (<code>promtail-config.yaml</code>)</h4><p>创建 <code>/opt/monitor/promtail/promtail-config.yaml</code>。、</p>\n<blockquote>\n<p>核心逻辑：通过挂载 Docker Socket，自动发现当前运行的所有容器，并利用 relabel 机制将 Docker 内部名称格式化为易读的标签。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">server:</span></span><br><span class=\"line\">  <span class=\"attr\">http_listen_port:</span> <span class=\"number\">9080</span></span><br><span class=\"line\">  <span class=\"attr\">grpc_listen_port:</span> <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">positions:</span></span><br><span class=\"line\">  <span class=\"attr\">filename:</span> <span class=\"string\">/tmp/positions.yaml</span> <span class=\"comment\"># 记录采集游标，防止重启后日志重复或丢失</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">clients:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">http://loki:3100/loki/api/v1/push</span> <span class=\"comment\"># 推送给 Loki</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">scrape_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">system</span></span><br><span class=\"line\">    <span class=\"attr\">docker_sd_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">unix:///var/run/docker.sock</span> <span class=\"comment\"># 监听 Docker 事件</span></span><br><span class=\"line\">        <span class=\"attr\">refresh_interval:</span> <span class=\"string\">5s</span></span><br><span class=\"line\">    <span class=\"attr\">relabel_configs:</span></span><br><span class=\"line\">      <span class=\"comment\"># 只保留有名称的容器</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">source_labels:</span> [<span class=\"string\">&#x27;__meta_docker_container_name&#x27;</span>]</span><br><span class=\"line\">        <span class=\"attr\">regex:</span> <span class=\"string\">&#x27;/(.*)&#x27;</span></span><br><span class=\"line\">        <span class=\"attr\">target_label:</span> <span class=\"string\">&#x27;container&#x27;</span> <span class=\"comment\"># 重命名标签为 container，方便检索</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-2-服务编排更新-docker-compose-yml\"><a href=\"#7-2-服务编排更新-docker-compose-yml\" class=\"headerlink\" title=\"7.2 服务编排更新 (docker-compose.yml)\"></a>7.2 服务编排更新 (<code>docker-compose.yml</code>)</h3><p>编辑 <code>/opt/monitor/docker-compose.yml</code>，新增 Loki 和 Promtail 服务，并挂载必要的数据卷。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"comment\"># ... (之前的 Prometheus, Grafana, Alertmanager 等保持不变) ...</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 新增: 日志存储 Loki ---</span></span><br><span class=\"line\">  <span class=\"attr\">loki:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/loki:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">loki</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./loki/loki-config.yaml:/etc/loki/local-config.yaml</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">loki_data:/loki</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3100:3100&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\"># --- 新增: 日志采集 Promtail ---</span></span><br><span class=\"line\">  <span class=\"attr\">promtail:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">grafana/promtail:latest</span></span><br><span class=\"line\">    <span class=\"attr\">container_name:</span> <span class=\"string\">promtail</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">always</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">./promtail/promtail-config.yaml:/etc/promtail/config.yml</span></span><br><span class=\"line\">      <span class=\"comment\"># ⚠️ 关键挂载 1: 允许 Promtail 访问 Docker 守护进程以发现容器</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/run/docker.sock:/var/run/docker.sock</span></span><br><span class=\"line\">      <span class=\"comment\"># ⚠️ 关键挂载 2: 允许 Promtail 读取实际的日志文件 (只读模式)</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">/var/lib/docker/containers:/var/lib/docker/containers:ro</span></span><br><span class=\"line\">    <span class=\"attr\">networks:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">monitor-net</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus_data:</span></span><br><span class=\"line\">  <span class=\"attr\">grafana_data:</span></span><br><span class=\"line\">  <span class=\"attr\">loki_data:</span> <span class=\"comment\"># &lt;--- 别忘了新增这个卷用于持久化日志</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\">  <span class=\"attr\">monitor-net:</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"7-3-部署与-Grafana-配置\"><a href=\"#7-3-部署与-Grafana-配置\" class=\"headerlink\" title=\"7.3 部署与 Grafana 配置\"></a>7.3 部署与 Grafana 配置</h3><h4 id=\"7-3-1-重启服务\"><a href=\"#7-3-1-重启服务\" class=\"headerlink\" title=\"7.3.1 重启服务\"></a>7.3.1 重启服务</h4><figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cd</span> <span class=\"string\">/opt/monitor</span></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">compose</span> <span class=\"string\">up</span> <span class=\"string\">-d</span></span><br><span class=\"line\"><span class=\"comment\"># 检查 loki 和 promtail 状态是否为 Up</span></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">compose</span> <span class=\"string\">ps</span></span><br></pre></td></tr></table></figure>\n\n<h4 id=\"7-3-2-在-Grafana-接入数据源\"><a href=\"#7-3-2-在-Grafana-接入数据源\" class=\"headerlink\" title=\"7.3.2 在 Grafana 接入数据源\"></a>7.3.2 在 Grafana 接入数据源</h4><ul>\n<li>登录 Grafana -&gt; Connections -&gt; Data sources -&gt; Add new data source。</li>\n<li>选择 Loki。</li>\n<li>URL 填写：<a href=\"http://loki:3100。\">http://loki:3100。</a></li>\n<li>点击 Save &amp; Test，出现绿色提示 “Data source connected” 即成功。</li>\n</ul>\n<h3 id=\"7-4-如何进行日志排查\"><a href=\"#7-4-如何进行日志排查\" class=\"headerlink\" title=\"7.4 如何进行日志排查\"></a>7.4 如何进行日志排查</h3><ul>\n<li>进入 Grafana 左侧菜单 Explore (探索)。</li>\n<li>顶部数据源选择 Loki。</li>\n<li>Label filters 选择 container &#x3D; 你的应用容器名 (例如 cadvisor)。</li>\n<li>点击 Run query。</li>\n<li>效果：可以看到实时的应用日志流。配合 Live 按钮，可以像在终端使用 <code>tail -f</code> 一样监控线上日志。</li>\n</ul>\n<hr>\n<h2 id=\"8-简历上的项目描述\"><a href=\"#8-简历上的项目描述\" class=\"headerlink\" title=\"8. 简历上的项目描述\"></a>8. 简历上的项目描述</h2><p><strong>项目名称：基于 Docker 的云服务器监控平台</strong></p>\n<p><strong>项目描述：</strong><br>针对单体云服务器缺乏可视化监控、故障排查困难的问题，基于 Docker 搭建了一套标准化的监控告警系统。实现了从硬件层到应用容器层的全方位可观测性。</p>\n<p><strong>操作系统</strong>：Ubuntu 24.04</p>\n<p><strong>技术栈</strong>：Docker + Prometheus + Grafana + Alertmanager + cAdvisor + Loki + Promtail </p>\n<p><strong>核心技术：</strong></p>\n<ul>\n<li><strong>容器化基础设施</strong>：使用 <strong>Docker Compose</strong> 统一编排 <strong>Prometheus、Grafana、Loki</strong> 等 6 个服务组件，实现了“一键拉起”的标准化部署环境。</li>\n<li><strong>多维度监控</strong>：通过 <strong>Node Exporter</strong> 采集宿主机 CPU 使用率、磁盘 IO 等核心指标；引入 <strong>cAdvisor</strong> 解决了 Docker 容器资源隔离不可见的问题，实现了对单容器内存泄漏的实时监测。</li>\n<li><strong>可视化监控</strong>：基于 <strong>Grafana</strong> 自定义监控仪表盘，配置了 <strong>Prometheus 数据源</strong>，实现了服务器资源使用率的秒级刷新展示。</li>\n<li><strong>自动化告警</strong>：编写 PromQL 规则（如 CPU &gt; 90%），结合 <strong>Alertmanager <strong>实现了邮件实时告警，经</strong>压测</strong>验证，平均故障响应时间缩短至 2 分钟以内</li>\n<li><strong>日志聚合分析：</strong>引入**Promtail + Loki + Grafana **技术栈，实现 docker 容器日志的自动化采集和聚合，与传统 ELK 方案相比，资源占用更低</li>\n</ul>\n<hr>\n"},{"title":"我的第一篇博客","date":"2026-01-31T04:15:07.000Z","_content":"","source":"_posts/我的第一篇博客.md","raw":"---\ntitle: 我的第一篇博客\ndate: 2026-01-31 12:15:07\ntags:\n---\n","slug":"我的第一篇博客","published":1,"updated":"2026-01-31T12:15:07.692Z","comments":1,"layout":"post","photos":[],"_id":"cml85ywzf00049znxexzi5zn9","content":"","excerpt":"","more":""}],"PostAsset":[],"PostCategory":[{"post_id":"cml85ywze00039znxbo30cjhk","category_id":"cml85ywzh00059znxeka562g2","_id":"cml85ywzj00099znxf69q86c3"}],"PostTag":[{"post_id":"cml85ywz400009znx5zvh3tit","tag_id":"cml85ywzc00029znx3n97bn1j","_id":"cml85ywzj00089znxg8mj86kn"},{"post_id":"cml85ywz400009znx5zvh3tit","tag_id":"cml85ywzi00069znx7ypw5959","_id":"cml85ywzj000a9znxeq2n7ni3"},{"post_id":"cml85ywze00039znxbo30cjhk","tag_id":"cml85ywzj00079znx90m05dp2","_id":"cml85ywzk000c9znxes9de9aw"},{"post_id":"cml85ywze00039znxbo30cjhk","tag_id":"cml85ywzk000b9znx5edg0hrr","_id":"cml85ywzk000d9znx6lvw19wg"}],"Tag":[{"name":"Nginx","_id":"cml85ywzc00029znx3n97bn1j"},{"name":"Web服务器","_id":"cml85ywzi00069znx7ypw5959"},{"name":"教程","_id":"cml85ywzj00079znx90m05dp2"},{"name":"Docker","_id":"cml85ywzk000b9znx5edg0hrr"}]}}